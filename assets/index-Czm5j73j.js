const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ai-config-types-CoBQlKPX.js","assets/pixi-vendor-CLcXU_4U.js"])))=>i.map(i=>d[i]);
import{_ as de}from"./pixi-vendor-CLcXU_4U.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const n of a.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function t(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(s){if(s.ep)return;s.ep=!0;const a=t(s);fetch(s.href,a)}})();const G={snowflake:{type:"snowflake",colors:["#ffffff","#e6f3ff","#cce7ff","#b3d9ff","#f0f8ff"],behavior:{movement:"float",gravity:30,drag:.95,turbulence:.3},physics:{velocity:{min:20,max:60},acceleration:{x:0,y:30},mass:.5,elasticity:.1},visual:{size:{min:1,max:3},opacity:{start:.6,end:.1},scale:{start:.8,end:.2},rotation:{enabled:!0,speed:.02},glow:{enabled:!1,intensity:0}},animation:{lifespan:{min:800,max:1200},fadeIn:100,fadeOut:400,pulsing:{enabled:!1,frequency:0}},spawning:{count:{min:30,max:60},delay:{min:0,max:50},spread:{angle:Math.PI*.2,radius:40},burst:!1}},fire:{type:"fire",colors:["#dda0dd","#e6b8ea","#d8bfd8","#9932cc","#ba55d3"],behavior:{movement:"rise",gravity:-100,drag:.92,turbulence:.8},physics:{velocity:{min:80,max:200},acceleration:{x:0,y:-150},mass:.3,elasticity:0},visual:{size:{min:5,max:12},opacity:{start:.9,end:0},scale:{start:.5,end:1.6},rotation:{enabled:!1,speed:0},glow:{enabled:!0,intensity:1.2}},animation:{lifespan:{min:800,max:1500},fadeIn:50,fadeOut:600,pulsing:{enabled:!0,frequency:.1}},spawning:{count:{min:140,max:170},delay:{min:0,max:150},spread:{angle:Math.PI*.4,radius:40},burst:!0}},lightning:{type:"lightning",colors:["#ffff00","#ffffff","#00ffff","#87ceeb","#e0ffff"],behavior:{movement:"chain",gravity:0,drag:.99,turbulence:1.5},physics:{velocity:{min:300,max:600},acceleration:{x:0,y:0},mass:.1,elasticity:0},visual:{size:{min:8,max:16},opacity:{start:1,end:0},scale:{start:1,end:1},rotation:{enabled:!1,speed:0},glow:{enabled:!0,intensity:2}},animation:{lifespan:{min:100,max:300},fadeIn:0,fadeOut:150,pulsing:{enabled:!0,frequency:.5}},spawning:{count:{min:180,max:210},delay:{min:0,max:50},spread:{angle:Math.PI*2,radius:0},burst:!0}},blackhole:{type:"blackhole",colors:["#000000","#4b0082","#9400d3","#8b00ff","#1a1a1a"],behavior:{movement:"implode",gravity:800,drag:1.02,turbulence:.1},physics:{velocity:{min:100,max:300},acceleration:{x:0,y:0},mass:1,elasticity:0},visual:{size:{min:12,max:20},opacity:{start:.8,end:1},scale:{start:1.5,end:.1},rotation:{enabled:!0,speed:.15},glow:{enabled:!0,intensity:2.5}},animation:{lifespan:{min:1500,max:2500},fadeIn:100,fadeOut:500,pulsing:{enabled:!1,frequency:0}},spawning:{count:{min:220,max:300},delay:{min:0,max:300},spread:{angle:Math.PI*2,radius:120},burst:!1}},explosion:{type:"explosion",colors:["#87ceeb","#add8e6","#b0e0e6","#87cefa","#00bfff"],behavior:{movement:"explode",gravity:50,drag:.88,turbulence:.6},physics:{velocity:{min:150,max:300},acceleration:{x:0,y:100},mass:.8,elasticity:.3},visual:{size:{min:3,max:8},opacity:{start:.9,end:0},scale:{start:.3,end:1.2},rotation:{enabled:!0,speed:.1},glow:{enabled:!0,intensity:1}},animation:{lifespan:{min:500,max:1e3},fadeIn:20,fadeOut:300,pulsing:{enabled:!1,frequency:0}},spawning:{count:{min:110,max:130},delay:{min:0,max:30},spread:{angle:Math.PI*2,radius:0},burst:!0}},magic:{type:"magic",colors:["#90ee90","#98fb98","#b4ffb4","#7fff00","#adff2f"],behavior:{movement:"float",gravity:-20,drag:.98,turbulence:.4},physics:{velocity:{min:30,max:120},acceleration:{x:0,y:-50},mass:.2,elasticity:.8},visual:{size:{min:2,max:5},opacity:{start:.7,end:.1},scale:{start:.6,end:1},rotation:{enabled:!0,speed:.05},glow:{enabled:!0,intensity:.6}},animation:{lifespan:{min:1e3,max:1500},fadeIn:200,fadeOut:400,pulsing:{enabled:!0,frequency:.08}},spawning:{count:{min:70,max:100},delay:{min:0,max:100},spread:{angle:Math.PI*.4,radius:50},burst:!1}},storm:{type:"storm",colors:["#708090","#778899","#b0c4de","#87ceeb","#4682b4"],behavior:{movement:"spiral",gravity:20,drag:.96,turbulence:1.2},physics:{velocity:{min:150,max:350},acceleration:{x:0,y:50},mass:.6,elasticity:.2},visual:{size:{min:2,max:8},opacity:{start:.7,end:.2},scale:{start:1,end:.5},rotation:{enabled:!0,speed:.12},glow:{enabled:!1,intensity:0}},animation:{lifespan:{min:1200,max:2e3},fadeIn:150,fadeOut:500,pulsing:{enabled:!1,frequency:0}},spawning:{count:{min:60,max:120},delay:{min:0,max:100},spread:{angle:Math.PI*2,radius:100},burst:!1}},supernova:{type:"supernova",colors:["#ff8c00","#ffa500","#ff7f00","#ff6347","#ff4500"],behavior:{movement:"explode",gravity:-50,drag:.85,turbulence:1.8},physics:{velocity:{min:200,max:400},acceleration:{x:0,y:-100},mass:.4,elasticity:.1},visual:{size:{min:4,max:9},opacity:{start:1,end:0},scale:{start:.4,end:1.3},rotation:{enabled:!0,speed:.2},glow:{enabled:!0,intensity:2.2}},animation:{lifespan:{min:1e3,max:1800},fadeIn:50,fadeOut:800,pulsing:{enabled:!0,frequency:.15}},spawning:{count:{min:120,max:150},delay:{min:0,max:80},spread:{angle:Math.PI*2,radius:0},burst:!0}},cosmic_burst:{type:"cosmic_burst",colors:["#ffd700","#ffef94","#fff68f","#ffffe0","#fffacd"],behavior:{movement:"explode",gravity:-80,drag:.88,turbulence:2.5},physics:{velocity:{min:300,max:600},acceleration:{x:0,y:-200},mass:.2,elasticity:0},visual:{size:{min:5,max:10},opacity:{start:1,end:0},scale:{start:.2,end:1.4},rotation:{enabled:!0,speed:.25},glow:{enabled:!0,intensity:3}},animation:{lifespan:{min:1500,max:2800},fadeIn:100,fadeOut:1e3,pulsing:{enabled:!0,frequency:.2}},spawning:{count:{min:130,max:160},delay:{min:0,max:200},spread:{angle:Math.PI*2,radius:30},burst:!0}},green_lotus:{type:"green_lotus",colors:["#b4ffb4","#90ee90","#98fb98","#adff2f","#c8ffc8"],behavior:{movement:"float",gravity:-10,drag:.96,turbulence:.2},physics:{velocity:{min:40,max:80},acceleration:{x:0,y:-30},mass:.3,elasticity:.5},visual:{size:{min:2,max:4},opacity:{start:.8,end:.1},scale:{start:.6,end:1.2},rotation:{enabled:!0,speed:.03},glow:{enabled:!0,intensity:.8}},animation:{lifespan:{min:1e3,max:1500},fadeIn:200,fadeOut:500,pulsing:{enabled:!0,frequency:.05}},spawning:{count:{min:60,max:90},delay:{min:0,max:80},spread:{angle:Math.PI*.3,radius:40},burst:!1}},unlimited_blade_works:{type:"unlimited_blade_works",colors:["#c0c0c0","#d3d3d3","#dcdcdc","#e0e0e0","#f0f0f0"],behavior:{movement:"fall",gravity:800,drag:.99,turbulence:.1},physics:{velocity:{min:300,max:500},acceleration:{x:0,y:800},mass:.8,elasticity:0},visual:{size:{min:1,max:2},opacity:{start:.7,end:.2},scale:{start:.5,end:.7},rotation:{enabled:!1,speed:0},glow:{enabled:!0,intensity:.4}},animation:{lifespan:{min:800,max:1200},fadeIn:150,fadeOut:200,pulsing:{enabled:!1,frequency:0}},spawning:{count:{min:20,max:40},delay:{min:0,max:60},spread:{angle:Math.PI*.2,radius:30},burst:!1}},divine_thunder:{type:"divine_thunder",colors:["#c8a0ff","#b480ff","#dda0dd","#9932cc","#ba55d3"],behavior:{movement:"chain",gravity:0,drag:.98,turbulence:2},physics:{velocity:{min:400,max:800},acceleration:{x:0,y:0},mass:.1,elasticity:0},visual:{size:{min:6,max:12},opacity:{start:1,end:0},scale:{start:1,end:1.2},rotation:{enabled:!1,speed:0},glow:{enabled:!0,intensity:2.5}},animation:{lifespan:{min:1500,max:2e3},fadeIn:120,fadeOut:250,pulsing:{enabled:!0,frequency:.3}},spawning:{count:{min:120,max:160},delay:{min:0,max:100},spread:{angle:Math.PI*2,radius:80},burst:!0}},nine_finale:{type:"nine_finale",colors:["#ff8c40","#ff5028","#ffb870","#ff6030","#ffa060"],behavior:{movement:"explode",gravity:.8,drag:.95,turbulence:1.5},physics:{velocity:{min:600,max:1e3},acceleration:{x:0,y:500},mass:.3,elasticity:.1},visual:{size:{min:8,max:16},opacity:{start:1,end:0},scale:{start:.8,end:1.4},rotation:{enabled:!0,speed:2},glow:{enabled:!0,intensity:3}},animation:{lifespan:{min:1600,max:2200},fadeIn:100,fadeOut:300,pulsing:{enabled:!0,frequency:.5}},spawning:{count:{min:180,max:210},delay:{min:0,max:120},spread:{angle:Math.PI*2,radius:100},burst:!0}}};function me(h){switch(h){case"SSS":return"cosmic_burst";case"SS":return"nine_finale";case"S":return"divine_thunder";case"A":return"explosion";case"B":return"green_lotus";case"C":return"unlimited_blade_works";default:return"snowflake"}}function L(h,e,t=.5){const i=G[h],s=G[e];return{type:h,colors:[...i.colors,...s.colors],behavior:{movement:t>.5?i.behavior.movement:s.behavior.movement,gravity:i.behavior.gravity*t+s.behavior.gravity*(1-t),drag:i.behavior.drag*t+s.behavior.drag*(1-t),turbulence:i.behavior.turbulence*t+s.behavior.turbulence*(1-t)},physics:{velocity:{min:Math.min(i.physics.velocity.min,s.physics.velocity.min),max:Math.max(i.physics.velocity.max,s.physics.velocity.max)},acceleration:{x:i.physics.acceleration.x*t+s.physics.acceleration.x*(1-t),y:i.physics.acceleration.y*t+s.physics.acceleration.y*(1-t)},mass:i.physics.mass*t+s.physics.mass*(1-t),elasticity:i.physics.elasticity*t+s.physics.elasticity*(1-t)},visual:{size:{min:Math.min(i.visual.size.min,s.visual.size.min),max:Math.max(i.visual.size.max,s.visual.size.max)},opacity:{start:Math.max(i.visual.opacity.start,s.visual.opacity.start),end:Math.min(i.visual.opacity.end,s.visual.opacity.end)},scale:{start:i.visual.scale.start*t+s.visual.scale.start*(1-t),end:i.visual.scale.end*t+s.visual.scale.end*(1-t)},rotation:{enabled:i.visual.rotation.enabled||s.visual.rotation.enabled,speed:i.visual.rotation.speed*t+s.visual.rotation.speed*(1-t)},glow:{enabled:i.visual.glow.enabled||s.visual.glow.enabled,intensity:Math.max(i.visual.glow.intensity,s.visual.glow.intensity)}},animation:{lifespan:{min:Math.min(i.animation.lifespan.min,s.animation.lifespan.min),max:Math.max(i.animation.lifespan.max,s.animation.lifespan.max)},fadeIn:Math.max(i.animation.fadeIn,s.animation.fadeIn),fadeOut:Math.max(i.animation.fadeOut,s.animation.fadeOut),pulsing:{enabled:i.animation.pulsing.enabled||s.animation.pulsing.enabled,frequency:i.animation.pulsing.frequency*t+s.animation.pulsing.frequency*(1-t)}},spawning:{count:{min:Math.max(i.spawning.count.min,s.spawning.count.min),max:Math.max(i.spawning.count.max,s.spawning.count.max)},delay:{min:Math.min(i.spawning.delay.min,s.spawning.delay.min),max:Math.max(i.spawning.delay.max,s.spawning.delay.max)},spread:{angle:Math.max(i.spawning.spread.angle,s.spawning.spread.angle),radius:Math.max(i.spawning.spread.radius,s.spawning.spread.radius)},burst:i.spawning.burst||s.spawning.burst}}}class ue{x;y;angle;scale;life;maxLife;velocity;rotation;acceleration;dead=!1;time=0;constructor(e){this.x=e.x,this.y=e.y,this.angle=e.angle,this.scale=e.scale,this.life=e.life,this.maxLife=e.life,this.velocity=e.velocity,this.rotation=e.rotation,this.acceleration=e.acceleration}update(e){if(this.time+=e,this.time>this.life){this.dead=!0;return}this.x+=Math.cos(this.angle)*this.velocity*e,this.y+=Math.sin(this.angle)*this.velocity*e,this.acceleration+=this.rotation*e}draw(e){const t=1-this.time/this.life;e.save(),e.globalAlpha=t*.9,e.translate(this.x,this.y),e.rotate(this.acceleration),e.scale(this.scale,this.scale),this.drawPetal(e),e.restore()}drawPetal(e){const t=e.createLinearGradient(0,0,80,55);t.addColorStop(0,"rgba(180,255,220,0.9)"),t.addColorStop(1,"rgba(120,220,180,0.1)"),e.fillStyle=t,e.beginPath(),e.moveTo(12,25),e.bezierCurveTo(32,8,58,12,65,25),e.bezierCurveTo(58,38,32,42,12,25),e.closePath(),e.fill()}}class Z{x;y;angle;dead=!1;time=0;maxTime=.5;speed=600;constructor(e){this.x=e.x,this.y=e.y,this.angle=e.angle}update(e){if(this.time+=e,this.time>this.maxTime){this.dead=!0;return}this.x+=Math.cos(this.angle)*this.speed*e,this.y+=Math.sin(this.angle)*this.speed*e}draw(e){e.save(),e.translate(this.x,this.y),e.rotate(this.angle),this.drawBeam(e),e.restore()}drawBeam(e){const t=e.createLinearGradient(0,0,160,0);t.addColorStop(0,"rgba(200,255,230,0)"),t.addColorStop(.3,"rgba(200,255,230,0.8)"),t.addColorStop(.8,"rgba(200,255,230,0.8)"),t.addColorStop(1,"rgba(200,255,230,0)"),e.fillStyle=t,e.fillRect(-80,-6,160,12)}}class fe{x;y;dead=!1;time=0;phase=0;petals=[];swords=[];targetPositions;constructor(e,t,i=[]){this.x=e,this.y=t,this.targetPositions=i}update(e){switch(this.time+=e,this.phase){case 0:this.time>.5&&(this.createPetals(),this.phase=1,this.time=0);break;case 1:this.time>.4&&(this.createSwordBeams(),this.phase=2,this.time=0);break;case 2:this.time>1.5&&(this.dead=!0);break}this.petals.forEach(t=>t.update(e)),this.petals=this.petals.filter(t=>!t.dead),this.swords.forEach(t=>t.update(e)),this.swords=this.swords.filter(t=>!t.dead)}draw(e){this.drawAura(e),this.phase===0&&this.drawLotusFlower(e),this.petals.forEach(t=>t.draw(e)),this.swords.forEach(t=>t.draw(e))}drawAura(e){let t=1;this.phase===0?t=Math.min(1,this.time/.5):this.phase===2&&(t=Math.max(0,1-this.time/1.5)),e.save(),e.globalAlpha=t;const i=e.createRadialGradient(this.x,this.y,0,this.x,this.y,130);i.addColorStop(0,"rgba(180,255,220,0.8)"),i.addColorStop(1,"rgba(180,255,220,0)"),e.fillStyle=i,e.beginPath(),e.arc(this.x,this.y,130,0,Math.PI*2),e.fill(),e.restore()}drawLotusFlower(e){for(let i=0;i<8;i++){const s=i*Math.PI*2/8+this.time*1.5;e.save(),e.translate(this.x,this.y),e.rotate(s);const a=e.createLinearGradient(0,0,80,55);a.addColorStop(0,"rgba(180,255,220,0.9)"),a.addColorStop(1,"rgba(120,220,180,0.1)"),e.fillStyle=a,e.beginPath(),e.moveTo(12,25),e.bezierCurveTo(32,8,58,12,65,25),e.bezierCurveTo(58,38,32,42,12,25),e.closePath(),e.fill(),e.restore()}}createPetals(){for(let e=0;e<12;e++){const t=e*Math.PI*2/12;this.petals.push(new ue({x:this.x,y:this.y,angle:t,scale:.8+Math.random()*.5,life:1+Math.random()*.5,velocity:40+Math.random()*40,rotation:-2+Math.random()*4,acceleration:-.5+Math.random()}))}}createSwordBeams(){if(this.targetPositions.length>0)this.targetPositions.forEach(e=>{const t=Math.atan2(e.y-this.y,e.x-this.x),i=-.1+Math.random()*.2;this.swords.push(new Z({x:this.x,y:this.y,angle:t+i,targetPosition:e}))});else for(let e=0;e<12;e++){const t=e*Math.PI*2/12+(-.1+Math.random()*.2);this.swords.push(new Z({x:this.x,y:this.y,angle:t}))}}}class ge{x;y;time=0;constructor(e,t){this.x=e,this.y=t}update(e){this.time+=e}draw(e,t){const s=Math.min(window.innerWidth,window.innerHeight)*.14,a=this.time*.3;e.save(),e.translate(this.x,this.y-window.innerHeight*.02),e.globalAlpha=t*.5,this.drawSimplifiedRing(e,s,a),this.drawSimplifiedBalance(e,s,this.time),e.restore()}drawSimplifiedRing(e,t,i){e.save(),e.rotate(-i*.5);const s=e.createRadialGradient(0,0,t*.65,0,0,t);s.addColorStop(0,"rgba(240,240,240,0.8)"),s.addColorStop(.3,"rgba(200,200,200,0.9)"),s.addColorStop(.7,"rgba(160,160,160,0.8)"),s.addColorStop(1,"rgba(100,100,100,0.6)"),e.fillStyle=s,e.beginPath(),e.arc(0,0,t,0,Math.PI*2),e.arc(0,0,t*.65,0,Math.PI*2,!0),e.closePath(),e.fill();const a=e.createRadialGradient(0,0,t*.55,0,0,t*.75);a.addColorStop(0,"rgba(220,220,220,0.7)"),a.addColorStop(1,"rgba(140,140,140,0.5)"),e.fillStyle=a,e.beginPath(),e.arc(0,0,t*.75,0,Math.PI*2),e.arc(0,0,t*.55,0,Math.PI*2,!0),e.closePath(),e.fill(),e.strokeStyle="rgba(255,255,255,0.8)",e.lineWidth=4;for(let n=0;n<24;n++){const o=n*Math.PI*2/24;e.beginPath(),e.moveTo(Math.cos(o)*t*.65,Math.sin(o)*t*.65),e.lineTo(Math.cos(o)*t*.98,Math.sin(o)*t*.98),e.stroke(),e.lineWidth=6,e.strokeStyle="rgba(255,255,255,0.9)",e.beginPath(),e.moveTo(Math.cos(o)*t*.92,Math.sin(o)*t*.92),e.lineTo(Math.cos(o)*t*.98,Math.sin(o)*t*.98),e.stroke(),e.lineWidth=4,e.strokeStyle="rgba(255,255,255,0.8)"}e.strokeStyle="rgba(220,220,220,0.7)",e.lineWidth=2;for(let n=0;n<48;n++){const o=n*Math.PI*2/48;e.beginPath(),e.moveTo(Math.cos(o)*t*.55,Math.sin(o)*t*.55),e.lineTo(Math.cos(o)*t*.72,Math.sin(o)*t*.72),e.stroke(),n%8===0&&(e.lineWidth=3,e.strokeStyle="rgba(240,240,240,0.8)",e.beginPath(),e.moveTo(Math.cos(o)*t*.52,Math.sin(o)*t*.52),e.lineTo(Math.cos(o)*t*.75,Math.sin(o)*t*.75),e.stroke(),e.lineWidth=2,e.strokeStyle="rgba(220,220,220,0.7)")}for(let n=0;n<3;n++){const o=t*(.45-n*.08),r=36-n*8;e.strokeStyle=`rgba(200,200,200,${.6-n*.1})`,e.lineWidth=2-n*.3;for(let l=0;l<r;l++){const c=l*Math.PI*2/r;e.beginPath(),e.moveTo(Math.cos(c)*o*.85,Math.sin(c)*o*.85),e.lineTo(Math.cos(c)*o*1.1,Math.sin(c)*o*1.1),e.stroke()}}e.restore()}drawSimplifiedBalance(e,t,i){e.save(),e.rotate(Math.sin(i*4)*.2);const s=e.createRadialGradient(0,0,t*.12,0,0,t*.32);s.addColorStop(0,"rgba(255,255,255,0.9)"),s.addColorStop(.3,"rgba(240,240,240,0.8)"),s.addColorStop(.7,"rgba(180,180,180,0.7)"),s.addColorStop(1,"rgba(120,120,120,0.5)"),e.fillStyle=s,e.beginPath(),e.arc(0,0,t*.32,0,Math.PI*2),e.arc(0,0,t*.12,0,Math.PI*2,!0),e.closePath(),e.fill();const a=e.createRadialGradient(0,0,t*.08,0,0,t*.18);a.addColorStop(0,"rgba(255,255,255,1.0)"),a.addColorStop(.5,"rgba(200,200,200,0.9)"),a.addColorStop(1,"rgba(150,150,150,0.7)"),e.fillStyle=a,e.beginPath(),e.arc(0,0,t*.18,0,Math.PI*2),e.arc(0,0,t*.08,0,Math.PI*2,!0),e.closePath(),e.fill(),e.strokeStyle="rgba(255,255,255,0.8)",e.lineWidth=2;for(let o=0;o<12;o++){const r=o*Math.PI*2/12;e.beginPath(),e.moveTo(Math.cos(r)*t*.08,Math.sin(r)*t*.08),e.lineTo(Math.cos(r)*t*.3,Math.sin(r)*t*.3),e.stroke(),o%3===0&&(e.lineWidth=3,e.strokeStyle="rgba(255,255,255,0.95)",e.beginPath(),e.moveTo(Math.cos(r)*t*.08,Math.sin(r)*t*.08),e.lineTo(Math.cos(r)*t*.32,Math.sin(r)*t*.32),e.stroke(),e.lineWidth=2,e.strokeStyle="rgba(255,255,255,0.8)")}for(let o=0;o<4;o++){const r=o*Math.PI*2/4,l=Math.cos(r)*t*.28,c=Math.sin(r)*t*.28;e.fillStyle="rgba(255,255,255,0.9)",e.beginPath(),e.arc(l,c,t*.03,0,Math.PI*2),e.fill(),e.strokeStyle="rgba(200,200,200,0.8)",e.lineWidth=1,e.stroke()}const n=e.createRadialGradient(0,0,0,0,0,t*.05);n.addColorStop(0,"rgba(255,255,255,1.0)"),n.addColorStop(.7,"rgba(220,220,220,0.9)"),n.addColorStop(1,"rgba(180,180,180,0.7)"),e.fillStyle=n,e.beginPath(),e.arc(0,0,t*.05,0,Math.PI*2),e.fill(),e.fillStyle="rgba(255,255,255,0.8)",e.beginPath(),e.arc(-t*.01,-t*.01,t*.02,0,Math.PI*2),e.fill(),e.restore()}}class pe{x;y;dead=!1;time=0;duration=2;tourbillon;constructor(e,t,i=[]){this.x=e,this.y=t,this.tourbillon=new ge(e,t)}update(e){if(this.time+=e,this.time>this.duration){this.dead=!0;return}this.tourbillon.update(e)}draw(e){if(this.dead)return;let t=1;this.time<.3?t=this.time/.3:this.time>this.duration-.4&&(t=(this.duration-this.time)/.4),this.tourbillon.draw(e,t)}}const W={bolt:"rgba(180,140,255,0.95)",haze:"rgba(160,120,255,0.25)",spark:"rgba(220,200,255,0.9)",ring:"rgba(210,190,255,0.65)",blade:"rgba(190,160,255,0.9)"};class ve{x;y;vx;vy;time=0;life;dead=!1;constructor(e){this.x=e.x,this.y=e.y,this.vx=e.vx,this.vy=e.vy,this.life=e.life}update(e){if(this.time+=e,this.time>this.life){this.dead=!0;return}this.vy+=900*e,this.x+=this.vx*e,this.y+=this.vy*e}draw(e,t){if(this.dead)return;const i=1-this.time/this.life;e.save(),e.globalCompositeOperation="lighter",e.globalAlpha=t*i,e.strokeStyle=W.spark,e.lineWidth=2,e.beginPath(),e.moveTo(this.x-2,this.y),e.lineTo(this.x+2,this.y),e.moveTo(this.x,this.y-2),e.lineTo(this.x,this.y+2),e.stroke(),e.restore()}}class ye{x;y;time=0;duration=1;dead=!1;maxRadius=180;constructor(e,t){this.x=e,this.y=t}update(e){this.time+=e*2.2,this.time>=this.duration*1.1&&(this.dead=!0)}draw(e,t){if(this.dead||this.time<=0)return;const i=Math.min(1,this.time/this.duration),s=20+i*this.maxRadius;e.save(),e.globalCompositeOperation="lighter",e.globalAlpha=t*(1-i),e.strokeStyle=W.ring,e.lineWidth=3+6*(1-i),e.beginPath(),e.arc(this.x,this.y,s,0,Math.PI*2),e.stroke(),e.restore()}}class ee{static generateBolt(e,t,i=5,s=48,a=.35){const n=[{x:e.x,y:e.y},{x:t.x,y:t.y}];for(let r=0;r<i;r++){for(let l=n.length-1;l>0;l--){const c=n[l-1],d=n[l];if(!c||!d)continue;const u=(c.x+d.x)/2,p=(c.y+d.y)/2,v=d.x-c.x,S=d.y-c.y,w=Math.hypot(v,S)||1,b=-S/w,A=v/w,T=(Math.random()*2-1)*s;n.splice(l,0,{x:u+b*T,y:p+A*T})}s*=.55}const o=[];for(let r=2;r<n.length-2;r++)if(Math.random()<a){const l=n[r],c=n[r+1];if(!l||!c)continue;const d=c.x-l.x,u=c.y-l.y,p=Math.hypot(d,u)||1,v={x:l.x+d/p*(40+Math.random()*50),y:l.y+u/p*(40+Math.random()*50)};o.push(this.generateBolt(l,v,3,s*.6,.15))}return{points:n,branches:o}}static drawBolt(e,t,i=3){e.save(),e.globalCompositeOperation="lighter",e.lineJoin="round",e.lineCap="round",e.strokeStyle=W.haze,e.lineWidth=i*4,this.pathBolt(e,t),e.stroke(),e.strokeStyle=W.bolt,e.lineWidth=i,this.pathBolt(e,t),e.stroke(),e.strokeStyle="rgba(255,255,255,0.9)",e.lineWidth=Math.max(1,i*.5),this.pathBolt(e,t),e.stroke();for(const s of t.branches)this.drawBolt(e,s,i*.7);e.restore()}static pathBolt(e,t){const i=t.points;if(i.length<2)return;e.beginPath();const s=i[0];s&&e.moveTo(s.x,s.y);for(let a=1;a<i.length;a++){const n=i[a];n&&e.lineTo(n.x,n.y)}}}class te{x;y;targetY;currentY;width=14;arrived=!1;alpha=1;constructor(e,t){this.x=e,this.targetY=t,this.y=t,this.currentY=-160}update(e){this.currentY+=(this.targetY-this.currentY)*Math.min(1,e*16),Math.abs(this.currentY-this.targetY)<6&&(this.arrived=!0)}draw(e,t){const i=t*this.alpha,s=Math.min(this.currentY,this.targetY-window.innerHeight*.35),a=this.targetY+10;e.save(),e.globalCompositeOperation="lighter",e.globalAlpha=i*.6;const n=e.createLinearGradient(this.x,s,this.x,a);if(n.addColorStop(0,"rgba(170,120,255,0)"),n.addColorStop(.1,"rgba(170,120,255,0.25)"),n.addColorStop(.9,"rgba(170,120,255,0.25)"),n.addColorStop(1,"rgba(170,120,255,0)"),e.fillStyle=n,e.fillRect(this.x-28,s,56,a-s),e.globalAlpha=i,e.fillStyle=W.blade,e.fillRect(this.x-this.width/2,s,this.width,a-s),e.globalAlpha=i,e.fillStyle="rgba(255,255,255,0.95)",e.fillRect(this.x-1,s+6,2,a-s-12),this.arrived){e.globalAlpha=i;const o=e.createRadialGradient(this.x,a-6,0,this.x,a-6,22);o.addColorStop(0,"rgba(255,255,255,1)"),o.addColorStop(1,"rgba(255,255,255,0)"),e.fillStyle=o,e.beginPath(),e.arc(this.x,a-6,22,0,Math.PI*2),e.fill()}e.restore()}}class be{x;y;dead=!1;time=0;duration=2;targetPositions;thunderBlades=[];lightningBolts=[];sparks=[];shockwaves=[];screenShake=0;thunderStarted=!1;constructor(e,t,i=[]){this.x=e,this.y=t,this.targetPositions=i,this.initializeBlades()}initializeBlades(){this.targetPositions.length>0?this.targetPositions.forEach(e=>{this.thunderBlades.push(new te(e.x,e.y))}):this.thunderBlades.push(new te(this.x,this.y))}update(e){if(this.time+=e,this.time>this.duration){this.dead=!0;return}let t=!1;this.thunderBlades.forEach(i=>{i.update(e),i.arrived&&(t=!0)}),t&&!this.thunderStarted&&(this.startThunderEffect(),this.thunderStarted=!0),this.thunderStarted&&this.generateLightning(),this.screenShake>0&&(this.screenShake=Math.max(0,this.screenShake-e*24)),this.sparks.forEach(i=>i.update(e)),this.sparks=this.sparks.filter(i=>!i.dead),this.shockwaves.forEach(i=>i.update(e)),this.shockwaves=this.shockwaves.filter(i=>!i.dead),this.lightningBolts.length>12&&this.lightningBolts.splice(0,this.lightningBolts.length-12)}startThunderEffect(){this.screenShake=6,this.thunderBlades.forEach(e=>{this.spawnSparks(e.x,e.y,20),this.shockwaves.push(new ye(e.x,e.y))})}generateLightning(){const e=2+(Math.random()<.5?1:2);for(let t=0;t<e;t++){const i=this.thunderBlades[Math.floor(Math.random()*this.thunderBlades.length)];if(!i)continue;const s=i.x+(Math.random()-.5)*window.innerWidth*.5,a=-80+Math.random()*window.innerHeight*.1,n=ee.generateBolt({x:s,y:a},{x:i.x,y:i.y},5,32+Math.random()*32,.35);this.lightningBolts.push(n)}}spawnSparks(e,t,i){for(let s=0;s<i;s++)this.sparks.push(new ve({x:e,y:t,vx:-220+Math.random()*440,vy:-180+Math.random()*160,life:.15+Math.random()*.2}))}draw(e){if(this.dead)return;let t=1;const i=.12,s=.25;if(this.time<i?t=this.time/i:this.time>this.duration-s&&(t=(this.duration-this.time)/s),e.save(),this.screenShake>0){const a=(Math.random()-.5)*this.screenShake,n=(Math.random()-.5)*this.screenShake;e.translate(a,n)}this.thunderBlades.forEach(a=>a.draw(e,t)),this.lightningBolts.forEach(a=>{ee.drawBolt(e,a,2.6)}),this.shockwaves.forEach(a=>a.draw(e,t)),this.sparks.forEach(a=>a.draw(e,t)),e.restore()}}class Me{x;y;targetPositions;meteors=[];sparks=[];rings=[];targetIndicators=[];duration=1.8;currentTime=0;isComplete=!1;screenShake=0;meteorHead;constructor(e,t,i=[]){this.x=e,this.y=t,this.targetPositions=i.length>0?i:[{x:e,y:t}],this.meteorHead=this.createMeteorSprite(),this.initializeTargetIndicators(),this.initializeMeteors()}initializeTargetIndicators(){for(const e of this.targetPositions)this.targetIndicators.push({x:e.x,y:e.y,life:.6,maxLife:.6})}createMeteorSprite(){const e=document.createElement("canvas");e.width=96,e.height=96;const t=e.getContext("2d"),i=t.createRadialGradient(48,48,0,48,48,42);return i.addColorStop(0,"rgba(255,240,210,1)"),i.addColorStop(.35,"rgba(255,180,140,1)"),i.addColorStop(1,"rgba(255,80,40,0.55)"),t.fillStyle=i,t.beginPath(),t.arc(48,48,42,0,Math.PI*2),t.fill(),e}initializeMeteors(){for(let e=0;e<this.targetPositions.length;e++){const t=this.targetPositions[e];if(!t)continue;const i=Math.random()<.3?2:Math.random()<.7?3:4;for(let s=0;s<i;s++){const a=Math.random()*Math.PI*2,n=400+Math.random()*300,o=t.x+Math.cos(a)*n,r=t.y+Math.sin(a)*n-200,l=t.x-o,c=t.y-r,d=Math.sqrt(l*l+c*c)||1,u=250+Math.random()*150,p=800+Math.random()*200,v=u*.3,S=c/d*p-v;this.meteors.push({x:o,y:r,vx:l/d*p,vy:S,rotation:Math.atan2(c,l),gravity:u,life:1.8,currentLife:0,trail:[],scale:1.2+Math.random()*.6,targetX:t.x,targetY:t.y,assignedTarget:t})}}}spawnExplosion(e,t){const i=40+Math.random()*20;for(let s=0;s<i;s++)this.sparks.push({x:e,y:t,vx:(Math.random()-.5)*2200,vy:(Math.random()-.5)*1800-200,life:.18+Math.random()*.17,currentLife:0});this.rings.push({x:e,y:t,radius:0,maxRadius:280,life:.45,currentLife:0}),this.screenShake=Math.min(15,this.screenShake+6.5)}update(e){if(this.currentTime+=e,this.currentTime>=this.duration){this.isComplete=!0;return}this.screenShake=Math.max(0,this.screenShake-e*18),this.updateMeteors(e),this.updateSparks(e),this.updateRings(e),this.updateTargetIndicators(e)}updateMeteors(e){for(let t=this.meteors.length-1;t>=0;t--){const i=this.meteors[t];if(!i)continue;if(i.currentLife+=e,i.vy+=i.gravity*e,Math.sqrt((i.targetX-i.x)**2+(i.targetY-i.y)**2)>20&&i.currentLife<i.life*.8){const o=i.targetX-i.x,r=i.targetY-i.y,l=Math.sqrt(o*o+r*r)||1,c=o/l*600,d=r/l*600;i.vx=i.vx*(1-.1)+c*.1,i.vy=i.vy*(1-.1)+d*.1,i.rotation=Math.atan2(i.vy,i.vx)}i.x+=i.vx*e,i.y+=i.vy*e,i.trail.push({x:i.x,y:i.y}),i.trail.length>10&&i.trail.shift(),(Math.sqrt((i.x-i.assignedTarget.x)**2+(i.y-i.assignedTarget.y)**2)<20||i.currentLife>i.life)&&(this.spawnExplosion(i.x,i.y),this.meteors.splice(t,1))}}updateSparks(e){for(let t=this.sparks.length-1;t>=0;t--){const i=this.sparks[t];if(i){if(i.currentLife+=e,i.currentLife>i.life){this.sparks.splice(t,1);continue}i.vy+=1400*e,i.x+=i.vx*e,i.y+=i.vy*e}}}updateRings(e){for(let t=this.rings.length-1;t>=0;t--){const i=this.rings[t];if(i){if(i.currentLife+=e*2.2,i.currentLife>=i.life){this.rings.splice(t,1);continue}i.radius=24+i.currentLife/i.life*i.maxRadius}}}updateTargetIndicators(e){for(let t=this.targetIndicators.length-1;t>=0;t--){const i=this.targetIndicators[t];i&&(i.life-=e,i.life<=0&&this.targetIndicators.splice(t,1))}}render(e){if(this.isComplete)return;const t=this.currentTime/this.duration,i=Math.min(1,t/.12),s=Math.min(1,(this.duration-this.currentTime)/.25),a=Math.min(i,s);if(e.save(),this.screenShake>0){const n=(Math.random()-.5)*this.screenShake*2,o=(Math.random()-.5)*this.screenShake*2;e.translate(n,o)}this.renderTargetIndicators(e,a),this.renderMeteors(e,a),this.renderRings(e,a),this.renderSparks(e,a),e.restore()}renderMeteors(e,t){e.save(),e.globalCompositeOperation="lighter";for(const i of this.meteors)this.renderMeteorTrail(e,i,t),this.renderMeteorHead(e,i,t);e.restore()}renderMeteorTrail(e,t,i){if(!(t.trail.length<2))for(let s=0;s<t.trail.length-1;s++){const a=t.trail[s],n=t.trail[s+1];if(!a||!n)continue;const o=s/(t.trail.length-1),r=35*(1-o);e.globalAlpha=i*.35*(1-o),e.strokeStyle="rgba(255,90,50,0.35)",e.lineWidth=r,e.lineCap="round",e.beginPath(),e.moveTo(a.x,a.y),e.lineTo(n.x,n.y),e.stroke()}}renderMeteorHead(e,t,i){e.save(),e.globalAlpha=i,e.translate(t.x,t.y),e.rotate(t.rotation),e.scale(t.scale,t.scale),e.drawImage(this.meteorHead,-48,-48,96,96),e.restore()}renderSparks(e,t){e.save(),e.globalCompositeOperation="lighter";for(const i of this.sparks){const s=1-i.currentLife/i.life;e.globalAlpha=t*s,e.strokeStyle="rgba(255,210,160,0.95)",e.lineWidth=2,e.beginPath(),e.moveTo(i.x-2,i.y),e.lineTo(i.x+2,i.y),e.moveTo(i.x,i.y-2),e.lineTo(i.x,i.y+2),e.stroke()}e.restore()}renderRings(e,t){e.save(),e.globalCompositeOperation="lighter";for(const i of this.rings){const s=1-i.currentLife/i.life;e.globalAlpha=t*s,e.strokeStyle="rgba(255,140,90,0.7)",e.lineWidth=3+7*s,e.beginPath(),e.arc(i.x,i.y,i.radius,0,Math.PI*2),e.stroke()}e.restore()}getScreenShake(){return this.screenShake}renderTargetIndicators(e,t){e.save(),e.globalCompositeOperation="lighter";for(const i of this.targetIndicators){const s=i.life/i.maxLife,a=.5+.5*Math.sin(this.currentTime*15);e.globalAlpha=t*s*a,e.strokeStyle="rgba(255,100,50,0.8)",e.lineWidth=2;const n=15+(1-s)*10;e.beginPath(),e.moveTo(i.x-n,i.y),e.lineTo(i.x+n,i.y),e.moveTo(i.x,i.y-n),e.lineTo(i.x,i.y+n),e.stroke(),e.beginPath(),e.arc(i.x,i.y,n*.7,0,Math.PI*2),e.stroke()}e.restore()}isFinished(){return this.isComplete}}class Se{x;y;targetPositions;iceSpears=[];iceShards=[];shockRings=[];duration=1.5;currentTime=0;isComplete=!1;screenShake=0;frostCoreTime=0;iceSpearSprite;dead=!1;constructor(e,t,i=[]){this.x=e,this.y=t,this.targetPositions=i.length>0?i:[{x:e,y:t}],this.iceSpearSprite=this.createIceSpearSprite(),this.initializeIceSpears()}createIceSpearSprite(){const e=document.createElement("canvas");e.width=26,e.height=140;const t=e.getContext("2d"),i=t.createLinearGradient(0,0,0,140);return i.addColorStop(0,"rgba(190,230,255,0.00)"),i.addColorStop(.1,"rgba(190,230,255,0.20)"),i.addColorStop(.9,"rgba(190,230,255,0.20)"),i.addColorStop(1,"rgba(190,230,255,0.00)"),t.fillStyle=i,t.fillRect(0,0,26,140),t.fillStyle="rgba(190,230,255,0.95)",t.beginPath(),t.moveTo(13,0),t.lineTo(20,100),t.lineTo(13,140),t.lineTo(6,100),t.closePath(),t.fill(),t.fillStyle="rgba(255,255,255,0.95)",t.fillRect(12,12,2,112),e}initializeIceSpears(){for(const e of this.targetPositions){const t=Math.random()<.4?2:3;for(let i=0;i<t;i++){const s=Math.random()*Math.PI*2,a=350+Math.random()*200,n=e.x+Math.cos(s)*a,o=e.y+Math.sin(s)*a-150,r=e.x-n,l=e.y-o,c=Math.sqrt(r*r+l*l)||1,d=900+Math.random()*400;this.iceSpears.push({x:n,y:o,vx:r/c*d,vy:l/c*d,rotation:Math.atan2(l,r)+Math.PI/2,life:.45+Math.random()*.45,currentLife:0,trail:[],scale:.8+Math.random()*.4,targetX:e.x,targetY:e.y})}}}spawnIceShards(e,t,i=22){for(let s=0;s<i;s++){const a=Math.random()*Math.PI*2,n=300+Math.random()*600;this.iceShards.push({x:e,y:t,vx:Math.cos(a)*n,vy:Math.sin(a)*n,rotation:Math.random()*Math.PI*2,rotationSpeed:(Math.random()-.5)*16,life:.18+Math.random()*.2,currentLife:0})}}addShockRing(e,t){this.shockRings.push({x:e,y:t,radius:0,maxRadius:200,life:.45,currentLife:0})}update(e){if(this.currentTime+=e,this.currentTime>=this.duration){this.isComplete=!0,this.dead=!0;return}if(this.screenShake=Math.max(0,this.screenShake-e*16),this.frostCoreTime+=e*3,this.currentTime/this.duration<.6&&Math.random()<18*e&&Math.random()<.5){const i=Math.random()<.5?2:3,s=this.targetPositions[Math.floor(Math.random()*this.targetPositions.length)];if(s)for(let a=0;a<i;a++){const n=Math.random()*Math.PI*2,o=300+Math.random()*250,r=s.x+Math.cos(n)*o,l=s.y+Math.sin(n)*o-100,c=s.x-r,d=s.y-l,u=Math.sqrt(c*c+d*d)||1,p=900+Math.random()*400;this.iceSpears.push({x:r,y:l,vx:c/u*p,vy:d/u*p,rotation:Math.atan2(d,c)+Math.PI/2,life:.45+Math.random()*.45,currentLife:0,trail:[],scale:.8+Math.random()*.4,targetX:s.x,targetY:s.y})}}this.updateIceSpears(e),this.updateIceShards(e),this.updateShockRings(e)}updateIceSpears(e){for(let t=this.iceSpears.length-1;t>=0;t--){const i=this.iceSpears[t];if(!i)continue;i.currentLife+=e,i.x+=i.vx*e,i.y+=i.vy*e,i.trail.push({x:i.x,y:i.y}),i.trail.length>12&&i.trail.shift();const s=Math.sqrt((i.x-i.targetX)**2+(i.y-i.targetY)**2);(i.currentLife>i.life||s<25)&&(this.spawnIceShards(i.x,i.y,28),this.addShockRing(i.x,i.y),this.screenShake=Math.min(8,this.screenShake+2.5),this.iceSpears.splice(t,1))}}updateIceShards(e){for(let t=this.iceShards.length-1;t>=0;t--){const i=this.iceShards[t];if(i){if(i.currentLife+=e,i.currentLife>i.life){this.iceShards.splice(t,1);continue}i.vy+=900*e,i.x+=i.vx*e,i.y+=i.vy*e,i.rotation+=i.rotationSpeed*e}}}updateShockRings(e){for(let t=this.shockRings.length-1;t>=0;t--){const i=this.shockRings[t];if(i){if(i.currentLife+=e*2.2,i.currentLife>=i.life){this.shockRings.splice(t,1);continue}i.radius=18+i.currentLife/i.life*i.maxRadius}}}draw(e){if(this.isComplete)return;const t=this.currentTime/this.duration,i=Math.min(1,t/.12),s=Math.min(1,(this.duration-this.currentTime)/.25),a=Math.min(i,s);if(e.save(),this.screenShake>0){const n=(Math.random()-.5)*this.screenShake*2,o=(Math.random()-.5)*this.screenShake*2;e.translate(n,o)}this.drawFrostCore(e,a),this.drawIceSpears(e,a),this.drawShockRings(e,a),this.drawIceShards(e,a),e.restore()}drawFrostCore(e,t){e.save(),e.globalCompositeOperation="lighter";const i=140+40*Math.sin(this.frostCoreTime*6),s=e.createRadialGradient(this.x,this.y,0,this.x,this.y,i);s.addColorStop(0,`rgba(220,240,255,${.5*t})`),s.addColorStop(1,"rgba(220,240,255,0)"),e.fillStyle=s,e.beginPath(),e.arc(this.x,this.y,i,0,Math.PI*2),e.fill(),e.restore()}drawIceSpears(e,t){for(const i of this.iceSpears){e.save(),e.globalCompositeOperation="lighter";for(let a=0;a<i.trail.length-1;a++){const n=i.trail[a],o=i.trail[a+1];if(!n||!o)continue;const r=a/(i.trail.length-1),l=18*(1-r);e.globalAlpha=t*.35*(1-r),e.strokeStyle="rgba(150,210,255,0.40)",e.lineCap="round",e.lineWidth=l,e.beginPath(),e.moveTo(n.x,n.y),e.lineTo(o.x,o.y),e.stroke()}e.globalAlpha=t,e.translate(i.x,i.y),e.rotate(i.rotation);const s=i.scale*(.8+Math.min(.7,i.currentLife*1.1));e.scale(s,s),e.drawImage(this.iceSpearSprite,-13,-20),e.restore()}}drawIceShards(e,t){e.save(),e.globalCompositeOperation="lighter";for(const i of this.iceShards){const s=1-i.currentLife/i.life;e.globalAlpha=t*s,e.save(),e.translate(i.x,i.y),e.rotate(i.rotation),e.strokeStyle="rgba(210,240,255,0.95)",e.lineWidth=2,e.beginPath(),e.moveTo(-3,0),e.lineTo(3,0),e.moveTo(0,-3),e.lineTo(0,3),e.stroke(),e.restore()}e.restore()}drawShockRings(e,t){e.save(),e.globalCompositeOperation="lighter";for(const i of this.shockRings){const s=1-i.currentLife/i.life;e.globalAlpha=t*s,e.strokeStyle="rgba(180,220,255,0.70)",e.lineWidth=2+6*s,e.beginPath(),e.arc(i.x,i.y,i.radius,0,Math.PI*2),e.stroke()}e.restore()}}class we{pos;vel;target;tail;alive;life;maxLife;tailLength;config;constructor(e,t,i,s){this.pos={x:e,y:t},this.vel={x:0,y:-6},this.target=i,this.tail=[],this.tailLength=20,this.alive=!0,this.life=2,this.maxLife=2,this.config=s}update(){if(this.alive){if(this.life-=.016,this.life<=0){this.alive=!1;return}if(this.target){const e=this.target.x-this.pos.x,t=this.target.y-this.pos.y,i=Math.hypot(e,t);if(i>5){this.vel.x+=e/i*.4,this.vel.y+=t/i*.4;const s=Math.hypot(this.vel.x,this.vel.y);s>this.config.speed&&(this.vel.x*=this.config.speed/s,this.vel.y*=this.config.speed/s)}else this.life=Math.min(this.life,.3)}this.pos.x+=this.vel.x,this.pos.y+=this.vel.y,this.tail.push({x:this.pos.x,y:this.pos.y}),this.tail.length>this.tailLength&&this.tail.shift()}}draw(e){if(!this.alive||this.tail.length<2)return;const t=this.life/this.maxLife;e.save(),e.globalCompositeOperation="lighter";for(let s=1;s<this.tail.length;s++){const a=this.tail[s-1],n=this.tail[s];if(!a||!n)continue;const o=s/this.tail.length*t*.6;e.strokeStyle=this.config.trailColor.replace("1)",`${o})`),e.lineWidth=2+s/3,e.beginPath(),e.moveTo(a.x,a.y),e.lineTo(n.x,n.y),e.stroke()}e.restore();const i=Math.atan2(this.vel.y,this.vel.x);e.save(),e.translate(this.pos.x,this.pos.y),e.rotate(i),e.shadowColor=this.config.color,e.shadowBlur=this.config.glowIntensity*t,e.globalAlpha=t,e.fillStyle=this.config.color,e.fillRect(-this.config.size,-2,this.config.size,4),e.fillStyle=this.config.color,e.beginPath(),e.moveTo(0,0),e.lineTo(this.config.size*.3,-3),e.lineTo(this.config.size*.3,3),e.closePath(),e.fill(),e.restore()}}class ke{canvas;ctx;particles=[];swords=[];greenLotusEffects=[];ubwEffects=[];divineThunderEffects=[];nineFinaleEffects=[];iceSpearEffects=[];animationId=null;lastTime=0;enabled=!0;constructor(){this.canvas=document.createElement("canvas"),this.canvas.id="particle-canvas",this.canvas.style.position="absolute",this.canvas.style.top="0",this.canvas.style.left="0",this.canvas.style.pointerEvents="none",this.canvas.style.zIndex="100";const e=this.canvas.getContext("2d");if(!e)throw new Error("Could not get canvas context");this.ctx=e}initialize(e){const t=e.getBoundingClientRect();this.canvas.width=t.width,this.canvas.height=t.height,e.style.position="relative",e.appendChild(this.canvas),this.enabled&&this.startAnimation()}setEnabled(e){this.enabled=e,e?this.animationId||this.startAnimation():(this.stopAnimation(),this.clearParticles())}stopAnimation(){this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null)}clearParticles(){this.particles=[],this.swords=[],this.greenLotusEffects=[],this.ubwEffects=[],this.divineThunderEffects=[],this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}startAnimation(){const e=t=>{const i=t-this.lastTime;this.lastTime=t,this.update(i/1e3),this.render(),this.animationId=requestAnimationFrame(e)};this.animationId=requestAnimationFrame(e)}update(e){for(let t=this.particles.length-1;t>=0;t--){const i=this.particles[t];i&&(i.x+=i.vx*e,i.y+=i.vy*e,i.life-=e,i.alpha=Math.max(0,i.life/i.maxLife),i.type==="spark"&&(i.vy+=200*e),i.life<=0&&this.particles.splice(t,1))}for(let t=this.swords.length-1;t>=0;t--){const i=this.swords[t];i&&(i.update(),i.alive||this.swords.splice(t,1))}for(let t=this.greenLotusEffects.length-1;t>=0;t--){const i=this.greenLotusEffects[t];i&&(i.update(e),i.dead&&this.greenLotusEffects.splice(t,1))}for(let t=this.ubwEffects.length-1;t>=0;t--){const i=this.ubwEffects[t];i&&(i.update(e),i.dead&&this.ubwEffects.splice(t,1))}for(let t=this.divineThunderEffects.length-1;t>=0;t--){const i=this.divineThunderEffects[t];i&&(i.update(e),i.dead&&this.divineThunderEffects.splice(t,1))}for(let t=this.nineFinaleEffects.length-1;t>=0;t--){const i=this.nineFinaleEffects[t];i&&(i.update(e),i.isFinished()&&this.nineFinaleEffects.splice(t,1))}for(let t=this.iceSpearEffects.length-1;t>=0;t--){const i=this.iceSpearEffects[t];i&&(i.update(e),i.dead&&this.iceSpearEffects.splice(t,1))}}render(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);for(const e of this.particles)this.ctx.save(),this.ctx.globalAlpha=e.alpha,e.type==="circle"?this.drawCircle(e):e.type==="star"?this.drawStar(e):e.type==="spark"?this.drawSpark(e):e.type==="text"&&this.drawText(e),this.ctx.restore();for(const e of this.swords)e.draw(this.ctx);for(const e of this.greenLotusEffects)e.draw(this.ctx);for(const e of this.ubwEffects)e.draw(this.ctx);for(const e of this.divineThunderEffects)e.draw(this.ctx);for(const e of this.nineFinaleEffects)e.render(this.ctx);for(const e of this.iceSpearEffects)e.draw(this.ctx)}drawCircle(e){this.ctx.beginPath(),this.ctx.arc(e.x,e.y,e.size,0,Math.PI*2),this.ctx.fillStyle=e.color,this.ctx.fill(),this.ctx.shadowBlur=10,this.ctx.shadowColor=e.color,this.ctx.fill()}drawStar(e){const i=e.size,s=e.size*.5;this.ctx.beginPath(),this.ctx.translate(e.x,e.y);for(let a=0;a<5*2;a++){const n=a%2===0?i:s,o=a*Math.PI/5,r=Math.cos(o)*n,l=Math.sin(o)*n;a===0?this.ctx.moveTo(r,l):this.ctx.lineTo(r,l)}this.ctx.closePath(),this.ctx.fillStyle=e.color,this.ctx.fill(),this.ctx.translate(-e.x,-e.y)}drawSpark(e){this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.lineTo(e.x-e.vx*.1,e.y-e.vy*.1),this.ctx.strokeStyle=e.color,this.ctx.lineWidth=e.size,this.ctx.lineCap="round",this.ctx.stroke()}drawText(e){!e.text||!e.fontSize||(this.ctx.font=`bold ${e.fontSize}px Arial, sans-serif`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillStyle=e.color,this.ctx.shadowBlur=15,this.ctx.shadowColor=e.color,this.ctx.strokeStyle="rgba(0, 0, 0, 0.8)",this.ctx.lineWidth=3,this.ctx.strokeText(e.text,e.x,e.y),this.ctx.fillText(e.text,e.x,e.y))}calculateGrade(e,t,i){const s=t===0||t===7||t===56||t===63,a=Math.floor(t/8),n=t%8,o=a===0||a===7||n===0||n===7;let r=e*10;return s?r+=60:o&&(r+=20),i?.massive&&(r+=40),i?.chain&&(r+=30),i?.comeback&&(r+=25),i?.domination&&(r+=20),i?.firstMove&&(r-=10),r>=100||e>=15?"SSS":r>=70||e>=10?"SS":r>=50||e>=7?"S":r>=30||e>=5?"A":r>=15||e>=3?"B":"C"}triggerMoveEffect(e,t,i,s,a,n){if(this.enabled){if(this.createFloatingGradeText(e,t,i),i==="SSS"){setTimeout(()=>this.createSSSEffect(e,t,s,a,n),0);return}this.createPresetEffect(e,t,i,s,a,n),i==="S"&&s>=7&&setTimeout(()=>this.createSEffect(e,t,s,a,n),100)}}createPresetEffect(e,t,i,s,a,n){const o=me(i),r=G[o];if(!r)return;if(i==="B"&&o==="green_lotus"){this.createGreenLotusEffect(e,t,n||[]);return}if(i==="C"&&o==="unlimited_blade_works"){this.createUnlimitedBladeWorksEffect(e,t,n||[]);return}if(i==="S"&&o==="divine_thunder"){this.createDivineThunderEffect(e,t,n||[]);return}if(i==="SS"&&o==="nine_finale"){this.createNineFinaleEffect(e,t,n||[]);return}if(i==="A"){this.createIceSpearEffect(e,t,n||[]);return}const l=this.calculateFlipDirections(e,t,n),c=Math.min(1+(s-1)*.1,2),d=Math.floor((r.spawning.count.min+Math.random()*(r.spawning.count.max-r.spawning.count.min))*c);for(let u=0;u<d;u++)setTimeout(()=>{this.createPresetParticle(e,t,r,u,d,l)},Math.random()*(r.spawning.delay.max-r.spawning.delay.min)+r.spawning.delay.min);a?.corner&&i!=="C"&&this.addCornerEnhancement(e,t,r,l),a?.massive&&s>=8&&this.addMassiveEnhancement(e,t,r,l)}calculateFlipDirections(e,t,i){return!i||i.length===0?Array.from({length:8},(s,a)=>({angle:a/8*Math.PI*2,distance:100})):i.map(s=>{const a=s.x-e,n=s.y-t,o=Math.sqrt(a*a+n*n);return{angle:Math.atan2(n,a),distance:Math.max(o,50)}})}createSwords(e,t,i,s,a,n=0){if(this.swords.length>=60)return;const r=Math.min(a,60-this.swords.length);for(let l=0;l<r;l++)setTimeout(()=>{let c=null;if(i.length>0)c=i[l%i.length]||i[0]||null;else{const w=l/r*Math.PI*2,b=200+Math.random()*300;c={x:e+Math.cos(w)*b,y:t+Math.sin(w)*b}}const d=30,u=Math.random()*Math.PI*2,p=e+Math.cos(u)*d,v=t+Math.sin(u)*d,S=new we(p,v,c,s);this.swords.push(S)},n+l*30)}createPresetParticle(e,t,i,s,a,n){const o=i.colors,r=o[Math.floor(Math.random()*o.length)]||o[0]||"#ffffff";let l,c;if(n&&n.length>0){const b=Math.floor(s/a*n.length),A=n[b]||n[0];if(A){const T=A.angle,F=i.spawning.spread.angle||Math.PI/6;l=T+(Math.random()-.5)*F}else l=Math.random()*Math.PI*2;c=i.physics.velocity.min+Math.random()*(i.physics.velocity.max-i.physics.velocity.min)}else switch(i.behavior.movement){case"explode":l=s/a*Math.PI*2,c=i.physics.velocity.min+Math.random()*(i.physics.velocity.max-i.physics.velocity.min);break;case"float":l=Math.random()*Math.PI*2,c=i.physics.velocity.min+Math.random()*(i.physics.velocity.max-i.physics.velocity.min);break;case"rise":l=Math.PI*1.5+(Math.random()-.5)*i.spawning.spread.angle,c=i.physics.velocity.min+Math.random()*(i.physics.velocity.max-i.physics.velocity.min);break;case"chain":l=Math.random()*Math.PI*2,c=i.physics.velocity.max;break;case"implode":l=Math.random()*Math.PI*2,c=i.physics.velocity.min+Math.random()*(i.physics.velocity.max-i.physics.velocity.min);break;default:l=Math.random()*Math.PI*2,c=100}const d=i.spawning.spread.radius,u=Math.random()*i.spawning.spread.angle-i.spawning.spread.angle/2,p=e+Math.cos(u)*Math.random()*d,v=t+Math.sin(u)*Math.random()*d,S=i.visual.size.min+Math.random()*(i.visual.size.max-i.visual.size.min),w=(i.animation.lifespan.min+Math.random()*(i.animation.lifespan.max-i.animation.lifespan.min))/1e3;this.particles.push({x:p,y:v,vx:Math.cos(l)*c,vy:Math.sin(l)*c,life:w,maxLife:w,size:S,color:r,alpha:i.visual.opacity.start,type:i.type==="snowflake"?"circle":i.type==="lightning"?"spark":"circle"})}addCornerEnhancement(e,t,i,s){for(let a=0;a<12;a++){let n;if(s&&s.length>0){const o=Math.floor(a/12*s.length),r=s[o]||s[0];r?n=r.angle+(Math.random()-.5)*(Math.PI/4):n=a/12*Math.PI*2}else n=a/12*Math.PI*2;this.particles.push({x:e,y:t,vx:Math.cos(n)*80,vy:Math.sin(n)*80,life:1,maxLife:1,size:3,color:"#ffd700",alpha:.8,type:"circle"})}}addMassiveEnhancement(e,t,i,s){for(let a=0;a<3;a++)setTimeout(()=>{for(let n=0;n<20;n++){let o;if(s&&s.length>0){const r=Math.floor(n/20*s.length),l=s[r]||s[0];l?o=l.angle+(Math.random()-.5)*(Math.PI/3):o=n/20*Math.PI*2}else o=n/20*Math.PI*2;this.particles.push({x:e,y:t,vx:Math.cos(o)*(150+a*50),vy:Math.sin(o)*(150+a*50),life:.8,maxLife:.8,size:2,color:"#ffffff",alpha:.6-a*.2,type:"circle"})}},a*100)}createSSSEffect(e,t,i,s,a){const n={color:"#ffed4a",trailColor:"rgba(255, 237, 74, 1)",size:90,speed:5,glowIntensity:100},o=a||[],r=Math.min(35,Math.max(25,Math.floor(i*2.5)));this.createSwords(e,t,o,n,Math.floor(r*.6),0),setTimeout(()=>{this.createSwords(e,t,o,n,Math.floor(r*.4),0)},100),s?.corner&&setTimeout(()=>{this.createSwords(e,t,o,n,3,0)},500),s?.comeback&&setTimeout(()=>{this.createSwords(e,t,o,n,2,0)},600)}createSSEffect(e,t,i,s,a){const n={color:"#ff1100",trailColor:"rgba(255, 17, 0, 1)",size:70,speed:6,glowIntensity:90},o=a||[],r=Math.min(20,Math.max(15,Math.floor(i*1.5)));this.createSwords(e,t,o,n,r,0),s?.massive&&setTimeout(()=>{this.createSwords(e,t,o,n,2,0)},400)}createSEffect(e,t,i,s,a){const n=["#dda0dd","#e6b8ea","#d8bfd8","#9932cc","#ba55d3","#9370db","#8a2be2","#9966cc","#c8a2c8"],o=this.calculateFlipDirections(e,t,a);for(let r=0;r<5;r++)setTimeout(()=>{for(let l=0;l<40;l++){let c;if(o.length>0&&Math.random()<.65){const p=Math.floor(l/40*o.length),v=o[p]||o[0];v?c=v.angle+(Math.random()-.5)*(Math.PI/2.5):c=l/40*Math.PI*2}else c=l/40*Math.PI*2;const d=300+r*80,u=Math.sin(l*.5)*20;this.particles.push({x:e,y:t,vx:Math.cos(c)*d+u,vy:Math.sin(c)*d+u,life:1.5,maxLife:1.5,size:Math.random()*5+3,color:n[r%n.length]??"#9932cc",alpha:1,type:"circle"})}},r*80);for(let r=0;r<80;r++){const l=r/8*Math.PI,c=r*4;setTimeout(()=>{this.particles.push({x:e+Math.cos(l)*c*.3,y:t+Math.sin(l)*c*.3,vx:Math.cos(l+Math.PI/2)*150,vy:Math.sin(l+Math.PI/2)*150,life:2,maxLife:2,size:Math.random()*4+2,color:n[r%n.length]??"#9932cc",alpha:1,type:"circle"})},r*15)}for(let r=0;r<100+i*15;r++)setTimeout(()=>{this.particles.push({x:e+(Math.random()-.5)*40,y:t+Math.random()*20,vx:(Math.random()-.5)*400,vy:-Math.random()*500-200,life:2.5,maxLife:2.5,size:Math.random()*4+2,color:n[Math.floor(Math.random()*n.length)]??"#8a2be2",alpha:1,type:Math.random()>.3?"spark":"circle"})},Math.random()*300);for(let r=0;r<3;r++)setTimeout(()=>{for(let l=0;l<Math.PI*2;l+=.1)this.particles.push({x:e,y:t,vx:Math.cos(l)*(400+r*100),vy:Math.sin(l)*(400+r*100),life:.8,maxLife:.8,size:1,color:"#ffffff",alpha:.8,type:"circle"})},r*200);for(let r=0;r<50;r++){let l;if(o.length>0&&Math.random()<.7){const c=Math.floor(r/50*o.length),d=o[c]||o[0];d?l=d.angle+(Math.random()-.5)*(Math.PI/3):l=r/50*Math.PI*2}else l=r/50*Math.PI*2;setTimeout(()=>{this.particles.push({x:e,y:t,vx:Math.cos(l)*500,vy:Math.sin(l)*500,life:1.2,maxLife:1.2,size:Math.random()*6+2,color:"#9932cc",alpha:1,type:"circle"})},r*20)}}createAEffectWithSwords(e,t,i,s,a){const n={color:"#00bfff",trailColor:"rgba(0, 191, 255, 1)",size:45,speed:8,glowIntensity:80},o=a||[],r=Math.min(12,Math.max(8,Math.floor(i*1.2)));this.createSwords(e,t,o,n,r,0),s?.massive,s?.corner}createAEffect(e,t,i,s){const a=["#87ceeb","#87cefa","#00bfff","#1e90ff","#6495ed","#4682b4","#add8e6","#b0e0e6","#afeeee"],n=this.calculateFlipDirections(e,t,s);if(n.length>0)for(const o of n)for(let r=0;r<3;r++)for(let l=0;l<20;l++)setTimeout(()=>{const c=(Math.random()-.5)*(Math.PI/4),d=o.angle+c,u=250+r*50;this.particles.push({x:e,y:t,vx:Math.cos(d)*u,vy:Math.sin(d)*u,life:1+r*.2,maxLife:1+r*.2,size:Math.random()*4+2,color:a[r%a.length]??"#87ceeb",alpha:1,type:"circle"})},l*20+r*150);else{const o=[[1,0],[0,1],[-1,0],[0,-1],[1,1],[-1,1],[1,-1],[-1,-1]];for(const[r,l]of o)for(let c=0;c<3;c++)for(let d=0;d<15;d++)setTimeout(()=>{this.particles.push({x:e,y:t,vx:r*(250+c*50),vy:l*(250+c*50),life:1+c*.2,maxLife:1+c*.2,size:Math.random()*4+2,color:a[c%a.length]??"#87ceeb",alpha:1,type:"circle"})},d*25+c*200)}for(let o=0;o<4;o++)setTimeout(()=>{for(let r=0;r<30;r++){let l;if(n.length>0&&Math.random()<.4){const d=Math.floor(r/30*n.length),u=n[d]||n[0];u?l=u.angle+(Math.random()-.5)*(Math.PI/3):l=r/30*Math.PI*2}else l=r/30*Math.PI*2;const c=180+o*60;this.particles.push({x:e,y:t,vx:Math.cos(l)*c,vy:Math.sin(l)*c,life:1.2,maxLife:1.2,size:Math.random()*3+2,color:a[o%a.length]??"#87ceeb",alpha:1,type:"circle"})}},o*150);for(let o=0;o<60+i*8;o++)setTimeout(()=>{this.particles.push({x:e+(Math.random()-.5)*30,y:t+Math.random()*15,vx:(Math.random()-.5)*300,vy:-Math.random()*350-150,life:1.8,maxLife:1.8,size:Math.random()*3+1,color:a[Math.floor(Math.random()*a.length)]??"#4169e1",alpha:1,type:"spark"})},Math.random()*400);for(let o=0;o<25;o++){const r=Math.random()*Math.PI*2,l=Math.random()*100+50;this.particles.push({x:e+Math.cos(r)*l,y:t+Math.sin(r)*l,vx:Math.cos(r)*100,vy:Math.sin(r)*100,life:.8,maxLife:.8,size:Math.random()*3+1,color:"#87ceeb",alpha:1,type:"circle"})}}createBEffect(e,t,i){const s=["#90ee90","#98fb98","#00ff7f","#00fa9a","#7cfc00","#7fff00","#adff2f","#9aff9a","#b4ffb4"];for(let a=0;a<2;a++)setTimeout(()=>{for(let n=0;n<25;n++){const o=n/25*Math.PI*2,r=120+a*40;this.particles.push({x:e,y:t,vx:Math.cos(o)*r,vy:Math.sin(o)*r,life:1,maxLife:1,size:Math.random()*2+2,color:s[a%s.length]??"#90ee90",alpha:1,type:"circle"})}},a*100);for(let a=0;a<20+i*5;a++){const n=Math.random()*Math.PI*2,o=Math.random()*150+80;setTimeout(()=>{this.particles.push({x:e,y:t,vx:Math.cos(n)*o,vy:Math.sin(n)*o,life:1.2,maxLife:1.2,size:Math.random()*2+1,color:s[Math.floor(Math.random()*s.length)]??"#00ff7f",alpha:1,type:"spark"})},Math.random()*200)}for(let a=0;a<8;a++){const n=a/8*Math.PI*2;for(let o=0;o<5;o++)setTimeout(()=>{this.particles.push({x:e,y:t,vx:Math.cos(n)*(150+o*30),vy:Math.sin(n)*(150+o*30),life:.8,maxLife:.8,size:2,color:"#90ee90",alpha:1,type:"circle"})},o*50)}}createGreenLotusEffect(e,t,i){const s=i.map(n=>({x:n.x,y:n.y})),a=new fe(e,t,s);this.greenLotusEffects.push(a)}createUnlimitedBladeWorksEffect(e,t,i){const s=i.map(n=>({x:n.x,y:n.y})),a=new pe(e,t,s);this.ubwEffects.push(a)}createDivineThunderEffect(e,t,i){const s=i.map(n=>({x:n.x,y:n.y})),a=new be(e,t,s);this.divineThunderEffects.push(a)}createNineFinaleEffect(e,t,i){const s=i.map(n=>({x:n.x,y:n.y})),a=new Me(e,t,s);this.nineFinaleEffects.push(a)}createIceSpearEffect(e,t,i){const s=i.map(n=>({x:n.x,y:n.y})),a=new Se(e,t,s);this.iceSpearEffects.push(a)}createCEffect(e,t){const i=["#d3d3d3","#c0c0c0","#dcdcdc","#f5f5f5","#e0e0e0","#f8f8f8","#b8b8b8","#a9a9a9","#d8d8d8","#e6e6e6"];for(let s=0;s<12;s++){const a=s/12*Math.PI*2;this.particles.push({x:e,y:t,vx:Math.cos(a)*80,vy:Math.sin(a)*80,life:.8,maxLife:.8,size:Math.random()*1.5+1,color:i[s%i.length]??"#d3d3d3",alpha:.8,type:"circle"})}for(let s=0;s<6;s++){const a=Math.random()*Math.PI*2,n=Math.random()*60+40;this.particles.push({x:e,y:t,vx:Math.cos(a)*n,vy:Math.sin(a)*n,life:.6,maxLife:.6,size:1,color:"#d3d3d3",alpha:.7,type:"spark"})}}createFlipEffect(e,t,i,s){const a=i==="#000000";let n,o;if(s)switch(s){case"SSS":n=["#ffd700","#ffef94","#fff68f","#ffffe0","#fffacd"],o=3;break;case"SS":n=["#ff8c00","#ffa500","#ff7f00","#ff6347","#ff4500"],o=2.5;break;case"S":n=["#dda0dd","#e6b8ea","#d8bfd8","#e0b0ff","#dbb2ff"],o=2;break;case"A":n=["#87ceeb","#add8e6","#b0e0e6","#afeeee","#e0ffff"],o=1.5;break;case"B":n=["#90ee90","#98fb98","#b4ffb4","#c8ffc8","#a8e6a8"],o=1.2;break;case"C":n=["#d3d3d3","#c0c0c0","#e0e0e0","#f5f5f5","#b8b8b8"],o=1;break;default:n=a?["#666666","#888888","#555555"]:["#f0f0f0","#e8e8e8","#f5f5f5"],o=.8}else n=a?["#666666","#888888","#555555"]:["#f0f0f0","#e8e8e8","#f5f5f5"],o=.8;const r=n[0]??"#ffffff",l=n,c=Math.floor(15*o);for(let u=0;u<c;u++){const p=u/c*Math.PI*2,v=(Math.random()*60+60)*o;this.particles.push({x:e,y:t,vx:Math.cos(p)*v,vy:Math.sin(p)*v,life:.6*o,maxLife:.6*o,size:(Math.random()*1.5+1)*o,color:u%3===0?r:l[u%l.length]??r,alpha:.9,type:u%2===0?"spark":"circle"})}const d=Math.floor(2+o);for(let u=0;u<d;u++)setTimeout(()=>{const p=Math.floor(12+o*4);for(let v=0;v<p;v++){const S=v/p*Math.PI*2,w=(80+u*30)*o;this.particles.push({x:e,y:t,vx:Math.cos(S)*w,vy:Math.sin(S)*w,life:.6+u*.2,maxLife:.6+u*.2,size:u===0?2:1,color:r,alpha:.7-u*.2,type:"circle"})}},u*80);for(let u=0;u<15;u++){const p=Math.random()*Math.PI*2,v=Math.random()*60+40;setTimeout(()=>{this.particles.push({x:e+(Math.random()-.5)*20,y:t+(Math.random()-.5)*20,vx:Math.cos(p)*v,vy:Math.sin(p)*v,life:.7,maxLife:.7,size:Math.random()*1.5+1,color:l[Math.floor(Math.random()*l.length)]??"#d3d3d3",alpha:.8,type:"spark"})},Math.random()*200)}for(let u=0;u<8;u++)setTimeout(()=>{this.particles.push({x:e+(Math.random()-.5)*30,y:t+(Math.random()-.5)*30,vx:(Math.random()-.5)*30,vy:-Math.random()*40-20,life:1.2,maxLife:1.2,size:Math.random()*1+.5,color:r,alpha:.6,type:"circle"})},Math.random()*300);setTimeout(()=>{for(let u=0;u<Math.PI*2;u+=.2)this.particles.push({x:e,y:t,vx:Math.cos(u)*150,vy:Math.sin(u)*150,life:.4,maxLife:.4,size:1.5,color:a?"#333333":"#f9f9f9",alpha:.5,type:"circle"})},100)}destroy(){this.animationId&&cancelAnimationFrame(this.animationId),this.particles=[],this.canvas.remove()}getParticleCount(){return this.particles.length}createCornerExplosion(e,t){const i=["#ffd700","#ffdf00","#ffa500"];for(let s=0;s<4;s++){const a=s/4*Math.PI*2;for(let n=0;n<20;n++)setTimeout(()=>{this.particles.push({x:e,y:t,vx:Math.cos(a)*300+(Math.random()-.5)*100,vy:Math.sin(a)*300+(Math.random()-.5)*100,life:1.5,maxLife:1.5,size:Math.random()*3+2,color:i[n%i.length]??"#ffd700",alpha:1,type:"circle"})},n*30+s*200)}}createComebackEffect(e,t){const i=["#ff4500","#ff6347","#ffa500","#ff1493"];for(let s=0;s<80;s++)setTimeout(()=>{this.particles.push({x:e+(Math.random()-.5)*60,y:t+Math.random()*30,vx:(Math.random()-.5)*200,vy:-Math.random()*400-200,life:2,maxLife:2,size:Math.random()*4+2,color:i[Math.floor(Math.random()*i.length)]??"#ff6347",alpha:.9,type:"spark"})},Math.random()*600)}createMassiveEffect(e,t){const i=["#0080ff","#00bfff","#87ceeb","#b0e0e6"];for(let s=0;s<6;s++)setTimeout(()=>{for(let a=0;a<40;a++){const n=a/40*Math.PI*2;this.particles.push({x:e,y:t,vx:Math.cos(n)*(200+s*50),vy:Math.sin(n)*(200+s*50),life:1+s*.2,maxLife:1+s*.2,size:Math.random()*3+1,color:i[s%i.length]??"#0080ff",alpha:.8,type:"circle"})}},s*150)}createDominationEffect(e,t){const i=["#9932cc","#8b00ff","#ffd700","#daa520"];for(let s=0;s<12;s++){const a=s/12*Math.PI*2;setTimeout(()=>{this.particles.push({x:e+Math.cos(a)*50,y:t+Math.sin(a)*50,vx:Math.cos(a)*150,vy:Math.sin(a)*150,life:1.8,maxLife:1.8,size:Math.random()*4+3,color:i[s%i.length]??"#9932cc",alpha:1,type:"circle"})},s*80)}}createChainEffect(e,t){if(!this.enabled)return;const i=["#ffff00","#ffffff","#00ffff"];for(let s=0;s<8;s++){const a=s/8*Math.PI*2;for(let n=0;n<10;n++)setTimeout(()=>{this.particles.push({x:e,y:t,vx:Math.cos(a)*(100+n*20)+(Math.random()-.5)*60,vy:Math.sin(a)*(100+n*20)+(Math.random()-.5)*60,life:.4,maxLife:.4,size:2,color:i[n%i.length]??"#ffff00",alpha:1,type:"spark"})},n*20+s*50)}}createFloatingGradeText(e,t,i){if(!this.enabled)return;const a={C:{color:"#d3d3d3",fontSize:24},B:{color:"#90ee90",fontSize:28},A:{color:"#87ceeb",fontSize:42},S:{color:"#9932cc",fontSize:48},SS:{color:"#ff8c00",fontSize:56},SSS:{color:"#ffd700",fontSize:64}}[i];a&&(this.ctx&&this.canvas?(this.particles.push({x:e,y:t,vx:0,vy:-80,life:2,maxLife:2,size:a.fontSize,color:a.color,alpha:1,type:"text",text:i,fontSize:a.fontSize}),i==="SSS"?setTimeout(()=>{this.particles.push({x:e,y:t-10,vx:0,vy:-60,life:2.5,maxLife:2.5,size:72,color:"#ffa500",alpha:.7,type:"text",text:i,fontSize:72})},100):i==="SS"?setTimeout(()=>{this.particles.push({x:e,y:t-8,vx:0,vy:-65,life:2.2,maxLife:2.2,size:64,color:"#ff4500",alpha:.6,type:"text",text:i,fontSize:64})},80):i==="S"?setTimeout(()=>{this.particles.push({x:e,y:t-6,vx:0,vy:-70,life:2,maxLife:2,size:54,color:"#ba55d3",alpha:.5,type:"text",text:i,fontSize:54})},60):i==="A"&&setTimeout(()=>{this.particles.push({x:e,y:t-5,vx:0,vy:-75,life:1.8,maxLife:1.8,size:48,color:"#4169e1",alpha:.4,type:"text",text:i,fontSize:48})},40)):this.createCSSFloatingText(e,t,i))}createCSSFloatingText(e,t,i){const s=this.canvas.parentElement;if(!s)return;const a=document.createElement("div");a.className=`floating-grade-text grade-${i.toLowerCase()}`,a.textContent=i,a.style.left=`${e}px`,a.style.top=`${t}px`,a.style.transform="translate(-50%, -50%)",s.appendChild(a),setTimeout(()=>{a.parentNode&&a.parentNode.removeChild(a)},2e3)}}const Te={"loading.title":"Loading Super Reversi...","loading.details":"Initializing game engine and AI systems","app.title":"🎮 Super Reversi","game.black":"Black","game.white":"White","game.current":"Current","game.currentTurn":"Current Turn:","game.mode":"Mode","game.pvp":"Player vs Player","game.pvai":"Player vs AI","game.back":"← Back to Menu","game.blackWins":"Black Wins!","game.whiteWins":"White Wins!","game.tie":"It's a Tie!","game.gameOverTitle":"Game Over!","game.totalMoves":"Total moves","game.playAgain":"Play Again","game.mainMenu":"Main Menu","menu.chooseMode":"🎯 Choose Game Mode","menu.pvp":"Player vs Player","menu.pvc":"Player vs Computer","menu.settings":"Settings","menu.help":"How to Play","menu.back":"← Back to Menu","menu.selectDifficulty":"🤖 Select AI Difficulty","menu.easy":"Easy","menu.medium":"Medium","menu.hard":"Hard","menu.easyDesc":"Easy: AI makes random valid moves","menu.mediumDesc":"Medium: AI tries to maximize flips","menu.hardDesc":"Hard: AI uses advanced strategy","menu.startGame":"Start Game","settings.title":"⚙️ Settings","settings.language":"Language","settings.visual":"Visual Settings","settings.showValid":"Show valid moves","settings.showLast":"Highlight last move","settings.showMobility":"Show mobility","settings.animations":"Enable animations","settings.game":"Game Settings","settings.autoPass":"Auto-pass when no moves","settings.confirm":"Confirm moves (vs Computer)","settings.save":"Save Settings","settings.saved":"Settings saved!","help.title":"❓ How to Play Reversi","help.objectiveTitle":"🎯 Objective","help.objectiveText":"Have the most pieces when the game ends.","help.rulesTitle":"📋 Rules","help.rules1":"Black moves first","help.rules2":"Capture pieces between yours","help.rules3":"Can capture in 8 directions","help.rules4":"Must capture at least 1 piece","help.rules5":"Pass if no valid moves","help.rules6":"Game ends when no moves left","help.strategyTitle":"💡 Strategy","help.strategy1":"<strong>Corners:</strong> Can't be flipped!","help.strategy2":"<strong>Edges:</strong> Harder to flip","help.strategy3":"<strong>Mobility:</strong> Limit opponent moves","help.strategy4":"<strong>Patience:</strong> Less can be more","help.controlsTitle":"🎮 Controls","help.controls1":"Click highlighted cells to move","help.controls2":"Green = valid moves","help.controls3":"Gold = last move","messages.quitConfirm":"Are you sure you want to quit the current game?","messages.moveConfirm":"Confirm this move?","messages.invalidMove":"Invalid move","difficulty.easy":"Easy","difficulty.medium":"Medium","difficulty.hard":"Hard","combo.counter":"${count} Combo!","combo.double":"Twin Strike!","combo.triple":"Triple Tempest!","combo.quadruple":"Quadra Blaze!","combo.quintuple":"Penta Storm!","combo.sextuple":"Hexa Fury!","combo.septuple":"Hepta Cataclysm!","special.corner_joseki":"Corner Joseki!","special.great_reversal":"Great Reversal!","special.total_domination":"Total Domination!","special.desperate_kill":"Desperate Kill!","special.perfect_endgame":"Perfect Endgame!","special.edge_control":"Edge Control!","special.chain_reaction":"Chain Reaction!","special.time_control":"Time Control!","special.green_lotus":"Green Lotus Sword Song!","special.blade_echo":"Blade Echo!","special.divine_thunder":"Divine Thunder Strike!","special.corner_joseki.subtitle":"Corner Joseki","special.great_reversal.subtitle":"Great Reversal","special.total_domination.subtitle":"Total Domination","special.desperate_kill.subtitle":"Desperate Kill","special.perfect_endgame.subtitle":"Perfect Endgame","special.edge_control.subtitle":"Edge Control","special.chain_reaction.subtitle":"Chain Reaction","special.time_control.subtitle":"Time Control","special.green_lotus.subtitle":"Green Lotus Sword Song","special.blade_echo.subtitle":"Blade Echo","special.divine_thunder.subtitle":"Divine Thunder Strike","special.nine_finale":"Nine Finale Destruction!","special.nine_finale.subtitle":"Nine Finale Destruction","special.ice_spear_abyss":"Ice Spear Abyss!","special.ice_spear_abyss.subtitle":"Ice Spear Abyss","modal.ok":"OK","modal.cancel":"Cancel","modal.confirm":"Confirm","modal.yes":"Yes","modal.no":"No","modal.info":"Information","modal.warning":"Warning","modal.error":"Error","modal.success":"Success","modal.confirm.title":"Confirm","modal.settingsComing":"Settings feature coming soon!","modal.testClick":"You clicked position ${position}","modal.appWorking":"Application is working!","modal.moveConfirm.title":"Confirm Move","modal.quitConfirm.title":"Quit Game","modal.settingsSaved.title":"Settings Saved"},Ee={"loading.title":"正在載入超級黑白棋...","loading.details":"正在初始化遊戲引擎與人工智慧系統","app.title":"🎮 超級黑白棋","game.black":"黑棋","game.white":"白棋","game.current":"現在","game.currentTurn":"目前回合：","game.mode":"模式","game.pvp":"玩家對戰","game.pvai":"玩家對電腦","game.back":"← 返回選單","game.blackWins":"黑棋勝利！","game.whiteWins":"白棋勝利！","game.tie":"平手！","game.gameOverTitle":"遊戲結束！","game.totalMoves":"總步數","game.playAgain":"再玩一次","game.mainMenu":"回主選單","menu.chooseMode":"🎯 選擇遊戲模式","menu.pvp":"玩家對玩家","menu.pvc":"玩家對電腦","menu.settings":"設定","menu.help":"玩法說明","menu.back":"← 返回選單","menu.selectDifficulty":"🤖 選擇AI難度","menu.easy":"簡單","menu.medium":"中等","menu.hard":"困難","menu.easyDesc":"簡單：AI隨機下合法棋","menu.mediumDesc":"中等：AI試著最大化翻子","menu.hardDesc":"困難：AI使用進階策略","menu.startGame":"開始遊戲","settings.title":"⚙️ 設定","settings.language":"語言","settings.visual":"視覺設定","settings.showValid":"顯示可下位置","settings.showLast":"標示上一手","settings.showMobility":"顯示行動力","settings.animations":"啟用動畫","settings.game":"遊戲設定","settings.autoPass":"無棋可下自動跳過","settings.confirm":"與電腦對戰時確認落子","settings.save":"保存設定","settings.saved":"設定已保存！","help.title":"❓ 如何遊玩黑白棋","help.objectiveTitle":"🎯 目標","help.objectiveText":"遊戲結束時棋子數最多者獲勝。","help.rulesTitle":"📋 規則","help.rules1":"黑棋先行","help.rules2":"夾住對方棋子以翻轉","help.rules3":"可向八個方向翻棋","help.rules4":"至少翻一子才能落子","help.rules5":"無棋可下時須跳過","help.rules6":"雙方皆無棋可下時遊戲結束","help.strategyTitle":"💡 策略","help.strategy1":"<strong>角落：</strong> 不會被翻轉！","help.strategy2":"<strong>邊緣：</strong> 較不易被翻","help.strategy3":"<strong>行動力：</strong> 限制對手落子","help.strategy4":"<strong>耐心：</strong> 有時少卻是多","help.controlsTitle":"🎮 操作","help.controls1":"點擊高亮格子落子","help.controls2":"綠色 = 可下位置","help.controls3":"金色 = 上一步","messages.quitConfirm":"確定要結束目前的遊戲嗎？","messages.moveConfirm":"確定這一步嗎？","messages.invalidMove":"無效的落子","difficulty.easy":"簡單","difficulty.medium":"中等","difficulty.hard":"困難","combo.counter":"${count} 連擊！","combo.double":"雙星爆擊！","combo.triple":"三連風暴！","combo.quadruple":"四極炎舞！","combo.quintuple":"五芒雷鳴！","combo.sextuple":"六道狂怒！","combo.septuple":"七星毀滅！","special.corner_joseki":"角部定式！","special.great_reversal":"大翻盤！","special.total_domination":"完全壓制！","special.desperate_kill":"絕地反殺！","special.perfect_endgame":"完美收官！","special.edge_control":"邊線掌控！","special.chain_reaction":"連鎖反應！","special.time_control":"時間掌控！","special.green_lotus":"青蓮劍歌！","special.blade_echo":"劍刃迴響！","special.divine_thunder":"神劍御雷！","special.corner_joseki.subtitle":"角部定式","special.great_reversal.subtitle":"大翻盤","special.total_domination.subtitle":"完全壓制","special.desperate_kill.subtitle":"絕地反殺","special.perfect_endgame.subtitle":"完美收官","special.edge_control.subtitle":"邊線掌控","special.chain_reaction.subtitle":"連鎖反應","special.time_control.subtitle":"時間掌控","special.green_lotus.subtitle":"青蓮劍歌","special.blade_echo.subtitle":"劍刃迴響","special.divine_thunder.subtitle":"神劍御雷","special.nine_finale":"九俱焚滅！","special.nine_finale.subtitle":"九俱焚滅","special.ice_spear_abyss":"滅劍羅淵！","special.ice_spear_abyss.subtitle":"滅劍羅淵","modal.ok":"確定","modal.cancel":"取消","modal.confirm":"確認","modal.yes":"是","modal.no":"否","modal.info":"資訊","modal.warning":"警告","modal.error":"錯誤","modal.success":"成功","modal.confirm.title":"確認","modal.settingsComing":"設定功能即將推出！","modal.testClick":"你點擊了位置 ${position}","modal.appWorking":"應用程式運作正常！","modal.moveConfirm.title":"確認移動","modal.quitConfirm.title":"退出遊戲","modal.settingsSaved.title":"設定已儲存"},_e={"loading.title":"正在加载超级黑白棋...","loading.details":"正在初始化游戏引擎和人工智能系统","app.title":"🎮 超级黑白棋","game.black":"黑棋","game.white":"白棋","game.current":"当前","game.currentTurn":"当前回合：","game.mode":"模式","game.pvp":"玩家对战","game.pvai":"玩家对电脑","game.back":"← 返回菜单","game.blackWins":"黑棋胜利！","game.whiteWins":"白棋胜利！","game.tie":"平局！","game.gameOverTitle":"游戏结束！","game.totalMoves":"总步数","game.playAgain":"再玩一次","game.mainMenu":"回主菜单","menu.chooseMode":"🎯 选择游戏模式","menu.pvp":"玩家对玩家","menu.pvc":"玩家对电脑","menu.settings":"设置","menu.help":"玩法说明","menu.back":"← 返回菜单","menu.selectDifficulty":"🤖 选择AI难度","menu.easy":"简单","menu.medium":"中等","menu.hard":"困难","menu.easyDesc":"简单：AI随机下合法棋","menu.mediumDesc":"中等：AI尝试最大化翻子","menu.hardDesc":"困难：AI使用高级策略","menu.startGame":"开始游戏","settings.title":"⚙️ 设置","settings.language":"语言","settings.visual":"视觉设置","settings.showValid":"显示可下位置","settings.showLast":"标记上一步","settings.showMobility":"显示行动力","settings.animations":"启用动画","settings.game":"游戏设置","settings.autoPass":"无棋可下自动跳过","settings.confirm":"与电脑对战时确认落子","settings.save":"保存设置","settings.saved":"设置已保存！","help.title":"❓ 如何玩黑白棋","help.objectiveTitle":"🎯 目标","help.objectiveText":"游戏结束时棋子数最多者获胜。","help.rulesTitle":"📋 规则","help.rules1":"黑棋先行","help.rules2":"夹住对方棋子以翻转","help.rules3":"可向八个方向翻棋","help.rules4":"至少翻一子才能落子","help.rules5":"无棋可下时须跳过","help.rules6":"双方均无棋可下时游戏结束","help.strategyTitle":"💡 策略","help.strategy1":"<strong>角落：</strong> 不会被翻转！","help.strategy2":"<strong>边缘：</strong> 较不易被翻","help.strategy3":"<strong>行动力：</strong> 限制对手落子","help.strategy4":"<strong>耐心：</strong> 有时少却是多","help.controlsTitle":"🎮 操作","help.controls1":"点击高亮格子落子","help.controls2":"绿色 = 可下位置","help.controls3":"金色 = 上一步","messages.quitConfirm":"确定要结束当前的游戏吗？","messages.moveConfirm":"确认这一步吗？","messages.invalidMove":"无效的落子","difficulty.easy":"简单","difficulty.medium":"中等","difficulty.hard":"困难","combo.counter":"${count} 连击！","combo.double":"双星爆击！","combo.triple":"三连风暴！","combo.quadruple":"四极炎舞！","combo.quintuple":"五芒雷鸣！","combo.sextuple":"六道狂怒！","combo.septuple":"七星毁灭！","special.corner_joseki":"角部定式！","special.great_reversal":"大翻盘！","special.total_domination":"完全压制！","special.desperate_kill":"绝地反杀！","special.perfect_endgame":"完美收官！","special.edge_control":"边线掌控！","special.chain_reaction":"连锁反应！","special.time_control":"时间掌控！","special.green_lotus":"青莲剑歌！","special.blade_echo":"剑刃回响！","special.divine_thunder":"神剑御雷！","special.corner_joseki.subtitle":"角部定式","special.great_reversal.subtitle":"大翻盘","special.total_domination.subtitle":"完全压制","special.desperate_kill.subtitle":"绝地反杀","special.perfect_endgame.subtitle":"完美收官","special.edge_control.subtitle":"边线掌控","special.chain_reaction.subtitle":"连锁反应","special.time_control.subtitle":"时间掌控","special.green_lotus.subtitle":"青莲剑歌","special.blade_echo.subtitle":"剑刃回响","special.divine_thunder.subtitle":"神剑御雷","special.nine_finale":"九俱焚灭！","special.nine_finale.subtitle":"九俱焚灭","special.ice_spear_abyss":"灭剑罗渊！","special.ice_spear_abyss.subtitle":"灭剑罗渊","modal.ok":"确定","modal.cancel":"取消","modal.confirm":"确认","modal.yes":"是","modal.no":"否","modal.info":"信息","modal.warning":"警告","modal.error":"错误","modal.success":"成功","modal.confirm.title":"确认","modal.settingsComing":"设置功能即将推出！","modal.testClick":"你点击了位置 ${position}","modal.appWorking":"应用程序运行正常！","modal.moveConfirm.title":"确认移动","modal.quitConfirm.title":"退出游戏","modal.settingsSaved.title":"设置已保存"};let ne="en";const oe={en:Te,"zh-Hant":Ee,"zh-Hans":_e};function m(h,e){let i=oe[ne][h]??h;return e&&(i=i.replace(/\$\{(\w+)\}/g,(s,a)=>Object.prototype.hasOwnProperty.call(e,a)?String(e[a]):"")),i}function ie(h){h in oe&&(ne=h,typeof document<"u"&&(document.documentElement.lang=h))}function se(h=document){h.querySelectorAll("[data-i18n]").forEach(t=>{const i=t.dataset.i18n;t.textContent=m(i)})}const Ie={none:{effectType:"snowflake",intensity:1,duration:500},double:{effectType:"magic",intensity:1.5,duration:800,soundEffect:"combo_double"},triple:{effectType:"fire",intensity:2,duration:1200,soundEffect:"combo_triple",screenShake:!0},quadruple:{effectType:"explosion",intensity:2.5,duration:1500,soundEffect:"combo_quadruple",screenShake:!0},quintuple:{effectType:"lightning",intensity:3,duration:1800,soundEffect:"combo_quintuple",screenShake:!0,slowMotion:!1},sextuple:{effectType:"storm",intensity:4,duration:2200,soundEffect:"combo_sextuple",screenShake:!0,slowMotion:!0},septuple:{effectType:"blackhole",intensity:5,duration:2500,soundEffect:"combo_septuple",screenShake:!0,slowMotion:!0}};class Ce{_state;_eventHandlers=[];_history=[];constructor(){this._state=this.createInitialState()}createInitialState(){return{count:0,player:null,multiplier:1,startTime:0,isActive:!1,maxCombo:0,type:"none"}}get state(){return Object.freeze({...this._state})}get history(){return Object.freeze([...this._history])}processMove(e,t,i){return t?this.endCombo():this._state.player===e?this.continueCombo(i):this.startCombo(e,i)}startCombo(e,t){this._state.isActive&&this.endCombo(),this._state={count:2,player:e,multiplier:1.2,startTime:Date.now(),isActive:!0,maxCombo:Math.max(this._state.maxCombo,2),type:"double"};const i={type:"combo_started",player:e,comboCount:this._state.count,comboType:this._state.type,effect:this.getComboEffect(),timestamp:Date.now()};return this._emitEvent(i),this._history.push(i),i}continueCombo(e){if(!this._state.isActive||!this._state.player)throw new Error("Cannot continue combo: no active combo");this._state.count++,this._state.multiplier=Math.min(1+this._state.count*.2,3),this._state.maxCombo=Math.max(this._state.maxCombo,this._state.count),this._state.type=this.determineComboType(this._state.count);const t={type:"combo_continued",player:this._state.player,comboCount:this._state.count,comboType:this._state.type,effect:this.getComboEffect(),timestamp:Date.now()};return this._emitEvent(t),this._history.push(t),t}endCombo(){if(!this._state.isActive||!this._state.player)return null;const e={type:"combo_ended",player:this._state.player,comboCount:this._state.count,comboType:this._state.type,timestamp:Date.now()};return this._state=this.createInitialState(),this._state.maxCombo=this.state.maxCombo,this._emitEvent(e),this._history.push(e),e}breakCombo(e="manual"){if(!this._state.isActive||!this._state.player)return null;const t={type:"combo_broken",player:this._state.player,comboCount:this._state.count,comboType:this._state.type,timestamp:Date.now()};return this._state=this.createInitialState(),this._state.maxCombo=this.state.maxCombo,this._emitEvent(t),this._history.push(t),t}determineComboType(e){return e>=7?"septuple":e>=6?"sextuple":e>=5?"quintuple":e>=4?"quadruple":e>=3?"triple":e>=2?"double":"none"}getComboEffect(){const e=Ie[this._state.type],t=Math.min(this._state.count*.1,1);return{...e,intensity:e.intensity+t,duration:e.duration+this._state.count*50}}getStats(){const e=this._history.filter(a=>a.type==="combo_ended"||a.type==="combo_broken"),t=e.length,i=t>0?e.reduce((a,n)=>a+n.comboCount,0)/t:0,s={none:0,double:0,triple:0,quadruple:0,quintuple:0,sextuple:0,septuple:0};return e.forEach(a=>{s[a.comboType]++}),{currentCombo:this._state.count,maxCombo:this._state.maxCombo,totalCombos:t,averageComboLength:i,comboTypeDistribution:s}}getSuggestedEffect(e){switch(e){case"septuple":return"blackhole";case"sextuple":return"storm";case"quintuple":return"lightning";case"quadruple":return"explosion";case"triple":return"fire";case"double":return"magic";default:return"snowflake"}}shouldPlaySpecialSound(e){return!["none","double"].includes(e)}shouldTriggerScreenShake(e){return["quintuple","sextuple","septuple"].includes(e)}shouldTriggerSlowMotion(e){return e==="septuple"}reset(){this._state=this.createInitialState(),this._history=[]}addEventListener(e){this._eventHandlers.push(e)}removeEventListener(e){const t=this._eventHandlers.indexOf(e);t!==-1&&this._eventHandlers.splice(t,1)}_emitEvent(e){this._eventHandlers.forEach(t=>{try{t(e)}catch{}})}getComboDisplayText(){if(!this._state.isActive)return"";const e=`combo.${this._state.type}`,t=m(e);return t===e?`${this._state.count} combo!`:t}getComboDisplayColor(){return{none:"#ffffff",double:"#90ee90",triple:"#ffa500",quadruple:"#ff6347",quintuple:"#ff1493",sextuple:"#9932cc",septuple:"#ffd700"}[this._state.type]||"#ffffff"}}const Pe={corner_joseki:{positionType:"corner",minFlipCount:3,timing:"early"},great_reversal:{minFlipCount:6},total_domination:{scoreDifference:{min:15,max:999},minFlipCount:4},desperate_kill:{scoreDifference:{min:-15,max:-1},minFlipCount:4},perfect_endgame:{scoreDifference:{min:20,max:999},special:"near_endgame"},edge_control:{positionType:"edge",minFlipCount:5},chain_reaction:{minFlipCount:8,special:"multiple_directions"},time_control:{minFlipCount:10,special:"ultra_rare"}};L("explosion","magic",.7),m("special.corner_joseki"),m("special.corner_joseki.subtitle"),L("storm","lightning",.6),m("special.great_reversal"),m("special.great_reversal.subtitle"),L("blackhole","magic",.8),m("special.total_domination"),m("special.total_domination.subtitle"),L("fire","explosion",.8),m("special.desperate_kill"),m("special.desperate_kill.subtitle"),{...G.blackhole},m("special.perfect_endgame"),m("special.perfect_endgame.subtitle"),L("lightning","storm",.5),m("special.edge_control"),m("special.edge_control.subtitle"),L("lightning","explosion",.7),m("special.chain_reaction"),m("special.chain_reaction.subtitle"),{...G.blackhole},m("special.time_control"),m("special.time_control.subtitle");class xe{static detectSpecialMove(e,t,i,s,a,n){const o=[],r=t.length,l=i-s;for(const[c,d]of Object.entries(Pe))this.checkCondition(c,d,e,r,l,a,n,t)&&o.push(c);return o}static checkCondition(e,t,i,s,a,n,o,r){if(t.minFlipCount&&s<t.minFlipCount)return!1;if(t.scoreDifference){const{min:l,max:c}=t.scoreDifference;if(a<l||a>c)return!1}return!(t.positionType&&!this.checkPositionType(i,t.positionType)||t.timing&&!this.checkTiming(t.timing,n,o)||t.special&&!this.checkSpecialCondition(e,t.special,{position:i,flipCount:s,scoreDiff:a,moveNumber:n,totalMoves:o,flippedPositions:r}))}static checkPositionType(e,t){const i=Math.floor(e/8),s=e%8;switch(t){case"corner":return(i===0||i===7)&&(s===0||s===7);case"edge":return i===0||i===7||s===0||s===7;case"center":return i>=2&&i<=5&&s>=2&&s<=5;default:return!1}}static checkTiming(e,t,i){const s=t/Math.max(i,60);switch(e){case"early":return s<.3;case"mid":return s>=.3&&s<=.7;case"late":return s>.7;default:return!0}}static checkSpecialCondition(e,t,i){switch(t){case"near_endgame":return i.moveNumber>Math.max(i.totalMoves*.8,40);case"multiple_directions":return this.checkMultipleDirections(i.position,i.flippedPositions);case"ultra_rare":return i.flipCount>=15&&Math.abs(i.scoreDiff)>10;default:return!0}}static checkMultipleDirections(e,t){const i=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]],s=Math.floor(e/8),a=e%8;let n=0;for(const[o,r]of i){if(o===void 0||r===void 0)continue;let l=!1,c=s+o,d=a+r;for(;c>=0&&c<8&&d>=0&&d<8;){const u=c*8+d;if(t.includes(u)){l=!0;break}c+=o,d+=r}l&&n++}return n>=3}}const _=8,X=64;var g=(h=>(h[h.EMPTY=0]="EMPTY",h[h.BLACK=1]="BLACK",h[h.WHITE=2]="WHITE",h))(g||{}),re=(h=>(h.WAITING="waiting",h.IN_PROGRESS="in_progress",h.PAUSED="paused",h.GAME_OVER="game_over",h))(re||{}),M=(h=>(h.C="C",h.B="B",h.A="A",h.S="S",h.SS="SS",h.SSS="SSS",h))(M||{}),f=(h=>(h.RANDOM="v0",h.GREEDY="v1",h.MINIMAX="v2",h.ADVANCED="v3",h.MINIMAX_EASY="v2a",h.MINIMAX_HARD="v2b",h.MASTER="v3_master",h.BLITZ="v3_blitz",h.CUSTOM="custom",h))(f||{});const R={CORNER:25,EDGE:6,X_SQUARE:-10,C_SQUARE:-6,NORMAL:0},$={B:10,A:18,S:30,SS:45,SSS:60},Ae={AI_RESPONSE_TIME:{v0:100,v1:1e3,v2:3e3,v3:5e3,v2a:2e3,v2b:4e3,v3_master:1e4,v3_blitz:1500,custom:5e3}},Le=h=>h>=0&&h<X,De=h=>({row:Math.floor(h/_),col:h%_}),V=h=>[0,7,56,63].includes(h),Be=h=>{const e=De(h);return e.row===0||e.row===7||e.col===0||e.col===7},Oe=h=>[9,14,49,54].includes(h);class x{_isThinking=!1;_shouldStop=!1;_metrics={averageThinkingTime:0,movesPlayed:0,totalNodesEvaluated:0,averageDepth:0,timeoutCount:0,accuracy:0};_thinkingHistory=[];_depthHistory=[];_nodeHistory=[];async selectMove(e,t,i){const s=Date.now(),a=i||this.getDefaultTimeLimit();this._isThinking=!0,this._shouldStop=!1;try{const n=await this.selectMoveImpl(e,t,a),o=Date.now()-s;return this.updateMetrics(n,o,a),{...n,thinkingTime:o}}finally{this._isThinking=!1,this._shouldStop=!1}}getDefaultTimeLimit(){return Ae.AI_RESPONSE_TIME[this.difficulty]||1e3}shouldStop(e,t){return this._shouldStop||Date.now()-e>=t}updateMetrics(e,t,i){this._thinkingHistory.push(t),e.depth!==void 0&&this._depthHistory.push(e.depth),e.nodesEvaluated!==void 0&&this._nodeHistory.push(e.nodesEvaluated);const s=this._thinkingHistory.length,a=this._thinkingHistory.reduce((r,l)=>r+l,0),n=this._nodeHistory.reduce((r,l)=>r+l,0),o=this._depthHistory.reduce((r,l)=>r+l,0);this._metrics={averageThinkingTime:a/s,movesPlayed:s,totalNodesEvaluated:n,averageDepth:this._depthHistory.length>0?o/this._depthHistory.length:0,timeoutCount:this._metrics.timeoutCount+(t>=i?1:0),accuracy:this.estimateAccuracy()}}estimateAccuracy(){if(this._metrics.movesPlayed===0)return 0;const e=this.getDefaultTimeLimit(),t=this._metrics.averageThinkingTime,i=Math.min(t/e,1),s=this.getBaseAccuracy();return Math.min(s+i*.3,1)}getBaseAccuracy(){switch(this.difficulty){case f.RANDOM:return .1;case f.GREEDY:return .6;case f.MINIMAX:return .8;case f.ADVANCED:return .9;default:return .5}}getPerformanceMetrics(){return{...this._metrics}}resetMetrics(){this._metrics={averageThinkingTime:0,movesPlayed:0,totalNodesEvaluated:0,averageDepth:0,timeoutCount:0,accuracy:0},this._thinkingHistory=[],this._depthHistory=[],this._nodeHistory=[]}isThinking(){return this._isThinking}stopThinking(){this._shouldStop=!0}}class k{static addJitter(e,t=.1){const i=(Math.random()-.5)*2*t;return e+i}static selectWeightedRandom(e,t=1){if(e.length===0)throw new Error("No candidates to select from");if(e.length===1)return e[0];const i=e.map(o=>({...o,weight:Math.exp(o.score/t)})),s=i.reduce((o,r)=>o+r.weight,0),a=Math.random()*s;let n=0;for(const o of i)if(n+=o.weight,a<=n)return o;return i[i.length-1]}static evaluatePositionStability(e,t,i){let s=0;[0,7,56,63].includes(t)&&(s+=10);const a=Math.floor(t/8),n=t%8;(a===0||a===7||n===0||n===7)&&(s+=3);const r=this.getNeighbors(t).filter(l=>e.board[l]===i).length;return s+=r*.5,s}static getNeighbors(e){const t=[],i=Math.floor(e/8),s=e%8;for(let a=-1;a<=1;a++)for(let n=-1;n<=1;n++){if(a===0&&n===0)continue;const o=i+a,r=s+n;o>=0&&o<8&&r>=0&&r<8&&t.push(o*8+r)}return t}static getGamePhase(e){return(e.scores.black+e.scores.white)/64}static calculateMobility(e,t){return e.validMoves.size}static isDangerousPosition(e){return[1,6,8,9,14,15,48,49,54,55,57,62].includes(e)}}class Re extends x{difficulty=f.RANDOM;name="Random AI";description="Selects random valid moves with no strategy";async selectMoveImpl(e,t,i){const s=Date.now(),a=Array.from(e.validMoves.keys());if(a.length===0)throw new Error("No valid moves available");const n=Math.random()*50;await new Promise(c=>setTimeout(c,n));const o=Math.floor(Math.random()*a.length),r=a[o],l=this.evaluateMove(e,r,t);return{position:r,confidence:.1,evaluation:l,thinkingTime:Date.now()-s,depth:0,nodesEvaluated:a.length}}evaluateMove(e,t,i){const s=e.validMoves.get(t)||[];let a=0;return[0,7,56,63].includes(t)?a+=25:this.isEdgePosition(t)?a+=6:[9,14,49,54].includes(t)&&(a-=10),a+=s.length,a+=k.addJitter(0,.5),a}isEdgePosition(e){const t=Math.floor(e/8),i=e%8;return t===0||t===7||i===0||i===7}}class $e extends x{difficulty=f.RANDOM;name="Smart Random AI";description="Random moves but avoids obviously terrible positions";async selectMoveImpl(e,t,i){const s=Date.now(),a=Array.from(e.validMoves.keys());if(a.length===0)throw new Error("No valid moves available");const n=a.filter(b=>[0,7,56,63].includes(b)),o=a.filter(b=>this.isEdgePosition(b)&&![0,7,56,63].includes(b)&&!this.isXSquare(b)),r=a.filter(b=>[9,14,49,54].includes(b)),l=a.filter(b=>!n.includes(b)&&!o.includes(b)&&!r.includes(b));let c,d;n.length>0?(c=n,d="corner"):o.length>0?(c=o,d="safe_edge"):l.length>0?(c=l,d="normal"):(c=r,d="x_square");const u=Math.random()*75;await new Promise(b=>setTimeout(b,u));const p=Math.floor(Math.random()*c.length),v=c[p],S=this.evaluateMove(e,v,t),w=this.getConfidenceForMoveType(d);return{position:v,confidence:w,evaluation:S,thinkingTime:Date.now()-s,depth:1,nodesEvaluated:a.length}}evaluateMove(e,t,i){const s=e.validMoves.get(t)||[];let a=0;return[0,7,56,63].includes(t)?a+=25:this.isEdgePosition(t)?a+=6:[9,14,49,54].includes(t)&&(a-=10),a+=s.length,a}isEdgePosition(e){const t=Math.floor(e/8),i=e%8;return t===0||t===7||i===0||i===7}isXSquare(e){return[9,14,49,54].includes(e)}getConfidenceForMoveType(e){switch(e){case"corner":return .8;case"safe_edge":return .6;case"normal":return .3;case"x_square":return .1;default:return .2}}}const N={pure(){return new Re},smart(){return new $e}},J=h=>{if(!Le(h))throw new Error(`Invalid position: ${h}`);return{row:Math.floor(h/_),col:h%_}},le=(h,e,t)=>{if(h[e]!==g.EMPTY)return{isValid:!1,flippedPositions:[],reason:"Position is already occupied"};if(e<0||e>=X)return{isValid:!1,flippedPositions:[],reason:"Position is outside the board"};const i=qe(h,e,t);return i.length===0?{isValid:!1,flippedPositions:[],reason:"Move does not flip any opponent pieces"}:{isValid:!0,flippedPositions:i}},qe=(h,e,t)=>{const i=[],s=t===g.BLACK?g.WHITE:g.BLACK,a=[{row:-1,col:0},{row:-1,col:1},{row:0,col:1},{row:1,col:1},{row:1,col:0},{row:1,col:-1},{row:0,col:-1},{row:-1,col:-1}],n=J(e);for(const o of a){const r=ze(h,n,o,t,s);i.push(...r)}return i};function ze(h,e,t,i,s){const a=[];let n=e.row+t.row,o=e.col+t.col;for(;n>=0&&n<_&&o>=0&&o<_;){const r=n*_+o,l=h[r];if(l===s)a.push(r);else return l===i?a.length>0?a:[]:[];n+=t.row,o+=t.col}return[]}const H=(h,e)=>{const t=new Map;for(let i=0;i<X;i++)if(h[i]===g.EMPTY){const s=le(h,i,e);s.isValid&&t.set(i,s.flippedPositions)}return t},He=(h,e,t,i)=>{const s=new Uint8Array(h);s[e]=t;for(const a of i)s[a]=t;return s},ce=h=>[0,7,56,63].includes(h),he=h=>{const e=J(h);return e.row===0||e.row===7||e.col===0||e.col===7},Ge=h=>[9,14,49,54].includes(h),We=h=>[1,6,8,15,48,55,57,62].includes(h),Ne=(h,e,t)=>{const i=le(h,e,t);if(!i.isValid)return{playerMobility:0,opponentMobility:0};const s=He(h,e,t,i.flippedPositions),a=t===g.BLACK?g.WHITE:g.BLACK,n=H(s,t),o=H(s,a);return{playerMobility:n.size,opponentMobility:o.size}},ae=(h,e,t)=>{let i=0;const s=J(e);if(ce(e))return 10;he(e)&&(i+=3);const a=[{row:-1,col:0},{row:-1,col:1},{row:0,col:1},{row:1,col:1},{row:1,col:0},{row:1,col:-1},{row:0,col:-1},{row:-1,col:-1}];let n=0;for(const o of a){const r=s.row+o.row,l=s.col+o.col;if(r>=0&&r<_&&l>=0&&l<_){const c=r*_+l;h[c]===t&&n++}}return i+=Math.floor(n/2),i},Ye=(h,e,t,i)=>{const s=Fe(h,e,t,i),a=Ke(s.total);return{points:s.total,grade:a,breakdown:Object.freeze(s)}},Fe=(h,e,t,i)=>{const s=Ve(e),a=i.length,n=Ue(h,e,t,i),o=je(h,e,t);let r=s+a+n;const l=Math.max(0,Math.floor(r+o));return{positionValue:s,flippedCount:a,stabilityBonus:n,mobilityFactor:o,total:l}},Ve=h=>ce(h)?R.CORNER:Ge(h)?R.X_SQUARE:We(h)?R.C_SQUARE:he(h)?R.EDGE:R.NORMAL,Ue=(h,e,t,i)=>{let s=0;const a=ae(h,e,t);s+=a;for(const n of i){const o=ae(h,n,t);s+=Math.floor(o/2)}return s},je=(h,e,t)=>{const i=Ne(h,e,t);return i.playerMobility-i.opponentMobility},Ke=h=>h>=$.SSS?M.SSS:h>=$.SS?M.SS:h>=$.S?M.S:h>=$.A?M.A:h>=$.B?M.B:M.C,Q=(h,e,t)=>{const i=[];for(const[s,a]of e.entries()){const n=Ye(h,s,t,[...a]);i.push({position:s,score:n,flippedPositions:[...a]})}return i.sort((s,a)=>a.score.points-s.score.points)},Xe=h=>{if(h.length===0)return null;let e=h[0];for(const t of h)t.score.points>e.score.points&&(e=t);return e};class Je extends x{difficulty=f.GREEDY;name="Greedy AI";description="Selects moves with highest immediate score";async selectMoveImpl(e,t,i){const s=Date.now(),a=Q(e.board,new Map(e.validMoves),t);if(a.length===0)throw new Error("No valid moves available");const o=Math.min(500+Math.random()*300,i*.8)-(Date.now()-s);o>0&&await new Promise(c=>setTimeout(c,o));const r=Xe(a);if(!r)throw new Error("Could not determine best move");const l=this.calculateConfidence(a,r);return{position:r.position,confidence:l,evaluation:r.score.points,thinkingTime:Date.now()-s,depth:1,nodesEvaluated:a.length}}calculateConfidence(e,t){if(e.length===1)return .9;let i=.3;switch(t.score.grade){case M.S:i=.95;break;case M.A:i=.8;break;case M.B:i=.6;break;case M.C:i=.3;break}const s=[...e].sort((a,n)=>n.score.points-a.score.points);if(s.length>1){const a=s[0].score.points-s[1].score.points;a>15?i+=.15:a>5?i+=.05:i-=.1}return Math.max(.1,Math.min(.95,i))}}class Qe extends x{difficulty=f.GREEDY;name="Enhanced Greedy AI";description="Greedy with additional strategic considerations";async selectMoveImpl(e,t,i){const s=Date.now(),a=Q(e.board,new Map(e.validMoves),t);if(a.length===0)throw new Error("No valid moves available");const n=a.map(v=>({...v,enhancedScore:this.calculateEnhancedScore(e,v,t)}));n.sort((v,S)=>S.enhancedScore-v.enhancedScore);const r=n[0].enhancedScore*.9,l=n.filter(v=>v.enhancedScore>=r),c=k.selectWeightedRandom(l.map(v=>({...v,score:v.enhancedScore})),2),u=Math.min(600+Math.random()*400,i*.9)-(Date.now()-s);u>0&&await new Promise(v=>setTimeout(v,u));const p=this.calculateEnhancedConfidence(l,c);return{position:c.position,confidence:p,evaluation:c.enhancedScore,thinkingTime:Date.now()-s,depth:1,nodesEvaluated:a.length}}calculateEnhancedScore(e,t,i){let s=t.score.points;const a=k.getGamePhase(e);a>.7?s+=t.flippedPositions.length*2:a<.3&&k.isDangerousPosition(t.position)&&(s-=5);const n=k.evaluatePositionStability(e,t.position,i);s+=n;const o=i===g.BLACK?g.WHITE:g.BLACK;return k.calculateMobility(e,o)<3&&(s+=2),s}calculateEnhancedConfidence(e,t){let i=.6;if(e.length===1?i=.9:e.length<=3&&(i=.8),t.score?.grade)switch(t.score.grade){case M.S:i=Math.max(i,.9);break;case M.A:i=Math.max(i,.75);break;case M.B:i=Math.max(i,.6);break}return Math.max(.2,Math.min(.95,i))}}class Ze extends x{difficulty=f.GREEDY;name="Adaptive Greedy AI";description="Greedy AI that adapts strategy to game phase and score";async selectMoveImpl(e,t,i){const s=Date.now(),a=Q(e.board,new Map(e.validMoves),t);if(a.length===0)throw new Error("No valid moves available");const n=this.determineStrategy(e,t),o=a.map(p=>({...p,strategicScore:this.calculateStrategicScore(e,p,t,n)}));o.sort((p,v)=>v.strategicScore-p.strategicScore);const r=this.getSelectionTemperature(n),l=o.slice(0,Math.min(5,o.length)),c=k.selectWeightedRandom(l.map(p=>({...p,score:p.strategicScore})),r),u=this.calculateAdaptiveThinkingTime(e,a.length,n,i)-(Date.now()-s);return u>0&&await new Promise(p=>setTimeout(p,u)),{position:c.position,confidence:this.calculateAdaptiveConfidence(n,c,l),evaluation:c.strategicScore,thinkingTime:Date.now()-s,depth:1,nodesEvaluated:a.length}}determineStrategy(e,t){const i=k.getGamePhase(e),s=t===g.BLACK?e.scores.black:e.scores.white,a=t===g.BLACK?e.scores.white:e.scores.black,n=s-a,o=e.validMoves.size;return i>.8?n>0?"endgame_ahead":"endgame_behind":i>.4?n>5?"consolidate":n<-5?"aggressive":o<3?"careful":"balanced":o>8?"opportunistic":"cautious"}calculateStrategicScore(e,t,i,s){let a=t.score.points;switch(k.getGamePhase(e),s){case"endgame_ahead":a+=t.flippedPositions.length*3;break;case"endgame_behind":a+=t.flippedPositions.length*4,(t.score.grade===M.A||t.score.grade===M.S)&&(a+=10);break;case"aggressive":(t.score.grade===M.A||t.score.grade===M.S)&&(a+=8),a+=t.flippedPositions.length*2;break;case"consolidate":[0,7,56,63].includes(t.position)&&(a+=10),k.isDangerousPosition(t.position)&&(a-=8);break;case"careful":k.isDangerousPosition(t.position)&&(a-=15),a+=k.evaluatePositionStability(e,t.position,i)*2;break;case"opportunistic":t.score.grade===M.S&&(a+=15);break;case"cautious":k.isDangerousPosition(t.position)&&(a-=10);break}return a}getSelectionTemperature(e){switch(e){case"aggressive":case"endgame_behind":return 1.5;case"careful":case"consolidate":return 3;default:return 2}}calculateAdaptiveThinkingTime(e,t,i,s){let a=400;switch(t>8&&(a+=200),t<3&&(a+=100),i){case"endgame_ahead":case"endgame_behind":a+=300;break;case"careful":a+=200;break;case"opportunistic":a-=100;break}return a+=Math.random()*200,Math.min(a,s*.9)}calculateAdaptiveConfidence(e,t,i){let s=.7;switch(e){case"consolidate":case"endgame_ahead":s=.8;break;case"aggressive":case"endgame_behind":s=.6;break;case"careful":s=.75;break}return t.score?.grade===M.S?s=Math.min(.95,s+.15):t.score?.grade===M.A&&(s=Math.min(.9,s+.1)),i.length>4&&(s-=.1),Math.max(.2,s)}}const U={standard(){return new Je},enhanced(){return new Qe},adaptive(){return new Ze}},P={POSITION_VALUE:1,MOBILITY:2,STABILITY:3,CORNER_CONTROL:5,EDGE_CONTROL:1.5,POTENTIAL_MOBILITY:1,PARITY:.5,ENDGAME_MATERIAL:10},j=[100,-20,10,5,5,10,-20,100,-20,-50,-2,-2,-2,-2,-50,-20,10,-2,16,2,2,16,-2,10,5,-2,2,1,1,2,-2,5,5,-2,2,1,1,2,-2,5,10,-2,16,2,2,16,-2,10,-20,-50,-2,-2,-2,-2,-50,-20,100,-20,10,5,5,10,-20,100],et=[4,0,3,2,2,3,0,4,0,0,1,1,1,1,0,0,3,1,2,1,1,2,1,3,2,1,1,1,1,1,1,2,2,1,1,1,1,1,1,2,3,1,2,1,1,2,1,3,0,0,1,1,1,1,0,0,4,0,3,2,2,3,0,4];class Y{static evaluatePosition(e,t){const i=e.board,s=t===g.BLACK?g.WHITE:g.BLACK,a=this.evaluatePositionValue(i,t,s),n=this.evaluateMobility(e,t,s),o=this.evaluateStability(i,t,s),r=this.evaluateCornerControl(i,t,s),l=this.evaluateEdgeControl(i,t,s),c=this.evaluatePotentialMobility(i,t,s),d=this.evaluateParity(i,t,s),u=this.evaluateMaterial(i,t,s);return{totalScore:a*P.POSITION_VALUE+n*P.MOBILITY+o*P.STABILITY+r*P.CORNER_CONTROL+l*P.EDGE_CONTROL+c*P.POTENTIAL_MOBILITY+d*P.PARITY+u*P.ENDGAME_MATERIAL,breakdown:{positionValue:a,mobility:n,stability:o,cornerControl:r,edgeControl:l,potentialMobility:c,parity:d,material:u}}}static evaluatePositionValue(e,t,i){let s=0;for(let a=0;a<64;a++){const n=e[a];n===t?s+=j[a]??0:n===i&&(s-=j[a]??0)}return s}static evaluateMobility(e,t,i){const s=e.currentPlayer===t?e.validMoves.size:0,a=e.currentPlayer===i?e.validMoves.size:0;return s+a===0?0:(s-a)/(s+a)*100}static evaluateStability(e,t,i){let s=0,a=0;for(let n=0;n<64;n++){const o=e[n],r=this.calculatePieceStability(e,n);o===t?s+=r:o===i&&(a+=r)}return s-a}static calculatePieceStability(e,t){const i=e[t];if(i===g.EMPTY||i===void 0)return 0;let s=et[t]??0;if(V(t))return s+10;const a=[-9,-8,-7,-1,1,7,8,9];let n=0;for(const o of a)this.isDirectionStable(e,t,o,i)&&n++;return s+n}static isDirectionStable(e,t,i,s){const a=t+i,n=t-i;return a<0||a>=64||n<0||n>=64?!0:e[a]===s||e[n]===s}static evaluateCornerControl(e,t,i){const s=[0,7,56,63];let a=0,n=0;for(const o of s)e[o]===t?a++:e[o]===i&&n++;return(a-n)*25}static evaluateEdgeControl(e,t,i){let s=0,a=0;for(let n=0;n<64;n++)Be(n)&&!V(n)&&(e[n]===t?s++:e[n]===i&&a++);return s-a}static evaluatePotentialMobility(e,t,i){let s=0,a=0;for(let n=0;n<64;n++)if(e[n]===g.EMPTY){const o=this.isAdjacentToColor(e,n,t),r=this.isAdjacentToColor(e,n,i);o&&s++,r&&a++}return s-a}static isAdjacentToColor(e,t,i){const s=[-9,-8,-7,-1,1,7,8,9];for(const a of s){const n=t+a;if(n>=0&&n<64&&e[n]===i)return!0}return!1}static evaluateParity(e,t,i){let s=0;for(let a=0;a<64;a++)e[a]===g.EMPTY&&s++;return s%2===1?1:-1}static evaluateMaterial(e,t,i){let s=0,a=0,n=0;for(let r=0;r<64;r++){const l=e[r];l===t?s++:l===i?a++:n++}const o=n<16?2:.1;return(s-a)*o}static quickEvaluate(e,t,i,s){let a=0;return a+=j[t]??0,a+=s.length*5,V(t)&&(a+=50),Oe(t)&&(a-=25),a}static getGamePhase(e){let t=0;for(let i=0;i<64;i++)e[i]===g.EMPTY&&t++;return t>40?"opening":t>16?"midgame":"endgame"}}Y.evaluatePosition;const tt=Y.quickEvaluate;Y.getGamePhase;class I{static fromGameState(e){const t=e.gameStatus===re.GAME_OVER||e.gameOver===!0||e.validMoves.size===0;return{board:new Uint8Array(e.board),currentPlayer:e.currentPlayer,validMoves:new Map(e.validMoves),scores:{...e.scores},gameOver:t,consecutivePasses:e.consecutivePasses||0}}static makeMove(e,t){const i=e.validMoves.get(t);if(!i)return null;const s=new Uint8Array(e.board);s[t]=e.currentPlayer;for(const c of i)s[c]=e.currentPlayer;const a=e.currentPlayer===g.BLACK?g.WHITE:g.BLACK,n=this.calculateScores(s),o=H(s,a);let r=0,l=!1;if(o.size===0){const c=a===g.BLACK?g.WHITE:g.BLACK,d=H(s,c);if(d.size===0)l=!0,r=2;else return r=1,{board:s,currentPlayer:c,validMoves:d,scores:n,gameOver:!1,consecutivePasses:r}}return{board:s,currentPlayer:a,validMoves:o,scores:n,gameOver:l,consecutivePasses:r}}static makePass(e){const t=e.currentPlayer===g.BLACK?g.WHITE:g.BLACK,i=H(e.board,t),s=e.consecutivePasses+1;return{board:e.board,currentPlayer:t,validMoves:i,scores:e.scores,gameOver:s>=2||i.size===0,consecutivePasses:s}}static calculateScores(e){let t=0,i=0;for(let s=0;s<e.length;s++)e[s]===g.BLACK?t++:e[s]===g.WHITE&&i++;return{black:t,white:i}}static getAllPossibleMoves(e){const t=[];for(const i of e.validMoves.keys()){const s=this.makeMove(e,i);s&&t.push({move:i,newState:s})}return t}static isEndgame(e){let t=0;for(let i=0;i<e.board.length;i++)e.board[i]===g.EMPTY&&t++;return t<=16}static isOpening(e){let t=0;for(let i=0;i<e.board.length;i++)e.board[i]!==g.EMPTY&&t++;return t<=12}static getGamePhaseRatio(e){let t=0;for(let i=0;i<e.board.length;i++)e.board[i]!==g.EMPTY&&t++;return Math.min(1,(t-4)/60)}static getStateHash(e){return`${Array.from(e.board).join("")}_${e.currentPlayer}_${e.consecutivePasses}`}static statesEqual(e,t){if(e.currentPlayer!==t.currentPlayer||e.consecutivePasses!==t.consecutivePasses)return!1;for(let i=0;i<e.board.length;i++)if(e.board[i]!==t.board[i])return!1;return!0}static copyState(e){return{board:new Uint8Array(e.board),currentPlayer:e.currentPlayer,validMoves:new Map(e.validMoves),scores:{...e.scores},gameOver:e.gameOver,consecutivePasses:e.consecutivePasses}}static getStateInfo(e){let t=0,i=0,s=0;for(let n=0;n<e.board.length;n++)switch(e.board[n]){case g.BLACK:t++;break;case g.WHITE:i++;break;case g.EMPTY:s++;break}let a;return s>40?a="opening":s>16?a="midgame":a="endgame",{pieceCount:{black:t,white:i,empty:s},gamePhase:a,mobilityCount:e.validMoves.size}}static validateState(e){try{if(e.board.length!==64||e.currentPlayer!==g.BLACK&&e.currentPlayer!==g.WHITE)return!1;const t=this.calculateScores(e.board);if(t.black!==e.scores.black||t.white!==e.scores.white)return!1;for(const[i,s]of e.validMoves.entries())if(i<0||i>=64||e.board[i]!==g.EMPTY)return!1;return!0}catch{return!1}}}I.fromGameState;I.makeMove;I.makePass;I.getAllPossibleMoves;class O extends x{difficulty=f.MINIMAX;name="Minimax AI";description="Advanced AI using minimax with alpha-beta pruning";_config;_transpositionTable=new Map;_killerMoves=[];_historyTable=new Map;_nodesEvaluated=0;_startTime=0;constructor(e={}){super(),this._config={maxDepth:6,maxTime:3e3,useIterativeDeepening:!0,useTranspositionTable:!0,useMoveOrdering:!0,aspirationWindow:50,...e};for(let t=0;t<=this._config.maxDepth;t++)this._killerMoves[t]=[]}async selectMoveImpl(e,t,i){this._startTime=Date.now(),this._nodesEvaluated=0;const s=Math.min(i,this._config.maxTime),a=Array.from(e.validMoves.keys());if(a.length===0)throw new Error("No valid moves available");if(a.length===1)return{position:a[0],confidence:1,evaluation:0,thinkingTime:Date.now()-this._startTime,depth:0,nodesEvaluated:1};let n;this._config.useIterativeDeepening?n=await this.iterativeDeepening(e,t,s):n=await this.search(e,t,this._config.maxDepth,s);const o=this.calculateConfidence(n,a.length);return{position:n.bestMove,confidence:o,evaluation:n.score,thinkingTime:n.timeElapsed,depth:n.depth,nodesEvaluated:n.nodesEvaluated}}async iterativeDeepening(e,t,i){let s={score:-1/0,bestMove:Array.from(e.validMoves.keys())[0],depth:1,nodesEvaluated:0,timeElapsed:0,terminated:!1},a=0,n=-1/0,o=1/0;for(let r=1;r<=this._config.maxDepth&&!(Date.now()-this._startTime>=i*.9);r++){this._config.aspirationWindow&&r>2&&(n=a-this._config.aspirationWindow,o=a+this._config.aspirationWindow);try{const l=await this.minimaxSearch(e,r,n,o,!0,t,i);if(l.score>-1/0&&(s={score:l.score,bestMove:l.bestMove,depth:r,nodesEvaluated:this._nodesEvaluated,timeElapsed:Date.now()-this._startTime,terminated:!1},a=l.score),this._config.aspirationWindow&&(l.score<=n||l.score>=o)){const c=await this.minimaxSearch(e,r,-1/0,1/0,!0,t,i);c.score>-1/0&&(s={score:c.score,bestMove:c.bestMove,depth:r,nodesEvaluated:this._nodesEvaluated,timeElapsed:Date.now()-this._startTime,terminated:!1})}}catch{break}if(Math.abs(s.score)>1e3)break}return s}async search(e,t,i,s){const a=await this.minimaxSearch(e,i,-1/0,1/0,!0,t,s);return{score:a.score,bestMove:a.bestMove,depth:i,nodesEvaluated:this._nodesEvaluated,timeElapsed:Date.now()-this._startTime,terminated:a.score===-1/0}}async minimaxSearch(e,t,i,s,a,n,o){if(this._nodesEvaluated++,Date.now()-this._startTime>=o)return{score:-1/0};if(this._config.useTranspositionTable){const d=this.lookupTransposition(e,t);if(d){if(d.flag==="exact")return{score:d.score,bestMove:d.bestMove};if(d.flag==="lower"&&d.score>=s)return{score:d.score,bestMove:d.bestMove};if(d.flag==="upper"&&d.score<=i)return{score:d.score,bestMove:d.bestMove}}}if(t===0||e.validMoves.size===0){const d="board"in e&&"scores"in e&&"currentPlayer"in e?e:I.fromGameState(e),u={board:d.board,currentPlayer:d.currentPlayer,validMoves:d.validMoves,scores:d.scores,gameOver:d.gameOver};return{score:Y.evaluatePosition(u,n).totalScore}}const r=this.getOrderedMoves(e,t,n);let l,c=a?-1/0:1/0;for(const d of r){const u=this.makeMove(e,d);if(!u)continue;const p=await this.minimaxSearch(u,t-1,i,s,!a,n,o);if(a?(p.score>c&&(c=p.score,l=d),i=Math.max(i,c)):(p.score<c&&(c=p.score,l=d),s=Math.min(s,c)),s<=i){this.updateKillerMoves(d,t);break}}return this._config.useTranspositionTable&&this.storeTransposition(e,t,c,l,i,s),{score:c,bestMove:l}}getOrderedMoves(e,t,i){const s=Array.from(e.validMoves.keys());if(!this._config.useMoveOrdering)return s;const a=s.map(n=>{const o=e.validMoves.get(n)||[],r=tt(e.board,n,i,[...o]);let l=0;this._killerMoves[t]&&this._killerMoves[t].includes(n)&&(l+=1e3);const c=`${n}_${i}`,d=this._historyTable.get(c)||0;return l+=d,{move:n,score:r+l}});return a.sort((n,o)=>o.score-n.score),a.map(n=>n.move)}makeMove(e,t){const i="board"in e&&"validMoves"in e&&"currentPlayer"in e?e:I.fromGameState(e);return I.makeMove(i,t)}updateKillerMoves(e,t){this._killerMoves[t]||(this._killerMoves[t]=[]);const i=this._killerMoves[t];i.includes(e)||(i.unshift(e),i.length>2&&i.pop())}lookupTransposition(e,t){const i=this.getTranspositionKey(e),s=this._transpositionTable.get(i);return s&&s.depth>=t?s:null}storeTransposition(e,t,i,s,a,n){const o=this.getTranspositionKey(e);let r;i<=a?r="upper":i>=n?r="lower":r="exact",this._transpositionTable.set(o,{depth:t,score:i,flag:r,bestMove:s,timestamp:Date.now()}),this._transpositionTable.size>1e5&&this.cleanupTranspositionTable()}getTranspositionKey(e){return`${Array.from(e.board).join("")}_${e.currentPlayer}`}cleanupTranspositionTable(){const t=Date.now()-3e5;for(const[i,s]of this._transpositionTable.entries())s.timestamp<t&&this._transpositionTable.delete(i)}calculateConfidence(e,t){let i=.7;return i+=Math.min(e.depth/10,.2),e.terminated&&(i-=.3),Math.abs(e.score)>500&&(i+=.2),t>8&&(i-=.1),Math.max(.1,Math.min(.95,i))}getConfig(){return{...this._config}}setConfig(e){this._config={...this._config,...e}}clearCaches(){this._transpositionTable.clear(),this._historyTable.clear();for(let e=0;e<=this._config.maxDepth;e++)this._killerMoves[e]=[]}}const q={basic(){return new O({maxDepth:4,maxTime:2e3,useIterativeDeepening:!0})},intermediate(){return new O({maxDepth:6,maxTime:3e3,useIterativeDeepening:!0,useTranspositionTable:!0})},advanced(){return new O({maxDepth:8,maxTime:5e3,useIterativeDeepening:!0,useTranspositionTable:!0,useMoveOrdering:!0,aspirationWindow:50})},custom(h){return new O(h)}};class it{_entries=new Map;_sequences=[];_maxDepth;constructor(e=12){this._maxDepth=e,this.initializeOpeningDatabase()}getOpeningMove(e){const t=this.generateKey(e),i=this._entries.get(t);if(!i||i.length===0)return null;const s=i.filter(n=>e.validMoves.has(n.position));return s.length===0?null:s.reduce((n,o)=>{const r=n.score*.7+n.winRate*.3;return o.score*.7+o.winRate*.3>r?o:n}).position}getOpeningMoves(e){const t=this.generateKey(e);return(this._entries.get(t)||[]).filter(s=>e.validMoves.has(s.position))}hasOpeningMove(e){const t=this.generateKey(e),i=this._entries.get(t);return i?i.some(s=>e.validMoves.has(s.position)):!1}getOpeningDepth(e){const i=e.scores.black+e.scores.white-4;return Math.min(i,this._maxDepth)}getSequence(e){return this._sequences.find(t=>t.name===e)||null}getAllSequences(){return[...this._sequences]}initializeOpeningDatabase(){this.addOpening("eeeeeeeeeeeeeeeeeeeeeeeeeeee12212100eeeeeeeeeeeeeeeeeeeeeeeeeeee",[{pos:19,score:0,freq:.3,win:.52,comment:"Tiger"},{pos:26,score:0,freq:.25,win:.51,comment:"Rabbit"},{pos:37,score:0,freq:.25,win:.51,comment:"Cat"},{pos:44,score:0,freq:.2,win:.5,comment:"Ox"}]),this.addOpening("eeeeeeeeeeeeeeeeeeee1eeeeee12111100eeeeeeeeeeeeeeeeeeeeeeeeeeee",[{pos:18,score:2,freq:.4,win:.53,comment:"Tiger main line"},{pos:20,score:0,freq:.3,win:.52,comment:"Tiger solid"},{pos:11,score:-1,freq:.2,win:.49,comment:"Tiger passive"},{pos:34,score:1,freq:.1,win:.51,comment:"Tiger counter"}]),this.addOpening("eeeeeeeeeeeeeeeeeeeeeeeeeeee11112100eeeeeeeeeeeeeeeeeeeeeeeeeeee",[{pos:18,score:1,freq:.35,win:.52,comment:"Rabbit main"},{pos:19,score:1,freq:.35,win:.52,comment:"Rabbit parallel"},{pos:25,score:0,freq:.2,win:.5,comment:"Rabbit edge"},{pos:33,score:-1,freq:.1,win:.48,comment:"Rabbit weak"}]),this.addOpening("eeeeeeeeeeeeeeeeeeeeeeeeeeee12211100eeeee1eeeeeeeeeeeeeeeeeeeeee",[{pos:45,score:2,freq:.4,win:.54,comment:"Cat main line"},{pos:43,score:1,freq:.3,win:.52,comment:"Cat solid"},{pos:29,score:0,freq:.2,win:.5,comment:"Cat transpose"},{pos:52,score:-1,freq:.1,win:.48,comment:"Cat edge"}]),this.addOpening("eeeeeeeeeeeeeeeeeeeeeeeeeeee12211100eeeeeeeeeeee1eeeeeeeeeeeeeee",[{pos:43,score:1,freq:.4,win:.52,comment:"Ox main"},{pos:45,score:1,freq:.3,win:.52,comment:"Ox symmetric"},{pos:37,score:0,freq:.2,win:.5,comment:"Ox transpose"},{pos:52,score:-1,freq:.1,win:.48,comment:"Ox passive"}]),this.addDeepSequences(),this.addNamedSequences()}addDeepSequences(){this.addOpening("eeeeeeeeeeeeeeeeee11eeeeeee11111100eeeeeeeeeeeeeeeeeeeeeeeeeeee",[{pos:10,score:3,freq:.5,win:.55,comment:"Tiger sharp"},{pos:12,score:2,freq:.3,win:.53,comment:"Tiger solid"},{pos:25,score:1,freq:.2,win:.51,comment:"Tiger positional"}]),this.addOpening("eeeeeeee11eeeeeeee11eeeeeee11111100eeeeeeeeeeeeeeeeeeeeeeeeeeee",[{pos:9,score:2,freq:.4,win:.54,comment:"Advanced tiger"},{pos:17,score:2,freq:.3,win:.53,comment:"Edge control"},{pos:24,score:1,freq:.3,win:.52,comment:"Center play"}])}addNamedSequences(){this._sequences.push({name:"Tiger Opening",description:"Aggressive opening focusing on quick development",moves:[19,18,10],evaluation:2,isMainLine:!0},{name:"Rabbit Opening",description:"Balanced opening with flexible development",moves:[26,18,19],evaluation:1,isMainLine:!0},{name:"Cat Defense",description:"Solid defensive setup",moves:[37,45,43],evaluation:1,isMainLine:!0},{name:"Ox System",description:"Conservative approach with emphasis on stability",moves:[44,43,45],evaluation:0,isMainLine:!0},{name:"Buffalo Opening",description:"Hypermodern approach delaying central confrontation",moves:[19,20,12],evaluation:1,isMainLine:!1},{name:"Snake Variation",description:"Provocative opening leading to complex positions",moves:[26,25,33],evaluation:0,isMainLine:!1})}addOpening(e,t){const i=t.map(s=>({position:s.pos,score:s.score,frequency:s.freq,winRate:s.win,depth:this.calculateDepth(e),comment:s.comment}));this._entries.set(e,i)}generateKey(e){return Array.from(e.board).map(t=>{switch(t){case g.EMPTY:return"e";case g.BLACK:return"1";case g.WHITE:return"2";default:return"e"}}).join("")}calculateDepth(e){const t=e.split("").filter(i=>i!=="e").length;return Math.max(0,t-4)}getStatistics(){const e=this._entries.size;let t=0,i=0;for(const s of this._entries.values())for(const a of s)t+=a.winRate,i++;return{totalPositions:e,maxDepth:this._maxDepth,averageWinRate:i>0?t/i:0,sequenceCount:this._sequences.length}}validateBook(){const e=[];for(const[t,i]of this._entries.entries()){const s=new Set;for(const a of i)s.has(a.position)&&e.push(`Duplicate position ${a.position} in key ${t}`),s.add(a.position),(a.frequency<0||a.frequency>1)&&e.push(`Invalid frequency for position ${a.position}: ${a.frequency}`),(a.winRate<0||a.winRate>1)&&e.push(`Invalid win rate for position ${a.position}: ${a.winRate}`)}for(const t of this._sequences){t.moves.length===0&&e.push(`Empty sequence: ${t.name}`);for(const i of t.moves)(i<0||i>=64)&&e.push(`Invalid move ${i} in sequence ${t.name}`)}return{isValid:e.length===0,errors:e}}}const st=new it;class at{_config;_transpositionTable=new Map;_nodesSearched=0;_startTime=0;_timeLimit=0;constructor(e={}){this._config={maxEmptySquares:16,useTranspositionTable:!0,useMoveOrdering:!0,maxTimeMs:3e4,enableParity:!0,...e}}async solvePosition(e,t,i){this._startTime=Date.now(),this._timeLimit=i||this._config.maxTimeMs,this._nodesSearched=0;const s=this.countEmptySquares(e.board);if(s>this._config.maxEmptySquares)throw new Error(`Position has ${s} empty squares, exceeds maximum of ${this._config.maxEmptySquares}`);const a=await this.exactSearch(e,t,s,-64,64),n=Date.now()-this._startTime;if(!a.bestMove&&a.bestMove!==0)throw new Error("No valid move found in endgame position");return{bestMove:a.bestMove,exactScore:a.score,movesToEnd:s,isWin:a.score>0,nodesSearched:this._nodesSearched,timeElapsed:n,confidence:1}}canSolve(e){return this.countEmptySquares(e.board)<=this._config.maxEmptySquares}async exactSearch(e,t,i,s,a){if(this._nodesSearched++,Date.now()-this._startTime>=this._timeLimit)throw new Error("Endgame solver timeout");if(this._config.useTranspositionTable){const l=this.lookupTransposition(e,i);if(l)return{score:l.exactScore,bestMove:l.bestMove}}if(e.gameOver||e.validMoves.size===0)return{score:this.calculateFinalScore(e,t)};const n=this.getOrderedMoves(e);let o,r=e.currentPlayer===t?-64:64;for(const l of n){const c=I.makeMove(e,l);if(!c)continue;let d=c;d.validMoves.size===0&&!d.gameOver&&(d=I.makePass(d));const u=await this.exactSearch(d,t,i-1,s,a);if(e.currentPlayer===t?(u.score>r&&(r=u.score,o=l),s=Math.max(s,r)):(u.score<r&&(r=u.score,o=l),a=Math.min(a,r)),a<=s)break}return this._config.useTranspositionTable&&this.storeTransposition(e,i,r,o,s,a),{score:r,bestMove:o}}calculateFinalScore(e,t){let i=0,s=0,a=0;for(let n=0;n<e.board.length;n++){const o=e.board[n];o===t?i++:o!==g.EMPTY?s++:a++}return a>0&&(this._config.enableParity?this.calculateParity(e,t)>0?i+=a:s+=a:e.currentPlayer===t?i+=a:s+=a),i-s}calculateParity(e,t){const i=this.countEmptySquares(e.board),s=e.currentPlayer===t?1:-1;return i%2===1?s:-s}getOrderedMoves(e){const t=Array.from(e.validMoves.keys());if(!this._config.useMoveOrdering)return t;const i=t.map(s=>{let a=0;[0,7,56,63].includes(s)&&(a+=1e3);const n=Math.floor(s/8),o=s%8;(n===0||n===7||o===0||o===7)&&(a+=100);const r=e.validMoves.get(s)?.length||0;return a+=r*10,[9,14,49,54].includes(s)&&(a-=500),{move:s,score:a}});return i.sort((s,a)=>a.score-s.score),i.map(s=>s.move)}countEmptySquares(e){let t=0;for(let i=0;i<e.length;i++)e[i]===g.EMPTY&&t++;return t}generateTranspositionKey(e){return Array.from(e.board).join("")+"_"+e.currentPlayer}lookupTransposition(e,t){const i=this.generateTranspositionKey(e),s=this._transpositionTable.get(i);return s&&s.depth>=t?s:null}storeTransposition(e,t,i,s,a,n){const o=this.generateTranspositionKey(e);let r;i<=a?r="upper":i>=n?r="lower":r="exact",this._transpositionTable.set(o,{exactScore:i,depth:t,bestMove:s,flag:r,timestamp:Date.now()}),this._transpositionTable.size>5e4&&this.cleanupTranspositionTable()}cleanupTranspositionTable(){const e=Date.now()-6e5;for(const[t,i]of this._transpositionTable.entries())i.timestamp<e&&this._transpositionTable.delete(t)}getStatistics(){const e=Date.now()-this._startTime,t=e>0?this._nodesSearched/e*1e3:0;return{transpositionEntries:this._transpositionTable.size,maxEmptySquares:this._config.maxEmptySquares,averageNodesPerSecond:t}}clearCaches(){this._transpositionTable.clear()}setConfig(e){Object.assign(this._config,e)}getConfig(){return{...this._config}}}const nt=new at;class D extends x{difficulty=f.ADVANCED;name="Advanced AI";description="Master-level AI combining opening book, minimax, and endgame solver";_config;_openingBook;_endgameSolver;_minimaxAI;_phaseStats={opening:{moves:0,totalTime:0},midgame:{moves:0,totalTime:0},endgame:{moves:0,totalTime:0}};constructor(e={}){super(),this._config={useOpeningBook:!0,openingBookDepth:12,minimaxDepth:8,minimaxTimeLimit:5e3,useIterativeDeepening:!0,useEndgameSolver:!0,endgameThreshold:16,endgameTimeLimit:3e4,adaptiveTimeManagement:!0,thinkingTimeBase:1e3,thinkingTimeMax:1e4,useMonteCarlo:!1,monteCarloSamples:1e3,useAspirationWindows:!0,...e},this._openingBook=st,this._endgameSolver=nt;const t={maxDepth:this._config.minimaxDepth,maxTime:this._config.minimaxTimeLimit,useIterativeDeepening:this._config.useIterativeDeepening,useTranspositionTable:!0,useMoveOrdering:!0,aspirationWindow:this._config.useAspirationWindows?50:void 0};this._minimaxAI=new O(t)}async selectMoveImpl(e,t,i){const s=Date.now(),a=this.detectGamePhase(e),n=this.calculateAdaptiveTimeLimit(e,i,a);let o;try{switch(a){case"opening":o=await this.handleOpening(e,t,n);break;case"midgame":o=await this.handleMidgame(e,t,n);break;case"endgame":o=await this.handleEndgame(e,t,n);break;default:o=await this.handleMidgame(e,t,n)}const r=Date.now()-s;return this._phaseStats[a].moves++,this._phaseStats[a].totalTime+=r,{...o,thinkingTime:r}}catch{return this._minimaxAI.selectMove(e,t,n)}}async handleOpening(e,t,i){if(this._config.useOpeningBook&&this._openingBook.hasOpeningMove(e)){const s=this._openingBook.getOpeningMove(e);if(s!==null){const a=200+Math.random()*300;return await new Promise(n=>setTimeout(n,a)),{position:s,confidence:.9,evaluation:0,thinkingTime:a,depth:this._openingBook.getOpeningDepth(e),nodesEvaluated:1}}}return this._minimaxAI.selectMove(e,t,i)}async handleMidgame(e,t,i){return this._minimaxAI.selectMove(e,t,i)}async handleEndgame(e,t,i){if(!this._config.useEndgameSolver)return this._minimaxAI.selectMove(e,t,i);const s=I.fromGameState(e);if(this._endgameSolver.canSolve(s))try{const o=await this._endgameSolver.solvePosition(s,t,Math.min(i,this._config.endgameTimeLimit));return{position:o.bestMove,confidence:o.confidence,evaluation:o.exactScore,thinkingTime:o.timeElapsed,depth:o.movesToEnd,nodesEvaluated:o.nodesSearched}}catch{}const a={maxDepth:this._config.minimaxDepth+2,maxTime:i,useIterativeDeepening:!0};return new O(a).selectMove(e,t,i)}detectGamePhase(e){const t=e.scores.black+e.scores.white,i=64-t;return t<=12?"opening":i<=this._config.endgameThreshold?"endgame":"midgame"}calculateAdaptiveTimeLimit(e,t,i){if(!this._config.adaptiveTimeManagement)return t;const s=e.validMoves.size,a=this.assessPositionComplexity(e);let n=1;switch(i){case"opening":n=.3;break;case"midgame":n=1;break;case"endgame":n=2;break}n*=1+a*.5,s>10?n*=1.3:s<3&&(n*=.7);const o=Math.min(this._config.thinkingTimeMax,Math.max(this._config.thinkingTimeBase*n,t*.5));return Math.min(o,t)}assessPositionComplexity(e){let t=0;t+=Math.min(e.validMoves.size/15,1);const i=Math.abs(e.scores.black-e.scores.white);t+=Math.min(i/20,.5);const a=[0,7,56,63].filter(n=>e.board[n]===g.EMPTY);return t+=a.length*.1,Math.min(t,1)}getConfig(){return{...this._config}}setConfig(e){Object.assign(this._config,e);const t={maxDepth:this._config.minimaxDepth,maxTime:this._config.minimaxTimeLimit,useIterativeDeepening:this._config.useIterativeDeepening,aspirationWindow:this._config.useAspirationWindows?50:void 0};this._minimaxAI.setConfig(t)}getPerformanceStats(){const e={moves:this._phaseStats.opening.moves,avgTime:this._phaseStats.opening.moves>0?this._phaseStats.opening.totalTime/this._phaseStats.opening.moves:0},t={moves:this._phaseStats.midgame.moves,avgTime:this._phaseStats.midgame.moves>0?this._phaseStats.midgame.totalTime/this._phaseStats.midgame.moves:0},i={moves:this._phaseStats.endgame.moves,avgTime:this._phaseStats.endgame.moves>0?this._phaseStats.endgame.totalTime/this._phaseStats.endgame.moves:0},s=e.moves+t.moves+i.moves,a=this._phaseStats.opening.totalTime+this._phaseStats.midgame.totalTime+this._phaseStats.endgame.totalTime;return{opening:e,midgame:t,endgame:i,totalMoves:s,overallAvgTime:s>0?a/s:0}}resetStats(){this._phaseStats={opening:{moves:0,totalTime:0},midgame:{moves:0,totalTime:0},endgame:{moves:0,totalTime:0}}}clearCaches(){this._minimaxAI.clearCaches(),this._endgameSolver.clearCaches()}}const z={tournament(){return this.isMobileDevice()?new D({useOpeningBook:!0,openingBookDepth:10,minimaxDepth:6,useEndgameSolver:!1,endgameThreshold:14,adaptiveTimeManagement:!0,thinkingTimeBase:1500,thinkingTimeMax:6e3}):new D({useOpeningBook:!0,openingBookDepth:12,minimaxDepth:8,useEndgameSolver:!0,endgameThreshold:16,adaptiveTimeManagement:!0,thinkingTimeBase:2e3,thinkingTimeMax:15e3})},master(){return this.isMobileDevice()?new D({useOpeningBook:!0,openingBookDepth:12,minimaxDepth:6,useEndgameSolver:!1,endgameThreshold:16,adaptiveTimeManagement:!0,thinkingTimeBase:2e3,thinkingTimeMax:8e3,useAspirationWindows:!1}):new D({useOpeningBook:!0,openingBookDepth:16,minimaxDepth:10,useEndgameSolver:!0,endgameThreshold:20,adaptiveTimeManagement:!0,thinkingTimeBase:3e3,thinkingTimeMax:3e4,useAspirationWindows:!0})},isMobileDevice(){const h=navigator.userAgent.toLowerCase(),t=["mobile","android","iphone","ipad","ipod","blackberry","windows phone"].some(a=>h.includes(a)),i=window.innerWidth<768,s="ontouchstart"in window||navigator.maxTouchPoints>0;return t||i&&s},blitz(){return new D({useOpeningBook:!0,openingBookDepth:8,minimaxDepth:6,useEndgameSolver:!0,endgameThreshold:12,adaptiveTimeManagement:!1,thinkingTimeBase:500,thinkingTimeMax:2e3})},custom(h){return new D(h)}};class ot{_strategies=new Map;_strategyRegistry=new Map;_currentThinking=null;_performanceHistory=new Map;_options;_worker=null;_pendingWorkerRequests=new Map;_customSettings=null;constructor(e={}){this._options={defaultDifficulty:f.GREEDY,enablePerformanceLogging:!0,maxConcurrentThinking:1,fallbackOnTimeout:!0,...e},this.registerDefaultStrategies()}registerDefaultStrategies(){this.registerStrategy({difficulty:f.RANDOM,name:"Pure Random",description:"Completely random move selection",factory:()=>N.pure(),isDefault:!1}),this.registerStrategy({difficulty:f.RANDOM,name:"Smart Random",description:"Random moves but avoids obviously bad positions",factory:()=>N.smart(),isDefault:!0}),this.registerStrategy({difficulty:f.GREEDY,name:"Standard Greedy",description:"Selects highest immediate score",factory:()=>U.standard(),isDefault:!1}),this.registerStrategy({difficulty:f.GREEDY,name:"Enhanced Greedy",description:"Greedy with additional heuristics",factory:()=>U.enhanced(),isDefault:!1}),this.registerStrategy({difficulty:f.GREEDY,name:"Adaptive Greedy",description:"Greedy that adapts to game situation",factory:()=>U.adaptive(),isDefault:!0}),this.registerStrategy({difficulty:f.MINIMAX,name:"Standard Minimax",description:"Minimax with alpha-beta pruning (depth 6)",factory:()=>q.intermediate(),isDefault:!0}),this.registerStrategy({difficulty:f.MINIMAX_EASY,name:"Easy Minimax",description:"Minimax with moderate depth (depth 4)",factory:()=>q.basic(),isDefault:!0}),this.registerStrategy({difficulty:f.MINIMAX_HARD,name:"Hard Minimax",description:"Minimax with deep search (depth 8)",factory:()=>q.advanced(),isDefault:!0}),this.registerStrategy({difficulty:f.ADVANCED,name:"Tournament AI",description:"Opening book + minimax + endgame solver",factory:()=>z.tournament(),isDefault:!0}),this.registerStrategy({difficulty:f.MASTER,name:"Master AI",description:"Maximum strength with deep analysis",factory:()=>z.master(),isDefault:!0}),this.registerStrategy({difficulty:f.BLITZ,name:"Blitz AI",description:"Fast advanced AI for quick games",factory:()=>z.blitz(),isDefault:!0}),this.registerStrategy({difficulty:f.CUSTOM,name:"Custom Minimax",description:"User-configurable minimax AI",factory:()=>q.custom({}),isDefault:!1}),this.registerStrategy({difficulty:f.CUSTOM,name:"Custom Advanced",description:"User-configurable advanced AI",factory:()=>z.custom({}),isDefault:!0})}registerStrategy(e){this._strategyRegistry.has(e.difficulty)||this._strategyRegistry.set(e.difficulty,[]);const t=this._strategyRegistry.get(e.difficulty);e.isDefault&&t.forEach(i=>i.isDefault=!1),t.push(e)}getStrategy(e,t){const i=`${e}_${t||"default"}`;if(!this._strategies.has(i)){const s=this._strategyRegistry.get(e);if(!s||s.length===0)throw new Error(`No strategies registered for difficulty: ${e}`);let a;if(t){const n=s.find(o=>o.name===t);if(!n)throw new Error(`Strategy '${t}' not found for difficulty: ${e}`);a=n}else{const n=s.find(o=>o.isDefault);if(!n)throw new Error(`No default strategy found for difficulty: ${e}`);a=n}this._strategies.set(i,a.factory())}return this._strategies.get(i)}async requestMove(e){if(this._currentThinking&&this._options.maxConcurrentThinking<=1)throw new Error("AI is already thinking. Wait for current move or stop thinking first.");const t=e.timeLimit||1e3;this._currentThinking={isThinking:!0,difficulty:e.difficulty,strategyName:this.getStrategyName(e.difficulty),startTime:Date.now(),timeLimit:t,player:e.player,gameState:e.gameState};try{return this.shouldUseWorker(e.difficulty)?await this.requestMoveViaWorker(e):await this.requestMoveOnMainThread(e)}catch(i){if(this._options.fallbackOnTimeout&&i instanceof Error)return this.getFallbackMove(e);throw i}finally{this._currentThinking=null}}async getFallbackMove(e){return await N.pure().selectMove(e.gameState,e.player,100)}updateCustomAIConfig(e){this._customSettings=e,this.registerStrategy({difficulty:f.CUSTOM,name:"Custom Minimax",description:"User-configurable minimax AI",factory:()=>q.custom({maxDepth:e.searchDepth,maxTime:e.thinkingTime*1e3,useIterativeDeepening:e.iterativeDeepening,useTranspositionTable:e.useTranspositionTable}),isDefault:!1}),this.registerStrategy({difficulty:f.CUSTOM,name:"Custom Advanced",description:"User-configurable advanced AI",factory:()=>z.custom({minimaxDepth:e.searchDepth,minimaxTimeLimit:e.thinkingTime*1e3,thinkingTimeBase:e.thinkingTime*1e3,thinkingTimeMax:e.thinkingTime*2e3,useOpeningBook:e.useOpeningBook,useEndgameSolver:e.useEndgameSolver,adaptiveTimeManagement:e.adaptiveTime,useIterativeDeepening:e.iterativeDeepening}),isDefault:!0}),this._strategies.delete(`${f.CUSTOM}_Custom Minimax`),this._strategies.delete(`${f.CUSTOM}_Custom Advanced`)}shouldUseWorker(e){return[f.MINIMAX_EASY,f.MINIMAX,f.MINIMAX_HARD,f.ADVANCED,f.MASTER,f.BLITZ,f.CUSTOM].includes(e)}getStrategyName(e){const t=this._strategyRegistry.get(e);return t&&t.length>0?(t.find(s=>s.isDefault)||t[0]).name:"Unknown Strategy"}async requestMoveViaWorker(e){return new Promise((t,i)=>{let s=null,a=!1;const n=()=>{s&&(clearTimeout(s),s=null)},o=c=>{a||(a=!0,n(),t(c))},r=c=>{a||(a=!0,n(),i(c))};if(!this._worker)try{this._worker=new Worker(new URL("/assets/ai-worker-CWqBa3j1.js",import.meta.url),{type:"module"}),this._worker.addEventListener("message",c=>{this.handleWorkerMessage(c,o,r)}),this._worker.addEventListener("error",c=>{this.requestMoveWithChunking(e).then(o).catch(r)})}catch{this.requestMoveWithChunking(e).then(o).catch(r);return}const l=Date.now().toString()+"_"+Math.random().toString(36).substr(2,9);this._pendingWorkerRequests.set(l,{resolve:o,reject:r});try{this._worker.postMessage({type:"CALCULATE_MOVE",payload:{id:l,gameState:e.gameState,player:e.player,difficulty:e.difficulty,timeLimit:e.timeLimit||1e3,customConfig:this.getCustomConfig(e.difficulty)}});const c=Math.max((e.timeLimit||1e3)*2,5e3);s=window.setTimeout(()=>{this._pendingWorkerRequests.has(l)&&(this._pendingWorkerRequests.delete(l),this._worker&&(this._worker.terminate(),this._worker=null,this._pendingWorkerRequests.clear()),this.requestMoveWithChunking(e).then(o).catch(r))},c)}catch{this._pendingWorkerRequests.delete(l),this.requestMoveWithChunking(e).then(o).catch(r)}})}async requestMoveOnMainThread(e){const t=this.getStrategy(e.difficulty),i=e.timeLimit||1e3,s=await t.selectMove(e.gameState,e.player,i);return this._options.enablePerformanceLogging&&this.logPerformance(e.difficulty,t.getPerformanceMetrics()),s}handleWorkerMessage(e,t,i){const{type:s,payload:a}=e.data,n=a?.id?this._pendingWorkerRequests.get(a.id):void 0;if(s==="MOVE_RESULT"){const o=a.result;if(n){this._pendingWorkerRequests.delete(a.id),n.resolve(o);return}t&&t(o)}else if(s==="ERROR"){const o=a.error??"Unknown AI error";if(n){this._pendingWorkerRequests.delete(a.id),n.reject(new Error(o));return}i&&i(new Error(o))}}async requestMoveWithChunking(e){let t=e.difficulty;switch(e.difficulty){case f.MINIMAX_HARD:case f.MASTER:t=f.MINIMAX_EASY;break;case f.ADVANCED:case f.MINIMAX:t=f.GREEDY;break;case f.BLITZ:t=f.GREEDY;break}const i=this.getStrategy(t),s=Math.min(e.timeLimit||1e3,1e3),a=Date.now(),n=2e3;try{const o=await Promise.race([this.executeWithYielding(async()=>await i.selectMove(e.gameState,e.player,s)),new Promise((l,c)=>{setTimeout(()=>{c(new Error("Chunked processing timeout"))},n)})]),r=Date.now()-a;return this._options.enablePerformanceLogging&&this.logPerformance(t,i.getPerformanceMetrics()),o}catch{return await N.pure().selectMove(e.gameState,e.player,100)}}async executeWithYielding(e){return new Promise((t,i)=>{let a=Date.now();const n=global.setTimeout;global.setTimeout=(o,r)=>{const l=Date.now();return l-a>100?(a=l,n(()=>{n(o,r)},0)):n(o,r)},e().then(o=>{global.setTimeout=n,t(o)}).catch(o=>{global.setTimeout=n,i(o)})})}getCustomConfig(e){return e===f.CUSTOM&&this._customSettings?this._customSettings:null}stopThinking(){this._currentThinking&&(this.shouldUseWorker(this._currentThinking.difficulty)?this._worker&&(this._worker.terminate(),this._worker=null,this._pendingWorkerRequests.clear()):this.getStrategy(this._currentThinking.difficulty,this._currentThinking.strategyName).stopThinking())}getThinkingStatus(){return this._currentThinking?{...this._currentThinking}:null}isThinking(){return this._currentThinking!==null}getAvailableStrategies(e){return this._strategyRegistry.get(e)||[]}getSupportedDifficulties(){return Array.from(this._strategyRegistry.keys())}getStrategyMetrics(e,t){return this.getStrategy(e,t).getPerformanceMetrics()}resetStrategyMetrics(e,t){this.getStrategy(e,t).resetMetrics()}getPerformanceHistory(e){return this._performanceHistory.get(e)||[]}logPerformance(e,t){this._performanceHistory.has(e)||this._performanceHistory.set(e,[]);const i=this._performanceHistory.get(e);i.push({...t}),i.length>100&&i.shift()}getAggregateStats(e){const t=this._performanceHistory.get(e)||[];if(t.length===0)return{totalGames:0,averageThinkingTime:0,averageAccuracy:0,timeoutRate:0};const i=t.reduce((o,r)=>o+r.movesPlayed,0),s=t.reduce((o,r)=>o+r.averageThinkingTime*r.movesPlayed,0),a=t.reduce((o,r)=>o+r.timeoutCount,0),n=t.reduce((o,r)=>o+r.accuracy*r.movesPlayed,0);return{totalGames:t.length,averageThinkingTime:i>0?s/i:0,averageAccuracy:i>0?n/i:0,timeoutRate:i>0?a/i:0}}clearCache(){this.stopThinking(),this._strategies.clear()}setOptions(e){this._options={...this._options,...e}}getOptions(){return{...this._options}}}const B=new ot({defaultDifficulty:f.GREEDY,enablePerformanceLogging:!0,fallbackOnTimeout:!0}),C=0,y=1,E=2,K=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];class rt{container=null;currentScreen="menu";selectedAI=null;customSettings=null;gameState=null;isProcessingMove=!1;aiThinking=!1;particleSystem;comboSystem;uiManager=null;modalService=null;comboDisplay=null;specialMoveDisplay=null;constructor(){this.particleSystem=new ke,this.comboSystem=new Ce,this.comboSystem.addEventListener(e=>{this.handleComboEvent(e)})}showElement(e){e&&e.classList.remove("is-hidden")}hideElement(e){e&&e.classList.add("is-hidden")}async initialize(e){this.container=e;const t=this.getSettings(),i=t.language||"en";ie(i),se(),this.setupUI(),this.particleSystem.initialize(e),this.particleSystem.setEnabled(t.animations),this.showMenu()}setupUI(){if(!this.container)return;this.container.innerHTML=`
      <div class="super-reversi-app">
        <div class="game-header" id="game-header">
          <button class="header-back-btn is-hidden" id="header-back-btn">⬅️</button>
          <h1 data-i18n="app.title">${m("app.title")}</h1>
        </div>

        <!-- Shared Health Bar System -->
        <div class="shared-health-bar-container is-hidden" id="shared-health-bar-container">
          <!-- Left Player Section (Black) -->
          <div class="player-section left">
            <div class="player-info">
              <div class="player-icon">⚫</div>
              <div class="player-name">${m("game.black")}</div>
            </div>
            <div class="piece-count" id="black-count">2</div>
          </div>

          <!-- Shared Health Bar -->
          <div class="shared-health-bar">
            <div class="health-fill-black" id="black-fill"></div>
            <div class="health-fill-white" id="white-fill"></div>
            <div class="vs-divider" id="vs-divider">
              <span class="vs-text">VS</span>
              <div class="turn-indicator" id="turn-indicator-shared">
                <span id="current-turn-shared">${m("game.black")}</span>
              </div>
            </div>
          </div>

          <!-- Right Player Section (White) -->
          <div class="player-section right">
            <div class="piece-count" id="white-count">2</div>
            <div class="player-info">
              <div class="player-name">${m("game.white")}</div>
              <div class="player-icon">⚪</div>
            </div>
          </div>

          <!-- Damage Numbers Container -->
          <div class="damage-numbers" id="damage-numbers"></div>
        </div>
        <!-- 戰鬥UI覆蓋層 -->
        <div class="battle-overlay" id="battle-overlay">
          <div id="combo-display" class="combo-display hidden">
            <div class="combo-count"></div>
            <div class="combo-text"></div>
            <div class="combo-multiplier"></div>
          </div>
          <div id="special-move-display" class="special-move-display hidden">
            <div class="special-move-title"></div>
            <div class="special-move-subtitle"></div>
          </div>
        </div>

        <div id="screen-container" class="screen-container">
          <!-- Screens render here -->
        </div>

        <!-- Simple Modal -->
        <div id="simple-modal" class="modal-backdrop is-hidden">
          <div class="dialog modal">
            <div class="dialog-content">
              <h3 class="dialog-title" id="modal-title" data-i18n="modal.confirm.title">${m("modal.confirm.title")}</h3>
              <p class="dialog-message" id="modal-message" data-i18n="messages.quitConfirm">${m("messages.quitConfirm")}</p>
              <div class="dialog-buttons">
                <button class="dialog-btn primary" id="modal-confirm" data-i18n="modal.confirm">${m("modal.confirm")}</button>
                <button class="dialog-btn secondary" id="modal-cancel" data-i18n="modal.cancel">${m("modal.cancel")}</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    `,this.comboDisplay=this.container.querySelector("#combo-display"),this.specialMoveDisplay=this.container.querySelector("#special-move-display");const e=document.getElementById("header-back-btn");e&&e.addEventListener("click",()=>{this.currentScreen==="game"?this.showSimpleConfirm(m("messages.quitConfirm"),m("modal.quitConfirm.title")).then(t=>{t&&(this.cleanupGameState(),this.showMenu())}):this.showMenu()}),this.setupHeaderEvents()}setupHeaderEvents(){document.getElementById("header-settings-btn")?.addEventListener("click",()=>{this.showSettings()}),document.getElementById("header-back-btn")?.addEventListener("click",()=>{this.handleBackButton()})}async handleBackButton(){switch(this.currentScreen){case"settings":case"help":this.showMenu();break;case"difficulty":this.showMenu();break;case"game":this.gameState&&!this.gameState.isGameOver?await this.showSimpleConfirm(m("messages.leaveGame"))&&(this.cleanupGameState(),this.showMenu()):(this.cleanupGameState(),this.showMenu());break;default:this.showMenu();break}}handleComboEvent(e){if((e.type==="combo_started"||e.type==="combo_continued")&&(this.showComboUI(e.comboCount,e.player,e.comboType),this.showMessage(`🔥 ${e.comboCount} 連擊！`),this.container)){const t=this.container.getBoundingClientRect(),i=t.width/2,s=t.height/2;this.particleSystem.createChainEffect(i,s)}}cleanupGameState(){this.aiThinking=!1,this.isProcessingMove=!1,B.isThinking()&&B.stopThinking();const e=document.getElementById("ai-status");e&&(e.textContent=""),this.gameState&&(this.gameState=null)}showComboUI(e,t,i){if(!this.comboDisplay)return;const s=this.comboDisplay.querySelector(".combo-count"),a=this.comboDisplay.querySelector(".combo-text"),n=this.comboDisplay.querySelector(".combo-multiplier");s&&(s.textContent=e.toString()),a&&(a.textContent=m("combo.counter",{count:e})),n&&n.classList.add("is-hidden");const r={2:"#90ee90",3:"#ffa500",4:"#ff6347",5:"#ff1493",6:"#9932cc",7:"#ffd700"}[Math.min(e,7)]||"#ffd700";this.comboDisplay.style.background=`linear-gradient(135deg, ${r}, ${r}aa)`,this.comboDisplay.classList.remove("hidden"),this.comboDisplay.classList.add("combo-animation"),setTimeout(()=>{this.comboDisplay?.classList.add("hidden"),this.comboDisplay?.classList.remove("combo-animation")},3e3)}detectSpecialMoves(e,t,i,s){const a=xe.detectSpecialMove(e,t,i,s,this.gameState?.moveHistory.length||0,60);a.length>0&&a.forEach((n,o)=>{setTimeout(()=>{const r=m(`special.${n}`);this.showSpecialMoveUI(r,n),this.showMessage(`⚡ ${r}`)},o*1e3)})}showSpecialMoveUI(e,t){if(!this.specialMoveDisplay)return;const i=this.specialMoveDisplay.querySelector(".special-move-title"),s=this.specialMoveDisplay.querySelector(".special-move-subtitle");if(i&&(i.textContent=e),s){const o=m(`special.${t}.subtitle`);s.textContent=o}const n={corner_master:"#ffd700",mega_flip:"#ff4500",phoenix_rise:"#ff69b4",domination:"#9932cc",time_warp:"#8b00ff"}[t]||"#ffd700";i&&(i.style.color=n,i.style.textShadow=`
        0 0 20px ${n}88,
        0 0 40px ${n}66,
        0 4px 8px rgba(0, 0, 0, 0.8)
      `),this.specialMoveDisplay.classList.remove("hidden"),this.specialMoveDisplay.classList.add("special-move-animation"),setTimeout(()=>{this.specialMoveDisplay?.classList.add("hidden"),this.specialMoveDisplay?.classList.remove("special-move-animation")},2500)}refreshUI(){switch(this.currentScreen){case"menu":this.showMenu();break;case"settings":this.showSettings();break;case"help":this.showHelp();break;case"game":this.showGameScreen(),this.updateDisplay();break}}showMenu(){const e=document.getElementById("screen-container");if(!e)return;this.cleanupGameState(),this.currentScreen="menu";const t=document.getElementById("game-header"),i=document.getElementById("header-back-btn"),s=document.getElementById("shared-health-bar-container");this.showElement(t),this.hideElement(i),this.hideElement(s);const a=document.getElementById("black-score"),n=document.getElementById("white-score"),o=document.getElementById("current-turn");a&&(a.textContent=""),n&&(n.textContent=""),o&&(o.textContent=""),this.gameState=null,e.innerHTML=`
      <div class="menu-screen">
        <h2 class="menu-title">${m("menu.chooseMode")}</h2>
        <button class="menu-button" id="pvp-btn">👥 ${m("menu.pvp")}</button>
        <button class="menu-button" id="pvc-btn">🤖 ${m("menu.pvc")}</button>
        <button class="menu-button" id="menu-settings-btn">⚙️ ${m("menu.settings")}</button>
        <button class="menu-button" id="help-btn">❓ ${m("menu.help")}</button>
      </div>
    `,document.getElementById("pvp-btn")?.addEventListener("click",()=>{this.startNewGame("pvp")}),document.getElementById("pvc-btn")?.addEventListener("click",()=>{this.showAIDifficultyMenu()}),document.getElementById("menu-settings-btn")?.addEventListener("click",()=>{this.showSettings()}),document.getElementById("help-btn")?.addEventListener("click",()=>{this.showHelp()})}showAIDifficultyMenu(){const e=document.getElementById("screen-container");if(!e)return;this.currentScreen="difficulty";const t=document.getElementById("header-back-btn");this.showElement(t),e.innerHTML=`
      <div class="ai-selection-screen">
        <h2 class="menu-title">${m("menu.selectDifficulty")}</h2>

        <!-- AI Level Tabs -->
        <div class="ai-level-tabs">
          <button class="ai-level-tab active" data-level="beginner">
            <span class="level-icon">🌱</span>
            <span class="level-name">初學者</span>
          </button>
          <button class="ai-level-tab" data-level="intermediate">
            <span class="level-icon">📚</span>
            <span class="level-name">中級玩家</span>
          </button>
          <button class="ai-level-tab" data-level="advanced">
            <span class="level-icon">⚔️</span>
            <span class="level-name">高級玩家</span>
          </button>
          <button class="ai-level-tab" data-level="professional">
            <span class="level-icon">🏆</span>
            <span class="level-name">職業級別</span>
          </button>
        </div>

        <!-- AI Options Grid -->
        <div class="ai-options-grid" id="ai-options-grid">
          <!-- Dynamic AI options will be loaded here -->
        </div>

        <!-- AI Info Box -->
        <div class="ai-info-box" id="ai-info-box">
          <div class="ai-info-header">
            <h3 id="ai-info-name">隨機AI</h3>
            <div class="ai-strength" id="ai-strength">★☆☆☆☆</div>
          </div>
          <p class="ai-description" id="ai-description">完全隨機選擇合法移動</p>
          <div class="ai-details">
            <div class="ai-detail">
              <span class="detail-label">思考時間:</span>
              <span class="detail-value" id="ai-thinking-time">0.1秒</span>
            </div>
            <div class="ai-detail">
              <span class="detail-label">搜索深度:</span>
              <span class="detail-value" id="ai-search-depth">0</span>
            </div>
            <div class="ai-features" id="ai-features">
              <span class="feature">即時響應</span>
              <span class="feature">完全隨機</span>
            </div>
          </div>
        </div>

        <!-- Custom Settings Panel (hidden by default) -->
        <div class="ai-custom-settings is-hidden" id="ai-custom-settings">
          <h4>自定義AI設定</h4>
          <div class="custom-setting">
            <label>思考時間 (秒):</label>
            <input type="range" id="custom-thinking-time" min="1" max="30" value="5" step="0.5">
            <span id="thinking-time-value">5.0</span>
          </div>
          <div class="custom-setting">
            <label>搜索深度:</label>
            <input type="range" id="custom-search-depth" min="1" max="12" value="6">
            <span id="search-depth-value">6</span>
          </div>
          <div class="custom-setting">
            <label>
              <input type="checkbox" id="custom-opening-book" checked>
              使用開局庫
            </label>
          </div>
          <div class="custom-setting">
            <label>
              <input type="checkbox" id="custom-endgame-solver" checked>
              終局求解器
            </label>
          </div>
          <div class="custom-setting">
            <label>AI性格:</label>
            <select id="custom-personality">
              <option value="balanced">均衡型</option>
              <option value="aggressive">進攻型</option>
              <option value="defensive">防守型</option>
              <option value="positional">位置型</option>
            </select>
          </div>
        </div>

        <!-- Start Game Button -->
        <button class="menu-button" id="start-ai-btn">${m("menu.startGame")}</button>
      </div>
    `,this.initializeAISelection()}initializeAISelection(){de(async()=>{const{AI_OPTIONS_DATABASE:e,getDefaultAIForLevel:t}=await import("./ai-config-types-CoBQlKPX.js");return{AI_OPTIONS_DATABASE:e,getDefaultAIForLevel:t}},__vite__mapDeps([0,1])).then(({AI_OPTIONS_DATABASE:e,getDefaultAIForLevel:t})=>{this.setupAISelectionHandlers(e,t)})}setupAISelectionHandlers(e,t){let i="beginner";const s=document.querySelectorAll(".ai-level-tab");s.forEach(n=>{n.addEventListener("click",()=>{s.forEach(r=>r.classList.remove("active")),n.classList.add("active"),i=n.getAttribute("data-level")||"beginner",this.loadAIOptions(i,e);const o=t(i);o&&(this.selectedAI=o.id,this.updateAIInfo(o))})}),this.loadAIOptions("beginner",e);const a=t("beginner");a&&(this.selectedAI=a.id,this.updateAIInfo(a)),document.getElementById("start-ai-btn")?.addEventListener("click",()=>{this.selectedAI&&(this.selectedAI===f.CUSTOM&&this.customSettings&&B.updateCustomAIConfig(this.customSettings),this.startNewGame("pvc",this.selectedAI))}),this.initializeCustomSettings()}loadAIOptions(e,t){const i=document.getElementById("ai-options-grid");if(!i)return;const s=t[e]||[];i.innerHTML=s.map(n=>`
      <div class="ai-option-card" data-ai-id="${n.id}">
        <div class="ai-card-header">
          <h4>${n.name}</h4>
          <div class="ai-strength">${this.getStrengthStars(n.strength)}</div>
        </div>
        <p class="ai-card-description">${n.description}</p>
        <div class="ai-card-features">
          ${n.features.map(o=>`<span class="feature">${o}</span>`).join("")}
        </div>
      </div>
    `).join("");const a=i.querySelectorAll(".ai-option-card");a.forEach(n=>{n.addEventListener("click",()=>{a.forEach(l=>l.classList.remove("selected")),n.classList.add("selected");const o=n.getAttribute("data-ai-id"),r=s.find(l=>l.id===o);r&&(this.selectedAI=r.id,this.updateAIInfo(r),this.toggleCustomSettings(r.isCustomizable))})}),a.length>0&&a[0].classList.add("selected")}updateAIInfo(e){const t=document.getElementById("ai-info-name"),i=document.getElementById("ai-strength"),s=document.getElementById("ai-description"),a=document.getElementById("ai-thinking-time"),n=document.getElementById("ai-search-depth"),o=document.getElementById("ai-features");t&&(t.textContent=e.name),i&&(i.textContent=this.getStrengthStars(e.strength)),s&&(s.textContent=e.description),a&&(a.textContent=e.thinkingTime),n&&(n.textContent=e.searchDepth.toString()),o&&(o.innerHTML=e.features.map(r=>`<span class="feature">${r}</span>`).join(""))}getStrengthStars(e){return"★".repeat(e)+"☆".repeat(5-e)}toggleCustomSettings(e){const t=document.getElementById("ai-custom-settings");t&&t.classList.toggle("is-hidden",!e)}initializeCustomSettings(){const e=document.getElementById("custom-thinking-time"),t=document.getElementById("thinking-time-value"),i=document.getElementById("custom-search-depth"),s=document.getElementById("search-depth-value");e&&t&&e.addEventListener("input",()=>{t.textContent=parseFloat(e.value).toFixed(1)}),i&&s&&i.addEventListener("input",()=>{s.textContent=i.value}),document.querySelectorAll("#ai-custom-settings input, #ai-custom-settings select").forEach(n=>{n.addEventListener("change",()=>{this.updateCustomSettings()})})}updateCustomSettings(){const e=parseFloat(document.getElementById("custom-thinking-time")?.value||"5"),t=parseInt(document.getElementById("custom-search-depth")?.value||"6"),i=document.getElementById("custom-opening-book")?.checked||!1,s=document.getElementById("custom-endgame-solver")?.checked||!1,a=document.getElementById("custom-personality")?.value||"balanced";this.customSettings={thinkingTime:e,searchDepth:t,useOpeningBook:i,useEndgameSolver:s,adaptiveTime:!0,personality:a,iterativeDeepening:!0,useTranspositionTable:!0}}showSettings(){const e=document.getElementById("screen-container");if(!e)return;this.currentScreen="settings";const t=document.getElementById("header-back-btn");this.showElement(t),e.innerHTML=`
      <div class="settings-screen">
        <h2 class="settings-title">${m("settings.title")}</h2>

        <div class="settings-group">
          <h3>${m("settings.language")}</h3>
          <select id="language-select" class="language-select">
            <option value="en">English</option>
            <option value="zh-Hant">繁體中文</option>
            <option value="zh-Hans">简体中文</option>
          </select>
        </div>

        <div class="settings-group">
          <h3>${m("settings.visual")}</h3>
          <label>
            <input type="checkbox" id="show-valid" checked>
            <span>${m("settings.showValid")}</span>
          </label>
          <label>
            <input type="checkbox" id="show-last" checked>
            <span>${m("settings.showLast")}</span>
          </label>
          <label>
            <input type="checkbox" id="show-mobility">
            <span>${m("settings.showMobility")}</span>
          </label>
          <label>
            <input type="checkbox" id="animations" checked>
            <span>${m("settings.animations")}</span>
          </label>
        </div>

        <div class="settings-group">
          <h3>${m("settings.game")}</h3>
          <label>
            <input type="checkbox" id="auto-pass" checked>
            <span>${m("settings.autoPass")}</span>
          </label>
          <label>
            <input type="checkbox" id="confirm-moves">
            <span>${m("settings.confirm")}</span>
          </label>
        </div>

        <button class="menu-button menu-button--spaced" id="save-settings">
          ${m("settings.save")}
        </button>
      </div>
    `;const i=this.getSettings();document.getElementById("language-select").value=i.language||"en",document.getElementById("show-valid").checked=i.showValid,document.getElementById("show-last").checked=i.showLast,document.getElementById("show-mobility").checked=i.showMobility,document.getElementById("animations").checked=i.animations,document.getElementById("auto-pass").checked=i.autoPass,document.getElementById("confirm-moves").checked=i.confirmMoves,document.getElementById("save-settings")?.addEventListener("click",()=>{const s=document.getElementById("language-select").value,a={language:s,showValid:document.getElementById("show-valid")?.checked,showLast:document.getElementById("show-last")?.checked,showMobility:document.getElementById("show-mobility")?.checked,animations:document.getElementById("animations")?.checked,autoPass:document.getElementById("auto-pass")?.checked,confirmMoves:document.getElementById("confirm-moves")?.checked};localStorage.setItem("reversi-settings",JSON.stringify(a)),localStorage.setItem("language",s),ie(s),se(),this.particleSystem.setEnabled(a.animations),this.modalService&&this.modalService.showSuccess(m("settings.saved"),m("modal.settingsSaved.title")),this.refreshUI()})}showHelp(){const e=document.getElementById("screen-container");if(!e)return;this.currentScreen="help";const t=document.getElementById("header-back-btn");this.showElement(t),e.innerHTML=`
      <div class="help-screen">
        <h2>${m("help.title")}</h2>

        <h3>${m("help.objectiveTitle")}</h3>
        <p>${m("help.objectiveText")}</p>

        <h3>${m("help.rulesTitle")}</h3>
        <ul>
          <li>${m("help.rules1")}</li>
          <li>${m("help.rules2")}</li>
          <li>${m("help.rules3")}</li>
          <li>${m("help.rules4")}</li>
          <li>${m("help.rules5")}</li>
          <li>${m("help.rules6")}</li>
        </ul>

        <h3>${m("help.strategyTitle")}</h3>
        <ul>
          <li>${m("help.strategy1")}</li>
          <li>${m("help.strategy2")}</li>
          <li>${m("help.strategy3")}</li>
          <li>${m("help.strategy4")}</li>
        </ul>

        <h3>${m("help.controlsTitle")}</h3>
        <ul>
          <li>${m("help.controls1")}</li>
          <li>${m("help.controls2")}</li>
          <li>${m("help.controls3")}</li>
        </ul>
      </div>
    `}startNewGame(e,t=f.GREEDY){this.gameState={board:this.createInitialBoard(),currentPlayer:y,blackScore:2,whiteScore:2,gameMode:e,isGameOver:!1,validMoves:new Set,moveHistory:[],aiDifficulty:t},this.updateValidMoves(),this.showGameScreen(),this.updateDisplay()}createInitialBoard(){const e=new Array(64).fill(C);return e[27]=E,e[28]=y,e[35]=y,e[36]=E,e}showGameScreen(){const e=document.getElementById("screen-container");if(!e||!this.gameState)return;this.currentScreen="game";const t=document.getElementById("game-header"),i=document.getElementById("header-back-btn"),s=document.getElementById("shared-health-bar-container");this.showElement(t),this.showElement(i),this.showElement(s);const a=this.gameState.gameMode==="pvp"?m("game.pvp"):`${m("game.pvai")} (${m("difficulty."+this.gameState.aiDifficulty)})`;e.innerHTML=`
      <div class="game-screen">
        <div class="game-info-compact">
          <div>${m("game.mode")}: ${a}</div>
          <div id="ai-status"></div>
        </div>
        <div class="game-board" id="game-board"></div>
        <div id="game-over-modal" class="game-over-modal is-hidden"></div>
      </div>
    `,this.createBoardCells()}createBoardCells(){const e=document.getElementById("game-board");if(!(!e||!this.gameState)){e.innerHTML="";for(let t=0;t<64;t++){const i=document.createElement("div");i.className="board-cell",i.dataset.position=t.toString(),i.addEventListener("click",()=>{!this.isProcessingMove&&!this.aiThinking&&this.handleCellClick(t)}),e.appendChild(i)}this.renderBoard()}}renderBoard(){if(!this.gameState)return;const e=this.getSettings(),t=new Map;if(e.showMobility&&this.gameState.validMoves.size>0)for(const i of this.gameState.validMoves){const s=this.calculateMoveMobility(i,this.gameState.currentPlayer);t.set(i,s)}for(let i=0;i<64;i++){const s=document.querySelector(`[data-position="${i}"]`);if(s){if(s.className="board-cell",s.innerHTML="",this.gameState.board[i]!==C){const a=document.createElement("div");a.className=`piece ${this.gameState.board[i]===y?"piece-black":"piece-white"}`,s.appendChild(a)}if(e.showValid&&this.gameState.validMoves.has(i)&&(s.classList.add("valid-move"),e.showMobility&&t.has(i))){const a=t.get(i),n=document.createElement("div");n.className="mobility-indicator";const o=a.player-a.opponent;n.textContent=o>0?`+${o}`:`${o}`,o>0?n.classList.add("mobility-positive"):o<0?n.classList.add("mobility-negative"):n.classList.add("mobility-neutral"),s.appendChild(n)}if(e.showLast&&this.gameState.moveHistory.length>0){const a=this.gameState.moveHistory[this.gameState.moveHistory.length-1];a&&a.position===i&&s.classList.add("last-move")}}}}getSettings(){const e=localStorage.getItem("reversi-settings");return e?JSON.parse(e):{language:localStorage.getItem("language")||"en",showValid:!0,showLast:!0,showMobility:!1,animations:!0,autoPass:!0,confirmMoves:!1}}async handleCellClick(e){if(!this.gameState||this.gameState.isGameOver||!this.gameState.validMoves.has(e))return;const t=this.getSettings();this.gameState.gameMode==="pvc"&&this.gameState.currentPlayer===y&&t.confirmMoves&&!await this.showSimpleConfirm(m("messages.moveConfirm"),m("modal.moveConfirm.title"))||this.makeMove(e)}makeMove(e){if(!this.gameState)return;this.isProcessingMove=!0;const t=this.getSettings(),i=this.getFlippedPieces(e,this.gameState.currentPlayer),s={corner:e===0||e===7||e===56||e===63,edge:this.isEdgePosition(e),massive:i.length>=10,chain:this.isChainMove(i),comeback:this.isComebackMove(),domination:this.isDominationMove()},a=this.particleSystem.calculateGrade(i.length,e,s),n=document.querySelector(`[data-position="${e}"]`);if(n){const o=n.getBoundingClientRect(),r=this.container.getBoundingClientRect(),l=o.left+o.width/2-r.left,c=o.top+o.height/2-r.top,d=i.map(u=>{const p=document.querySelector(`[data-position="${u}"]`);if(p){const v=p.getBoundingClientRect();return{x:v.left+v.width/2-r.left,y:v.top+v.height/2-r.top}}return{x:l,y:c}});t.animations&&(this.particleSystem.triggerMoveEffect(l,c,a,i.length,s,d),s.chain&&this.particleSystem.createChainEffect(l,c),this.showGradeIndicator(a,l,c))}if(this.gameState.moveHistory.push({position:e,player:this.gameState.currentPlayer,flipped:i}),this.triggerScreenShake(a),this.gameState.board[e]=this.gameState.currentPlayer,n){const o=document.createElement("div");o.className=`piece ${this.gameState.currentPlayer===y?"piece-black":"piece-white"} placing`,n.innerHTML="",n.appendChild(o)}t.animations?setTimeout(()=>{this.flipPiecesWithEffects(i,a);const o=i.length*80+300;setTimeout(()=>{this.afterMove()},o)},200):(this.flipPiecesWithEffects(i,a),this.afterMove())}showGradeIndicator(e,t,i){const s=document.createElement("div");switch(s.style.position="absolute",s.style.left=`${t}px`,s.style.top=`${i-50}px`,s.style.transform="translateX(-50%)",s.style.fontSize="3rem",s.style.fontWeight="bold",s.style.zIndex="200",s.style.pointerEvents="none",s.style.animation="gradePopup 1s ease-out forwards",e){case"SSS":s.textContent="SSS",s.style.color="#ff0080",s.style.textShadow="0 0 1.875rem #ff0080, 0 0 3.75rem #ff69b4",s.style.fontSize="3.5rem",s.style.animation="gradePopup 2s ease-out forwards, rainbow 2s infinite";break;case"SS":s.textContent="SS",s.style.color="#9932cc",s.style.textShadow="0 0 1.5625rem #9932cc, 0 0 3.125rem #8b00ff",s.style.fontSize="3.25rem",s.style.animation="gradePopup 1.5s ease-out forwards, glow 1.5s infinite";break;case"S":s.textContent="S",s.style.color="#ff69b4",s.style.textShadow="0 0 1.25rem #ff69b4",s.style.fontSize="3rem";break;case"A":s.textContent="A",s.style.color="#ffd700",s.style.textShadow="0 0 1.25rem #ffd700";break;case"B":s.textContent="B",s.style.color="#00ff7f",s.style.textShadow="0 0 0.9375rem #00ff7f";break;case"C":s.textContent="C",s.style.color="#888888",s.style.textShadow="0 0 0.625rem #888888";break}this.container?.appendChild(s),setTimeout(()=>{s.remove()},1e3)}flipPiecesWithEffects(e,t){if(!this.gameState)return;this.getSettings().animations?e.forEach((s,a)=>{setTimeout(()=>{this.gameState.board[s]=this.gameState.currentPlayer;const n=document.querySelector(`[data-position="${s}"]`);if(n){const o=n.getBoundingClientRect(),r=this.container.getBoundingClientRect(),l=o.left+o.width/2-r.left,c=o.top+o.height/2-r.top,d=this.gameState.currentPlayer===y?"#000000":"#ffffff";this.particleSystem.createFlipEffect(l,c,d,t);const u=n.querySelector(".piece");u&&(u.classList.add("flipping"),setTimeout(()=>{u.className=`piece ${this.gameState.currentPlayer===y?"piece-black":"piece-white"}`},250))}},a*80)}):e.forEach(s=>{this.gameState.board[s]=this.gameState.currentPlayer;const a=document.querySelector(`[data-position="${s}"]`);if(a){const n=a.querySelector(".piece");n&&(n.className=`piece ${this.gameState.currentPlayer===y?"piece-black":"piece-white"}`)}})}flipPieces(e){if(!this.gameState)return;const t=this.getSettings();e.forEach(i=>{this.gameState.board[i]=this.gameState.currentPlayer;const s=document.querySelector(`[data-position="${i}"]`);if(s){const a=s.querySelector(".piece");a&&t.animations?(a.classList.add("flipping"),setTimeout(()=>{a.className=`piece ${this.gameState.currentPlayer===y?"piece-black":"piece-white"}`},250)):a&&(a.className=`piece ${this.gameState.currentPlayer===y?"piece-black":"piece-white"}`)}})}afterMove(){if(!this.gameState)return;this.updateScores(),this.gameState.currentPlayer=this.gameState.currentPlayer===y?E:y,this.updateValidMoves();const e=this.gameState.currentPlayer===y?E:y,t=this.gameState.validMoves.size>0,i=this.gameState.moveHistory[this.gameState.moveHistory.length-1];i&&(this.comboSystem.processMove(e===y?1:2,t,i.flipped.length),this.detectSpecialMoves(i.position,i.flipped,e===y?this.gameState.blackScore:this.gameState.whiteScore,e===y?this.gameState.whiteScore:this.gameState.blackScore));const s=!this.checkGameStatus();s&&this.updateDisplay(),this.isProcessingMove=!1,s&&this.gameState.gameMode==="pvc"&&this.gameState.currentPlayer===E&&this.makeAIMove()}updateValidMoves(){if(this.gameState){this.gameState.validMoves.clear();for(let e=0;e<64;e++)this.gameState.board[e]===C&&this.isValidMove(e,this.gameState.currentPlayer)&&this.gameState.validMoves.add(e)}}isValidMove(e,t){if(!this.gameState||this.gameState.board[e]!==C)return!1;for(const[i,s]of K)if(this.checkDirection(e,t,i||0,s||0).length>0)return!0;return!1}checkDirection(e,t,i,s){if(!this.gameState)return[];const a=[],n=Math.floor(e/8),o=e%8,r=t===y?E:y;let l=n+s,c=o+i;for(;l>=0&&l<8&&c>=0&&c<8;){const d=l*8+c;if(this.gameState.board[d]===C)return[];if(this.gameState.board[d]===r)a.push(d);else return a.length>0?a:[];l+=s,c+=i}return[]}getFlippedPieces(e,t){const i=[];for(const[s,a]of K){const n=this.checkDirection(e,t,s,a);i.push(...n)}return i}calculateMoveMobility(e,t){if(!this.gameState)return{player:0,opponent:0};const i=[...this.gameState.board],s=this.getFlippedPieces(e,t);i[e]=t;for(const r of s)i[r]=t;const a=t===y?E:y;let n=0;for(let r=0;r<64;r++)i[r]===C&&this.isValidMoveOnBoard(r,a,i)&&n++;let o=0;for(let r=0;r<64;r++)i[r]===C&&this.isValidMoveOnBoard(r,t,i)&&o++;return{player:o,opponent:n}}isValidMoveOnBoard(e,t,i){if(i[e]!==C)return!1;for(const[s,a]of K)if(this.checkDirectionOnBoard(e,t,s||0,a||0,i).length>0)return!0;return!1}checkDirectionOnBoard(e,t,i,s,a){const n=[],o=Math.floor(e/8),r=e%8,l=t===y?E:y;let c=o+s,d=r+i;for(;c>=0&&c<8&&d>=0&&d<8;){const u=c*8+d;if(a[u]===C)return[];if(a[u]===l)n.push(u);else return n.length>0?n:[];c+=s,d+=i}return[]}updateScores(){if(!this.gameState)return;const e=this.gameState.blackScore,t=this.gameState.whiteScore;let i=0,s=0;for(const a of this.gameState.board)a===y?i++:a===E&&s++;this.gameState.blackScore=i,this.gameState.whiteScore=s,e!==i&&this.animateSharedHealthChange("black",e,i),t!==s&&this.animateSharedHealthChange("white",t,s)}checkGameStatus(){if(!this.gameState)return!1;if(this.gameState.validMoves.size===0){if(this.gameState.currentPlayer=this.gameState.currentPlayer===y?E:y,this.updateValidMoves(),this.gameState.validMoves.size===0)return this.gameOver(),!0;if(this.getSettings().autoPass){const t=this.gameState.currentPlayer===y?"Black":"White";this.showMessage(`No valid moves - passing to ${t}`)}}return!1}gameOver(){if(!this.gameState)return;this.gameState.isGameOver=!0;let e,t;this.gameState.blackScore>this.gameState.whiteScore?(e=m("game.blackWins"),t="game-over-winner--black"):this.gameState.whiteScore>this.gameState.blackScore?(e=m("game.whiteWins"),t="game-over-winner--white"):(e=m("game.tie"),t="game-over-winner--tie");const i=document.getElementById("game-over-modal");i&&(i.classList.remove("is-hidden"),i.innerHTML=`
        <h2 class="game-over-title">🏆 ${m("game.gameOverTitle")}</h2>
        <div class="final-scores">
          <p class="game-over-winner ${t}">
            ${e}
          </p>
          <p>⚫ ${m("game.black")}: ${this.gameState.blackScore}</p>
          <p>⚪ ${m("game.white")}: ${this.gameState.whiteScore}</p>
          <p class="game-over-summary">
            ${m("game.totalMoves")}: ${this.gameState.moveHistory.length}
          </p>
        </div>
        <div class="modal-buttons">
          <button class="menu-button" id="play-again">${m("game.playAgain")}</button>
          <button class="menu-button" id="main-menu">${m("game.mainMenu")}</button>
        </div>
      `,document.getElementById("play-again")?.addEventListener("click",()=>{i.classList.add("is-hidden"),this.startNewGame(this.gameState.gameMode,this.gameState.aiDifficulty)}),document.getElementById("main-menu")?.addEventListener("click",()=>{i.classList.add("is-hidden"),this.showMenu()}))}animateSharedHealthChange(e,t,i){const s=i-t,a=document.querySelector(".shared-health-bar");Math.abs(s)>=5&&a&&(a.classList.add("shake"),setTimeout(()=>a.classList.remove("shake"),300)),s!==0&&this.showSharedDamageNumber(e,s)}showSharedDamageNumber(e,t){const i=document.getElementById("damage-numbers"),s=document.querySelector(`.player-section.${e==="black"?"left":"right"}`);if(!i||!s)return;const a=document.createElement("div");a.className=`damage-number ${t>0?"positive":"negative"}`,a.textContent=t>0?`+${t}`:t.toString();const n=s.getBoundingClientRect(),o=i.getBoundingClientRect();a.style.left=`${n.left-o.left+n.width/2}px`,a.style.top=`${n.top-o.top-10}px`,a.style.transform="translateX(-50%)",i.appendChild(a),setTimeout(()=>{a.parentNode&&a.parentNode.removeChild(a)},1e3)}showDamageNumber(e,t){this.showSharedDamageNumber(e,t)}updateSharedHealthBar(){if(!this.gameState)return;const e=document.getElementById("black-fill"),t=document.getElementById("white-fill"),i=document.getElementById("black-count"),s=document.getElementById("white-count"),a=document.getElementById("current-turn-shared");if(!e||!t||!i||!s||!a)return;const n=this.gameState.blackScore+this.gameState.whiteScore,o=n>0?this.gameState.blackScore/n*100:50,r=n>0?this.gameState.whiteScore/n*100:50;e.style.width=`${o}%`,t.style.width=`${r}%`,i.textContent=this.gameState.blackScore.toString(),s.textContent=this.gameState.whiteScore.toString();const l=this.gameState.currentPlayer===y?m("game.black"):m("game.white");a.innerHTML=`<span>${l}</span>`;const c=e,d=t;o<15?c.classList.add("critical"):c.classList.remove("critical"),r<15?d.classList.add("critical"):d.classList.remove("critical"),o>75?(c.classList.add("dominant"),d.classList.remove("dominant")):r>75?(d.classList.add("dominant"),c.classList.remove("dominant")):(c.classList.remove("dominant"),d.classList.remove("dominant")),this.updateVSDividerPosition(o),this.triggerSpecialHealthEffects(o,r)}updateVSDividerPosition(e){const t=document.getElementById("vs-divider");t&&(t.style.left=`${e}%`)}triggerSpecialHealthEffects(e,t){const i=document.querySelector(".shared-health-bar"),s=document.getElementById("black-fill"),a=document.getElementById("white-fill");if(!i||!s||!a)return;i.classList.remove("balanced","dramatic-shift"),s.classList.remove("pulsing"),a.classList.remove("pulsing"),e>=45&&e<=55&&i.classList.add("balanced"),Math.abs(e-50)>35&&(i.classList.add("dramatic-shift"),e>65?s.classList.add("pulsing"):t>65&&a.classList.add("pulsing"),setTimeout(()=>{i.classList.remove("dramatic-shift")},1500))}updateDisplay(){if(!this.gameState)return;this.updateSharedHealthBar();const e=document.getElementById("black-score"),t=document.getElementById("white-score"),i=document.getElementById("current-turn");if(e&&(e.textContent=`⚫ ${m("game.black")}: ${this.gameState.blackScore}`),t&&(t.textContent=`⚪ ${m("game.white")}: ${this.gameState.whiteScore}`),i){const a=this.gameState.currentPlayer===y?m("game.black"):m("game.white"),n=this.gameState.currentPlayer===y?"player-label player-label--black":"player-label player-label--white";i.innerHTML=`${m("game.current")}: <span class="${n}">${a}</span>`}const s=document.getElementById("turn-indicator");if(s){const a=this.gameState.currentPlayer===y?m("game.black"):m("game.white"),n=this.gameState.currentPlayer===y?"player-label player-label--black":"player-label player-label--white";s.innerHTML=`${m("game.currentTurn")} <span class="${n}">${a}</span>`}this.renderBoard()}showMessage(e){const t=document.getElementById("ai-status");t&&(t.textContent=e,setTimeout(()=>{t.textContent=""},2e3))}triggerScreenShake(e){if(!this.container||!this.getSettings().animations)return;let i=0,s=0;switch(e){case"SSS":i=8,s=600;break;case"SS":i=7,s=550;break;case"S":i=12,s=800;break;case"A":i=6,s=500;break;case"B":i=3,s=300;break;case"C":return}const a=this.container.querySelector(".super-reversi-app");a&&(a.style.setProperty("--shake-intensity",`${i}px`),a.style.animation=`shake ${s}ms ease-in-out`,setTimeout(()=>{a.style.animation="",a.style.removeProperty("--shake-intensity")},s))}isMobileDevice(){const e=navigator.userAgent.toLowerCase(),i=["mobile","android","iphone","ipad","ipod","blackberry","windows phone"].some(n=>e.includes(n)),s=window.innerWidth<768,a="ontouchstart"in window||navigator.maxTouchPoints>0;return i||s&&a}getDeviceOptimizedAIConfig(e){return this.isMobileDevice()&&{[f.MINIMAX_HARD]:{maxDepth:6,timeLimit:3e3,disableEndgameSolver:!1},[f.ADVANCED]:{maxDepth:6,timeLimit:4e3,disableEndgameSolver:!1},[f.MASTER]:{maxDepth:6,timeLimit:5e3,disableEndgameSolver:!0}}[e]||null}async makeAIMove(){if(!this.gameState||this.gameState.validMoves.size===0||this.aiThinking||this.isProcessingMove)return;this.aiThinking=!0;const e=document.getElementById("ai-status");if(e){const s=this.isMobileDevice(),a=[f.ADVANCED,f.MASTER].includes(this.gameState.aiDifficulty);let n="AI 正在思考...",o="";s&&a&&(n="AI 正在深度思考...",o='<div class="ai-additional-info ai-additional-info--muted">手機版建議使用較低難度以獲得更佳體驗</div>'),e.innerHTML=`
        <div class="ai-thinking-animation">
          <div class="thinking-dots">
            <div class="thinking-dot"></div>
            <div class="thinking-dot"></div>
            <div class="thinking-dot"></div>
          </div>
          <span>${n}</span>
          ${o}
        </div>
      `}let t=null,i=null;try{const s=this.convertToCoreGameState(this.gameState),a=Date.now(),n=this.getAITimeLimit(this.gameState.aiDifficulty),o={gameState:s,player:this.gameState.currentPlayer===y?g.BLACK:g.WHITE,difficulty:this.gameState.aiDifficulty,timeLimit:n,priority:5},r=this.isMobileDevice(),l=r?3e3:8e3,c=r?15e3:3e4;t=setTimeout(()=>{this.aiThinking&&e&&(e.innerHTML=`
            <div class="ai-thinking-animation">
              <div class="thinking-dots">
                <div class="thinking-dot"></div>
                <div class="thinking-dot"></div>
                <div class="thinking-dot"></div>
              </div>
              <span>AI 正在深度分析...</span>
              <div class="ai-additional-info ai-additional-info--warning">
                ⚡ ${r?"手機版處理較慢，請稍候":"複雜局面需要更多時間"}
              </div>
            </div>
          `)},l),i=setTimeout(()=>{if(this.aiThinking&&!this.isProcessingMove){t&&clearTimeout(t),B.isThinking()&&B.stopThinking(),this.aiThinking=!1,this.isProcessingMove=!0,e&&(e.innerHTML=`
              <div class="ai-error-display">
                <div class="ai-error-title">
                  ⚠️ AI 超時保護啟動
                </div>
                <div class="ai-error-suggestion">
                  ${r?"自動降級為隨機移動":"執行備用隨機策略"}
                </div>
              </div>
            `,setTimeout(()=>{e&&(e.textContent="")},3e3));const T=Array.from(this.gameState.validMoves);if(T.length>0){const F=T[Math.floor(Math.random()*T.length)];setTimeout(()=>{this.makeMove(F),this.isProcessingMove=!1},100)}else this.isProcessingMove=!1}},c);const d=await B.requestMove(o);t&&clearTimeout(t),i&&clearTimeout(i);const u=Date.now()-a,p=(d.thinkingTime/1e3).toFixed(1),v=d.depth||0,S=(d.confidence*100).toFixed(0),w=d.nodesEvaluated||0,b=r&&u>5e3,A=!r&&u>15e3;if(e){let T="";b?T='<div class="ai-additional-info ai-additional-info--performance">💡 考慮使用較低AI難度以加快遊戲速度</div>':A&&(T='<div class="ai-additional-info ai-additional-info--performance">💡 複雜局面需要更多計算時間</div>'),e.innerHTML=`
          <div class="ai-info-display">
            <div class="ai-info-title">
              🤖 AI 計算完成
            </div>
            <div class="ai-info">
              <div>⏱️ ${p}s</div>
              <div>🔍 深度 ${v}</div>
              <div>🎯 ${S}%</div>
              ${w>0?`<div>🧮 ${w.toLocaleString()} 節點</div>`:""}
            </div>
            ${T}
          </div>
        `}setTimeout(()=>{this.isProcessingMove||(this.makeMove(d.position),e&&(e.textContent=""),this.aiThinking=!1)},300)}catch(s){t&&clearTimeout(t),i&&clearTimeout(i);const a=this.isMobileDevice();if(e){const o=s instanceof Error?s.message:String(s),l=o.includes("timeout")||o.includes("時間")?"思考超時":"計算失敗",c=a?"建議降低AI難度或重新開始遊戲":"請重試或降低AI難度";e.innerHTML=`
          <div class="ai-error-display">
            <div class="ai-error-title">
              ⚠️ AI ${l}
            </div>
            <div class="ai-error-suggestion">
              ${c}
            </div>
          </div>
        `,setTimeout(()=>{e&&(e.textContent="")},3e3)}const n=Array.from(this.gameState.validMoves);if(n.length>0){const o=n[Math.floor(Math.random()*n.length)];this.makeMove(o)}this.aiThinking=!1}}convertToCoreGameState(e){const t=new Uint8Array(64);for(let s=0;s<64;s++)t[s]=e.board[s]===y?g.BLACK:e.board[s]===E?g.WHITE:g.EMPTY;const i=new Map;for(const s of e.validMoves){const a=this.getFlippedPieces(s,e.currentPlayer);i.set(s,a)}return{board:t,currentPlayer:e.currentPlayer===y?g.BLACK:g.WHITE,validMoves:i,scores:{black:e.blackScore,white:e.whiteScore},gameOver:e.isGameOver,consecutivePasses:e.consecutivePasses||0}}getAITimeLimit(e){const t=this.getDeviceOptimizedAIConfig(e);return t&&t.timeLimit?t.timeLimit:{[f.RANDOM]:200,[f.GREEDY]:1e3,[f.MINIMAX_EASY]:2e3,[f.MINIMAX]:3e3,[f.MINIMAX_HARD]:4e3,[f.ADVANCED]:5e3,[f.MASTER]:1e4,[f.BLITZ]:1500,[f.CUSTOM]:5e3}[e]||3e3}isEdgePosition(e){const t=Math.floor(e/8),i=e%8;return(t===0||t===7||i===0||i===7)&&!(e===0||e===7||e===56||e===63)}isChainMove(e){return!this.gameState||this.gameState.moveHistory.length===0?!1:this.gameState.moveHistory[this.gameState.moveHistory.length-1]?.flipped?.length>=3&&e.length>=3}isComebackMove(){return this.gameState?(this.gameState.currentPlayer===y?this.gameState.blackScore-this.gameState.whiteScore:this.gameState.whiteScore-this.gameState.blackScore)<=-5:!1}isDominationMove(){return this.gameState?(this.gameState.currentPlayer===y?this.gameState.blackScore-this.gameState.whiteScore:this.gameState.whiteScore-this.gameState.blackScore)>=10:!1}showSimpleConfirm(e,t){return new Promise(i=>{const s=document.getElementById("simple-modal"),a=document.getElementById("modal-title"),n=document.getElementById("modal-message"),o=document.getElementById("modal-confirm"),r=document.getElementById("modal-cancel");if(!s||!a||!n||!o||!r){i(confirm(e));return}a.textContent=t||m("modal.confirm.title"),n.textContent=e,o.textContent=m("modal.confirm"),r.textContent=m("modal.cancel"),s.classList.remove("is-hidden");const l=()=>{s.classList.add("is-hidden"),o.removeEventListener("click",l),r.removeEventListener("click",c),i(!0)},c=()=>{s.classList.add("is-hidden"),o.removeEventListener("click",l),r.removeEventListener("click",c),i(!1)};o.addEventListener("click",l),r.addEventListener("click",c),s.addEventListener("click",d=>{d.target===s&&c()})})}}document.addEventListener("DOMContentLoaded",async()=>{const h=document.getElementById("game-container");if(h)try{const e=new rt;await e.initialize(h),window.superReversiGame=e}catch(e){h.innerHTML=`
        <div class="error-screen">
          <h2>Error Loading Game</h2>
          <p>${e}</p>
        </div>
      `}});export{f as A};
//# sourceMappingURL=index-Czm5j73j.js.map
